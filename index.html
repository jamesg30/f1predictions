<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Predictions</title>
    <link rel="icon" href="/media/f1_predictions_logo.ico" type="image/x-icon">
    <!-- Bootstrap CSS (Local) -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/style.css">
    <style> 
        /* Container for the image and overlay */
        .full-width-image-container {
            position: relative; /* Allows for absolute positioning of overlay */
            width: 100%;        /* Full width of the container */
            height: 180px;      /* Fixed height for the image */
            overflow: hidden;   /* Prevents anything from overflowing */
        }

        /* Image styling */
        .full-width-image {
            width: 100%;        /* Full width of the container */
            height: 100%;       /* Full height of the container */
            object-fit: cover;  /* Ensures the image scales proportionally and fills the container */
        }

        /* Transparent overlay styling */
        .overlay {
            position: absolute;   /* Positioned relative to the parent container */
            top: 0;               /* Start at the top of the container */
            left: 0;              /* Start at the left of the container */
            width: 100%;          /* Full width of the container */
            height: 100%;         /* Full height of the container (200px) */
            background-color: rgba(0, 0, 0, 0.4); /* Transparent black overlay */
        }
        
        .centered-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;               /* White text for contrast */
    font-size: clamp(1.5rem, 5vw, 2.5rem); /* Dynamic size for responsiveness */
    font-weight: bold;          /* Bold for emphasis */
    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7); /* Optional shadow for readability */
    text-align: center;         /* Ensure text is centered in smaller containers */
    z-index: 2;                 /* Above the overlay */
    white-space: nowrap;        /* Prevent wrapping */
}

    </style>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Initialize Supabase globally
        const supabaseUrl = 'https://mbyhlefxnjjzmiwsvnaa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ieWhsZWZ4bmpqem1pd3N2bmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzODQwOTgsImV4cCI6MjA0OTk2MDA5OH0.4gcUcOfhyTspbcDn6gPxBKFSTu3zUbkBdNEhMq9MdnY';
        var supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>
</head>
<body>
    <header class="bg-light text-black py-2.5 d-flex align-items-center justify-content-between sticky-top">
        <!-- Left Section: Logo and Heading -->
        <div class="d-flex align-items-center">
            <a href="/" class="ms-2.5 me-2 d-flex align-items-center">
                <img src="/media/f1_predictions_logo.png" alt="Logo" style="height: 45px;">
            </a>
            <a href="/" class="text-decoration-none text-black">
                <h5 class="mb-0 fw-bold">F1 Predictions</h5>
            </a>
        </div>
        
        <!-- Right Section: Hamburger Menu -->
        <div class="dropdown me-3">
            <button class="btn btn-light dropdown-toggle" type="button" id="hamburgerMenu" data-bs-toggle="dropdown" aria-expanded="false">
                Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="hamburgerMenu">
                <li><a class="dropdown-item" href="/">Home</a></li>
                <li><hr class="dropdown-divider"></li> <!-- Spacer -->
                <li><a class="dropdown-item" href="/form">Form</a></li>
                <li><a class="dropdown-item" href="/teams">Teams</a></li>
                <li><a class="dropdown-item" href="/results">Results</a></li>
                <li><a class="dropdown-item" href="/register">Register</a></li>
                <li><a class="dropdown-item" href="/feedback">Feedback</a></li>
                <li><a class="dropdown-item" href="/info">Info</a></li>
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><hr class="dropdown-divider"></li> <!-- Spacer -->
                <li><a class="dropdown-item" href="/admin">Admin</a></li>
            </ul>
        </div>
    </header>    

    <!-- Full-Width Image Section with Centered Text -->
<section class="full-width-image-container">
    <img src="/media/ferrari_background.png" alt="Full Width Image" class="full-width-image">
    <div class="overlay"></div> <!-- Transparent black layer -->

    <!-- Centered Text -->
    <h2 class="centered-text">F1 Predictions Form</h2>
</section>

    <main class="container my-5">
        <div class="row g-4">
            <!-- Left Column: Latest Form -->
            <div class="col-md-6">
                <div class="text-center">
                    <h5 class="mb-3">Latest Form:</h5>
                    <a id="latest-form-link">
                        <button id="latest-form-button" type="button" class="btn btn-dark" disabled>Loading...</button>
                    </a>
                </div>
            </div>
    
            <!-- Right Column: Quick Links -->
        <div class="col-md-6">
            <div class="text-center">
                <h5 class="mb-3">Quick Links:</h5>
                <!-- Changed to flex-row for horizontal alignment -->
                <div class="d-flex flex-row justify-content-center gap-3">
                    <a href="/results">
                        <button type="button" class="btn btn-dark">Results</button>
                    </a>
                    <a href="/teams">
                        <button type="button" class="btn btn-dark">Teams</button>
                    </a>
                </div>
            </div>
        </div>

        </div>
    
        <!-- Next Race Section -->
        <!-- Next Race Section -->
<div class="text-center mt-5">
    <h5>Next Race:</h5>
    <div id="next-race-info" class="mt-3">
        <p>Loading next race...</p>
    </div>
    <div id="countdown-timer" class="mt-2 text-danger" style="font-size: 1.2rem; display: none;">
        <strong>Time left:</strong> <span id="countdown"></span>
    </div>
</div>

<div> <!-- Scored Results Placeholder -->
    <div class="container my-3 d-flex justify-content-left">
        <h4 class="mb-3">Latest Results</h4>
    </div>
    <div class="container my-4">
        <h5 id="raceTitle" class="mb-3"></h5>
        
        <table id="resultsTable">
            <tbody>
                <td style="vertical-align: center;">
                    <p>
                        <img src="/media/awards/medal_first.png" style="float:left; width: 15px; height: 30px; image-rendering: pixelated;">
                        <span id="firstPlace"></span>
                    </p>
                </td>
                <td style="vertical-align: center;">
                    <p>
                        <img src="/media/awards/medal_second.png" style="float:left; width: 15px; height: 30px; image-rendering: pixelated;">
                        <span id="secondPlace"></span>
                    </p>
                </td>
                <td style="vertical-align: center;">
                    <p>
                        <img src="/media/awards/medal_third.png" style="float:left; width: 15px; height: 30px; image-rendering: pixelated;">
                        <span id="thirdPlace"></span>
                    </p>
                </td>
            </tbody>
        </table>
    
        <!-- Scrollable container -->
        <div class="table-responsive" style="overflow-x: auto; max-width: 100%; white-space: nowrap;">
            <table id="mainResultsTable" class="table table-sm table-bordered">
                <thead id="tableHeader">
                    <!-- Header row will be inserted here -->
                </thead>
                <tbody id="tableBody">
                    <!-- Data rows will be inserted here -->
                </tbody>
            </table>
        </div>
        <div class="form-check form-switch">
            <label class="form-check-label" for="toggleScores">Show Detailed Scoring</label>
            <input class="form-check-input" type="checkbox" id="toggleScores">
        </div>
        <div id="lowestScores" class="mt-3">
            <!-- Lowest scores will be displayed here -->
        </div>
    </div>
</div>
        

        <div class="row g-4">
            <!-- Left Column: Latest Form -->
            <div class="col-md-6">
                <h5>Player Standings</h5>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1 (=)</td>
                            <td>James</td>
                            <td>58</td>
                        </tr>
                        <tr>
                            <td>2 (+1)</td>
                            <td>Ethan</td>
                            <td>57.5</td>
                        </tr>
                        <tr>
                            <td>3 (-1)</td>
                            <td>Josh 2004</td>
                            <td>52</td>
                        </tr>
                    </tbody>
                </table>
            </div>
    
            <!-- Right Column: Quick Links -->
        <div class="col-md-6">
            <h5>Team Standings</h5>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Team</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1 (+1)</td>
                            <td>Comeng</td>
                            <td>123</td>
                        </tr>
                        <tr>
                            <td>2 (-1)</td>
                            <td>Scuderia Latifi</td>
                            <td>117</td>
                        </tr>
                        <tr>
                            <td>3 (=)</td>
                            <td>Freedom Racing Inc</td>
                            <td>112</td>
                        </tr>
                    </tbody>
                </table>
        </div>
        <div class="container my-5">
            <h4 class="mb-3"><img src="/media/awards/trophy.png" style="float:left; width: 32px; height: 38px; image-rendering: pixelated;">Past Champions</h4>
            <p>
                2024 - James<br>
                2023 - Ethan<br>
                2022 - Ethan
            </p>
        </div>
    </main>
 
    <footer class="bg-light text-black text-center py-1">
        <p>&copy; 2024 F1 Predictions Form</p>
    </footer>

    <!-- Bootstrap JS Bundle (Local) -->
    <script src="/js/bootstrap.bundle.min.js"></script>

    <script>
        // Fetch the race details from form_details and calendar tables
        async function fetchRaceDetails() {
            try {
                // Fetch the race number from form_details
                const { data: formDetails, error: formDetailsError } = await supabase
                    .from('form_details')
                    .select('race_number')
                    .eq('id', 1)
                    .single();
    
                if (formDetailsError) {
                    console.error('Error fetching form details:', formDetailsError);
                    return null;
                }
    
                const raceNumber = formDetails.race_number;
    
                // Fetch the race details from the calendar table
                const { data: raceDetails, error: raceDetailsError } = await supabase
                    .from('calendar')
                    .select('*')
                    .eq('race_number', raceNumber)
                    .single();
    
                if (raceDetailsError) {
                    console.error('Error fetching race details:', raceDetailsError);
                    return null;
                }
    
                return raceDetails;
            } catch (error) {
                console.error('Error fetching race details:', error);
                return null;
            }
        }
    
        // Update the latest form button with the current race name
        async function updateLatestFormButton(raceDetails) {
            if (raceDetails) {
                document.getElementById("latest-form-button").textContent = `${raceDetails.name} GP Form`;
            } else {
                document.getElementById("latest-form-button").textContent = "Error loading form";
            }
        }
    
        // Update the next race info and initialize the countdown
        async function updateNextRaceInfo(raceDetails) {
            if (!raceDetails) {
                document.getElementById("next-race-info").innerHTML = "<p>Error loading next race.</p>";
                return;
            }
    
            const raceDate = new Date(raceDetails.date);
    
            if (isNaN(raceDate)) {
                console.error("Invalid date format for next race:", raceDetails.date);
                document.getElementById("next-race-info").innerHTML = "<p>Invalid race date.</p>";
                return;
            }
    
            const flagUrl = `/media/flags/${raceDetails.country.toLowerCase()}.png`; // Assuming flags are stored here
    
            document.getElementById("next-race-info").innerHTML = `
                <img src="${flagUrl}" alt="${raceDetails.country} Flag" style="width: 64px; height: 36px; image-rendering: pixelated;">
                <h6 class="mt-2">${raceDetails.name} GP</h6>
                <div id="countdown-timer" class="mt-2" style="font-size: 1.1rem;">
                    <strong>Time left:</strong> <span id="countdown"></span>
                </div>
            `;
    
            // Start the countdown timer
            startCountdown(raceDate);
        }
    
        // Start the countdown timer
        function startCountdown(raceDate) {
            const countdownElement = document.getElementById("countdown");
    
            function updateCountdown() {
                const now = new Date();
                const timeLeft = raceDate - now;
    
                if (timeLeft <= 0) {
                    // Countdown has ended
                    countdownElement.textContent = "Race has started!";
                    clearInterval(timer);
                    countdownElement.style.color = "green"; // Change color to indicate race started
                    return;
                }
    
                // Calculate days, hours, minutes, and seconds
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    
                // Display countdown
                countdownElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }
    
            // Update every second
            updateCountdown(); // Initial update
            const timer = setInterval(updateCountdown, 1000);
        }
        
        // Fetch the form status from form_details table
async function fetchFormStatus() {
    try {
        const { data: formDetails, error: formDetailsError } = await supabase
            .from('form_details')
            .select('form_enabled')
            .eq('id', 1)
            .single();

        if (formDetailsError) {
            console.error('Error fetching form status:', formDetailsError);
            return false;
        }

        return formDetails.form_enabled;
    } catch (error) {
        console.error('Error fetching form status:', error);
        return false;
    }
}

// Update the latest form button based on form status
async function updateFormButtonStatus() {
    const formEnabled = await fetchFormStatus();
    const formButton = document.getElementById('latest-form-button');

    if (formEnabled) {
        formButton.disabled = false;
    } else {
        formButton.disabled = true;
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    // Fetch race details
    const raceDetails = await fetchRaceDetails();

    // Update the latest form button with the current race name
    await updateLatestFormButton(raceDetails);

    // Update the next race info and initialize the countdown
    await updateNextRaceInfo(raceDetails);

    // Update the form button status based on form_enabled
    await updateFormButtonStatus();

    // Add event listener to the form button
    const formButton = document.getElementById('latest-form-button');
    const formLink = document.getElementById('latest-form-link');

    formButton.addEventListener('click', (event) => {
        if (formButton.disabled) {
            event.preventDefault();
        } else {
            formLink.href = '/form';
        }
    });
});

// Results Table Formatting
document.addEventListener("DOMContentLoaded", async () => {
    // Fetch initial data
    const { data: formDetails, error: formDetailsError } = await supabase
        .from('form_details')
        .select('*')
        .eq('id', 1)
        .single();

    if (formDetailsError) {
        console.error('Error fetching form details:', formDetailsError.message);
        return;
    }

    const { results_display_race_number, results_display_type, current_year } = formDetails;

    if (results_display_type === 'Unscored Predictions') {
        return; // End function if unscored predictions
    }

    // Fetch race details
    const { data: raceDetails, error: raceDetailsError } = await supabase
        .from('calendar')
        .select('*')
        .eq('race_number', results_display_race_number)
        .single();

    if (raceDetailsError) {
        console.error('Error fetching race details:', raceDetailsError.message);
        return;
    }

    const raceName = `${raceDetails.name} GP`;

    // Fetch form responses
    const { data: formResponses, error: formResponsesError } = await supabase
        .from(`form_responses_${current_year}`)
        .select('*')
        .eq('race_number', results_display_race_number);
    if (formResponsesError) {
        console.error('Error fetching form responses:', formResponsesError.message);
        return;
    }

    // Fetch drivers and constructors
    const { data: drivers, error: driversError } = await supabase
        .from('drivers')
        .select('*');
    if (driversError) {
        console.error('Error fetching drivers:', driversError.message);
        return;
    }

    const { data: constructors, error: constructorsError } = await supabase
        .from('constructors')
        .select('*');
    if (constructorsError) {
        console.error('Error fetching constructors:', constructorsError.message);
        return;
    }

    // Set race title
    document.getElementById('raceTitle').textContent = `${raceName} ${current_year} - Results`;

    // Process form responses
    const questions = formResponses.find(response => response.entry_type === 'questions');
    const results = formResponses.find(response => response.entry_type === 'results');
console.log('Results object:', results); // Debugging output
    const players = formResponses.filter(response => response.entry_type === 'player');
    const lowestScores = formResponses.filter(response => response.entry_type === 'player_lowest_score');

    // Create header row
    const headerRow = document.createElement('tr');
    headerRow.classList.add('header');
    headerRow.innerHTML = '<th>Name</th>';
    players.forEach(player => {
        const th = document.createElement('th');
        th.textContent = player.player_name;
        headerRow.appendChild(th);
    });
    headerRow.innerHTML += '<th style="background-color: white; border-top: none; border-bottom: none;"></th><th>Results</th>';
    document.getElementById('tableHeader').appendChild(headerRow);

    // Create data rows
    const tableBody = document.getElementById('tableBody');
    const createRow = (id, label) => {
    console.log(`Creating row for ID: ${id}, Label: ${label}`);
    const isTotalColumn = ['subtotal_1', 'subtotal_2', 'subtotal_3', 'subtotal_4', 'grand_total'].includes(id);

    if (isTotalColumn) {
        console.log(`Checking total column: ${id}`);
        const row = document.createElement('tr');
        row.innerHTML = `<td>${label}</td>`;
        players.forEach(player => {
            console.log(`Processing player: ${player.player_name}, Player ID: ${player.player_id}`);
            const td = document.createElement('td');
            td.textContent = player[id];
            console.log(`Player ${player.player_name} score for ${id}: ${player[id]}`);
            td.className = `${id}_score`;
            td.dataset.playerId = player.player_id;
            row.appendChild(td);
        });
        row.innerHTML += `<td style="background-color: white;"></td><td></td>`;
        console.log(`Appending row to table body: ${row.innerHTML}`);
        tableBody.appendChild(row);
    } else {
        console.log(`Checking form_id column: form_id_${id}`);
        if (results[`form_id_${id}`] !== null) {
            console.log(`Results for form_id_${id}: ${results[`form_id_${id}`]}`);
            const row = document.createElement('tr');
            row.innerHTML = `<td>${label}</td>`;
            players.forEach(player => {
                console.log(`Processing player: ${player.player_name}, Player ID: ${player.player_id}`);
                const td = document.createElement('td');
                td.textContent = player[`form_id_${id}`];
                console.log(`Player ${player.player_name} score for form_id_${id}: ${player[`form_id_${id}`]}`);
                td.className = `form_id_${id}_score`;
                td.dataset.playerId = player.player_id;
                row.appendChild(td);
            });
            row.innerHTML += `<td style="background-color: white;"></td><td>${results[`form_id_${id}`]}</td>`;
            console.log(`Appending row to table body: ${row.innerHTML}`);
            tableBody.appendChild(row);
        } else {
            console.log(`No results found for form_id_${id}`);
        }
    }
};

// Add question rows
for (let i = 2; i <= 7; i++) {
    createRow(i, questions[`form_id_${i}`]);
}

createRow('subtotal_2', 'Subtotal');
tableBody.innerHTML += '<tr class="spacer-row"><td colspan="100%" style="background-color: white;"></td></tr>'; // Divider

for (let i = 8; i <= 27; i++) {
    createRow(i, questions[`form_id_${i}`]);
}

createRow('subtotal_3', 'Subtotal');
tableBody.innerHTML += '<tr class="spacer-row"><td colspan="100%" style="background-color: white;"></td></tr>'; // Divider

createRow(28, questions[`form_id_28`]);
tableBody.innerHTML += '<tr class="spacer-row"><td colspan="100%" style="background-color: white;"></td></tr>'; // Divider
createRow('grand_total', 'Grand Total');

    // Apply formatting
    const applyFormatting = (cell, value) => {
        if (/^[A-Z]{3}$/.test(value)) {
            const driver = drivers.find(driver => driver.abbreviation === value);
            if (driver) {
                const constructor = constructors.find(constructor => constructor.id === driver.constructor_id);
                if (constructor) {
                    cell.style.backgroundColor = constructor.background_colour;
                    cell.style.color = constructor.text_colour;
                }
            }
        } else if (/^\d+$/.test(value)) {
            // Leave unformatted
        } else if (value === 'Yes') {
            cell.style.color = 'green';
            cell.style.backgroundColor = 'white';
        } else if (value === 'No') {
            cell.style.color = 'red';
            cell.style.backgroundColor = 'white';
        } else {
            const constructor = constructors.find(constructor => constructor.name === value);
            if (constructor) {
                cell.style.backgroundColor = constructor.background_colour;
                cell.style.color = constructor.text_colour;
            }
        }
    };

    document.querySelectorAll('#mainResultsTable tbody td').forEach(cell => {
        applyFormatting(cell, cell.textContent);
    });

    // Highlight highest scores
const highlightHighest = (selector, colors) => {
    const cells = Array.from(document.querySelectorAll(selector));
    const values = cells.map(cell => {
        const value = parseFloat(cell.textContent);
        console.log(`Cell value: ${value}`); // Debugging output
        return value;
    }).filter(value => !isNaN(value));
    const sortedValues = [...new Set(values)].sort((a, b) => b - a); // Sort values in descending order and remove duplicates
    console.log(`Sorted values: ${sortedValues}`); // Debugging output

    cells.forEach(cell => {
        const cellValue = parseFloat(cell.textContent);
        const rank = sortedValues.indexOf(cellValue);
        if (rank >= 0 && rank < colors.length) {
            cell.style.backgroundColor = colors[rank];
            cell.style.color = 'black';
        }
    });
};

// Highlight closest score (lowest points) for form_id_28
const highlightClosestScore = (selector, color) => {
    const cells = Array.from(document.querySelectorAll(selector));
    const values = cells.map(cell => {
        const value = parseFloat(cell.textContent);
        console.log(`Cell value: ${value}`); // Debugging output
        return value;
    }).filter(value => !isNaN(value));
    const minValue = Math.min(...values);
    console.log(`Min value: ${minValue}`); // Debugging output

    cells.forEach(cell => {
        if (parseFloat(cell.textContent) === minValue) {
            cell.style.backgroundColor = color;
            cell.style.color = 'black';
        }
    });
};

// Highlight highest subtotals and grand total
highlightHighest('td.subtotal_2_score', ['lightyellow']); // Subtotal 2
highlightHighest('td.subtotal_3_score', ['lightyellow']); // Subtotal 3
highlightHighest('td.grand_total_score', ['gold', 'silver', '#cd7f32']); // Grand Total

// Highlight closest score for form_id_28
highlightClosestScore('td.form_id_28_score', 'lightyellow'); // Closest score (lowest points)

    // Display top scorers
    const grandTotals = players.map(player => ({
        name: player.player_name,
        total: parseFloat(player.grand_total)
    })).sort((a, b) => b.total - a.total);

    document.getElementById('firstPlace').textContent = grandTotals[0]?.name || '';
    document.getElementById('secondPlace').textContent = grandTotals[1]?.name || '';
    document.getElementById('thirdPlace').textContent = grandTotals[2]?.name || '';

    // Toggle scores
    document.getElementById('toggleScores').addEventListener('change', (event) => {
    const showScores = event.target.checked;
    document.querySelectorAll('#mainResultsTable tbody td').forEach(cell => {
        const idMatch = cell.className.match(/form_id_(\d+)_score/);
        if (idMatch) {
            const scoreId = `form_id_${idMatch[1]}_score`;
            const playerId = cell.dataset.playerId;
            const player = players.find(player => player.player_id == playerId);
            const playerScore = player ? player[scoreId] : null;
            if (playerScore !== null) {
                cell.textContent = showScores ? `${cell.textContent} (${playerScore})` : cell.textContent.split(' ')[0];
            }
        }
    });
});

    // Display players with lowest scores
    const lowestScoresDiv = document.getElementById('lowestScores');
    if (lowestScores.length > 0) {
        const lowestScoresText = lowestScores.map(player => player.player_name).join(', ');
        lowestScoresDiv.textContent = `Lowest Score: ${lowestScoresText}`;
    }
});
    </script>

</body>
</html>