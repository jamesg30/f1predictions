<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Page Details 1 -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script>
    (function() {
      const darkMode = localStorage.getItem('darkMode') === 'true';
      const cssFile = darkMode ? '/dark.css' : '/light.css';
      
      // Create a new link element
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = cssFile;
      link.id = 'themeStylesheet';

      // Append it to the head after existing styles
      document.head.appendChild(link);

      console.log(`Loaded: ${cssFile}`);
    })();
  </script>
  <!-- Page Details 2 -->
  <link rel="icon" href="/media/f1_predictions_logo.ico" type="image/x-icon">
  <title>F1 Predictions | Account</title>
  <!-- Apple Touch Icon: used when bookmarking or adding to home screen on iOS -->
  <link rel="apple-touch-icon" sizes="180x180" href="/media/f1_predictions_logo.png">

  <!-- Supabase Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Initialize Supabase globally
    const supabaseUrl = 'https://mbyhlefxnjjzmiwsvnaa.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ieWhsZWZ4bmpqem1pd3N2bmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzODQwOTgsImV4cCI6MjA0OTk2MDA5OH0.4gcUcOfhyTspbcDn6gPxBKFSTu3zUbkBdNEhMq9MdnY';
    var supabase = supabase.createClient(supabaseUrl, supabaseKey);
  </script>

  <!-- Encryption Script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <!-- script.js import -->
  <script type="module" src="/script.js"></script>

  <!-- Custom Avatar Styling -->
   <style>

.avatar-customisation-container {
  max-width: 800px;
  margin: auto;
}

/* Avatar preview: center content and add internal padding */
.avatar-preview.preview {
    width: 5rem;
    height: 5rem;
    padding: 0.5rem;
    font-size: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 4px solid #c0c0c0;
    margin: auto;
    box-sizing: border-box;
    border-radius: 50%; /* Makes the avatar circular */
  }

.current-avatar-section {
  text-align: center;
  margin-bottom: 1rem;
}

.current-avatar-section .avatar-label {
  margin-top: 0.5rem;
  font-weight: bold;
}

.icon-options-section {
  margin-bottom: 1rem;
}

.icon-options-section .section-title {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
}

.icon-group {
  margin-bottom: 1rem;
}

.icon-group h4 {
  margin-bottom: 0.5rem;
}

.icon-options {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center; /* Centers the icons in a row */
}

.icon-option {
  text-align: center;
  flex: 1 1 80px;
}

.icon-option input {
  display: none;
}

/* When the radio input is checked, add a blue border to its image or icon */
.icon-option label > input:checked + img,
.icon-option label > input:checked + .icon-image {
  border: 3px solid blue;
}

/* Icon options: Ensure images and letter-based icons are scaled, padded and centered */
.icon-option img,
  .icon-option .icon-image {
    width: 60px;
    height: 60px;
    object-fit: contain; /* Ensures aspect ratio is preserved */
    padding: 5px;
    border: 3px solid #c0c0c0;
    box-sizing: border-box;
    border-radius: 50%; /* Makes the avatar circular */
  }
  /* For letter-based radio options */
  .icon-option .icon-image {
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Montserrat', Helvetica, sans-serif;
    font-weight: bold;
  }

.icon-label {
  margin-top: 0.25rem;
  text-align: center;
  font-family: Helvetica, sans-serif; /* Custom font with fallbacks */
    font-size: 1rem; /* Adjust as needed */
    color: #333; /* Main text color */
    line-height: 1.3; /* Adjust for spacing */
}

.colour-options-section {
  margin-bottom: 1rem;
}

.colour-options-section .section-title {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
}

.colour-pickers {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
}

.colour-picker-group label {
  display: block;
  margin-bottom: 0.25rem;
}

.new-avatar-preview-section {
  text-align: center;
  margin-bottom: 1rem;
}

.new-avatar-preview-section .section-title {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
}

.action-buttons {
  display: flex;
  justify-content: space-around;
  gap: 1rem;
  margin-top: 1rem;
}

@media (max-width: 576px) {
  .colour-pickers {
    grid-template-columns: 1fr;
  }
}

/* Ensure letters in avatar previews use "Press Start 2P" */
.avatar-inner {
    font-family: 'Montserrat', Helvetica, sans-serif !important;
  }
  /* Ensure our masked (monochrome) icon displays correctly */
  .monochrome-icon {
    display: block;
    width: 100%;
    height: 100%;
  }

/* Ensure our masked (monochrome) icon displays as block */
.monochrome-icon {
    display: block;
    width: 100%;
    height: 100%;
  }

  .icon-option.restricted img {
  opacity: 0.5;
  pointer-events: none; /* Prevent clicking on the image */
}

.icon-option.restricted label {
  pointer-events: none; /* Prevent clicks on the entire label */
}

.icon-option.restricted input {
  pointer-events: none; /* Prevent clicking on the radio input */
}

   </style>
</head>
<body>
  <!-- Alert Container with high z-index so it appears on top -->
  <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x" style="z-index: 9999;"></div>
  
  <header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
      <div class="container-fluid d-flex flex-wrap flex-lg-nowrap align-items-center">
        
        <!-- Toggler (Visible on mobile only) -->
        <button
          class="navbar-toggler d-lg-none order-1"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavDropdown"
          aria-controls="navbarNavDropdown"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <!-- Custom animated burger icon replacing Bootstrapâ€™s default icon -->
          <span class="burger">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </button>
        
        <!-- Brand / Logo -->
        <!-- On mobile: centered via flex centering; on desktop: left aligned (mx-lg-0) -->
        <a class="navbar-brand mx-auto mx-lg-0 order-2 order-lg-1" href="/">
          <img src="/media/f1_predictions_logo.png" alt="Logo" width="45" height="45" class="me-2">
          <span class="fs-5 d-none d-lg-inline heading-text-11" style="margin-right: 8px">F1 Predictions</span>
        </a>
        
        <!-- Shared Account Controls -->
        <div class="d-flex align-items-center order-3 order-lg-3 ms-lg-auto account-controls">
          <!-- Avatar Dropdown (default: always rendered as grey box) -->
          <div class="dropdown" id="avatarDropdownContainer">
            <a
              href="#"
              id="userDropdown"
              class="d-flex align-items-center text-decoration-none"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <!-- Default grey avatar placeholder -->
              <div id="user-avatar" class="user-avatar" style="background-color: #ccc;"></div>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown" id="logoutMenuItem">
              <li id="loggedInUserDisplay" class="dropdown-item-text body-text" style="color: darkgrey;">
                Logged in as <br><strong></strong>
              </li>
              <li><a class="dropdown-item body-text-xsb" href="/account">Account</a></li>
              <li>
                <!-- Dark Mode Toggle without highlight -->
                <div class="dropdown-item no-highlight">
                  <div class="form-check form-switch" style="line-height: 2; vertical-align: middle;">
                    <input class="form-check-input" type="checkbox" id="darkModeToggle" style="margin-top: 0.5rem">
                    <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
                  </div>
                </div>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item body-text-xs" href="#" id="logoutBtn">Log Out</a></li>
            </ul>
          </div>
          <!-- Log In Button (default: hidden) -->
          <button
            id="loginButton"
            type="button"
            class="btn btn-outline-dark ms-2 text-nowrap d-none"
            data-bs-toggle="modal"
            data-bs-target="#loginModal"
          >
            Log In
          </button>
        </div>
        
        <!-- Navigation Links -->
        <!-- On mobile: full-width collapse; on desktop: inline between brand and account controls -->
        <div class="collapse navbar-collapse order-4 w-100 order-lg-2 w-lg-auto" id="navbarNavDropdown">
          <ul class="navbar-nav mx-auto mx-lg-0">
            <li class="nav-item">
              <a class="nav-link body-text-xs" href="/form">Form</a>
            </li>
            <li class="nav-item">
              <a class="nav-link body-text-xs" href="/teams">Teams</a>
            </li>
            <li class="nav-item">
              <a class="nav-link body-text-xs" href="/results">Results</a>
            </li>
            <li class="nav-item">
              <a class="nav-link body-text-xs" href="/register">Register</a>
            </li>
            <li class="nav-item">
              <a class="nav-link body-text-xs" href="/feedback">Feedback</a>
            </li>
            <li class="nav-item">
              <a class="nav-link body-text-xs" href="/info">Info</a>
            </li>
            <li class="nav-item">
              <a class="nav-link body-text-xs" href="/minigames">Minigames</a>
            </li>
          </ul>
        </div>
        
      </div>
    </nav>
  </header>
  
  
  
  <main class="container my-5">
    <!-- Bootstrap Tabs Navigation -->
    <ul class="nav nav-underline mb-4" id="accountTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="avatar-tab" data-bs-toggle="tab" data-bs-target="#avatarCustomisation" type="button" role="tab" aria-controls="avatarCustomisation" aria-selected="true">
          Avatar Customisation
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#passwordSection" type="button" role="tab" aria-controls="passwordSection" aria-selected="false">
          Password
        </button>
      </li>
    </ul>
  
    <!-- Tabs Content -->
    <div class="tab-content" id="accountTabContent">
      <!-- Avatar Customisation Tab -->
      <div class="tab-pane fade show active" id="avatarCustomisation" role="tabpanel" aria-labelledby="avatar-tab">
        <h2 class="heading-text-2 mt-3">Avatar Customisation</h2>
        <div class="container avatar-customisation-container">
          <!-- Current Avatar Preview -->
          <div class="current-avatar-section">
            <div id="current-avatar" class="avatar-preview preview">A</div>
            <div class="mb-3 heading-text-3" style="margin-top: 10px">Current Avatar</div>
          </div>
  
          <!-- Icon Options -->
          <div class="icon-options-section">
            <h3 class="mb-3 heading-text-3">Icon Options:</h3>
            <div class="icon-group">
              <h4 class="body-text" style="font-size: 1.2rem">Monochrome Icons:</h4>
              <div class="icon-options">
                <!-- Letter Option -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="letter" data-type="letter">
                    <div class="icon-image" style="font-size: 2rem;">A</div>
                  </label>
                  <div class="icon-label">Letter</div>
                </div>
                <!-- Helmet -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_helmet.png" data-type="monochrome">
                    <img src="/media/icons/icon_helmet.png" alt="Helmet">
                  </label>
                  <div class="icon-label">Helmet</div>
                </div>
                <!-- Star -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_star.png" data-type="monochrome">
                    <img src="/media/icons/icon_star.png" alt="Star">
                  </label>
                  <div class="icon-label">Star</div>
                </div>
                <!-- Trophy -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_trophy.png" data-type="monochrome">
                    <img src="/media/icons/icon_trophy.png" alt="Trophy">
                  </label>
                  <div class="icon-label">Trophy</div>
                </div>
                <!-- Red Bull -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_redbull.png" data-type="monochrome">
                    <img src="/media/icons/icon_redbull.png" alt="Red Bull">
                  </label>
                  <div class="icon-label">Red Bull</div>
                </div>
                <!-- Ferrari -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_ferrari.png" data-type="monochrome">
                    <img src="/media/icons/icon_ferrari.png" alt="Ferrari">
                  </label>
                  <div class="icon-label">Ferrari</div>
                </div>
                <!-- McLaren -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_mclaren.png" data-type="monochrome">
                    <img src="/media/icons/icon_mclaren.png" alt="McLaren">
                  </label>
                  <div class="icon-label">McLaren</div>
                </div>
                <!-- Mercedes -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_mercedes.png" data-type="monochrome">
                    <img src="/media/icons/icon_mercedes.png" alt="Mercedes">
                  </label>
                  <div class="icon-label">Mercedes</div>
                </div>
                <!-- Monster -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_monster.png" data-type="monochrome">
                    <img src="/media/icons/icon_monster.png" alt="Monster">
                  </label>
                  <div class="icon-label">Monster</div>
                </div>
                <!-- Fish -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_fish.png" data-type="monochrome">
                    <img src="/media/icons/icon_fish.png" alt="Fish">
                  </label>
                  <div class="icon-label">Fish</div>
                </div>
                <!-- Fish -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_butterfly.png" data-type="monochrome">
                    <img src="/media/icons/icon_butterfly.png" alt="Butterfly">
                  </label>
                  <div class="icon-label">Butterfly</div>
                </div>
                <!-- Tram -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_tram.png" data-type="monochrome">
                    <img src="/media/icons/icon_tram.png" alt="Tram">
                  </label>
                  <div class="icon-label">Tram</div>
                </div>
                <!-- Train -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_train.png" data-type="monochrome">
                    <img src="/media/icons/icon_train.png" alt="Train">
                  </label>
                  <div class="icon-label">Train</div>
                </div>
                <!-- Goat -->
                <div class="icon-option restricted">
                  <label>
                    <input id="goat_icon" type="radio" name="avatar-icon" value="icon_goat.png" data-type="monochrome">
                    <img src="/media/icons/icon_goat.png" alt="goat">
                  </label>
                  <div class="icon-label">Goat <small>(Restricted - Past Champions)</small></div>
                </div>
              </div>
            </div>
  
            <div class="icon-group">
              <h4 class="body-text" style="font-size: 1.2rem">Coloured Icons:</h4>
              <div class="icon-options">
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_tyre_soft.png" data-type="fixed">
                    <img src="/media/icons/icon_tyre_soft.png" alt="Soft">
                  </label>
                  <div class="icon-label">Soft</div>
                </div>
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_tyre_medium.png" data-type="fixed">
                    <img src="/media/icons/icon_tyre_medium.png" alt="Medium">
                  </label>
                  <div class="icon-label">Medium</div>
                </div>
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_tyre_hard.png" data-type="fixed">
                    <img src="/media/icons/icon_tyre_hard.png" alt="Hard">
                  </label>
                  <div class="icon-label">Hard</div>
                </div>
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_tyre_inter.png" data-type="fixed">
                    <img src="/media/icons/icon_tyre_inter.png" alt="Inter">
                  </label>
                  <div class="icon-label">Inter</div>
                </div>
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_tyre_wet.png" data-type="fixed">
                    <img src="/media/icons/icon_tyre_wet.png" alt="Wet">
                  </label>
                  <div class="icon-label">Wet</div>
                </div>
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_tyre_hypersoft.png" data-type="fixed">
                    <img src="/media/icons/icon_tyre_hypersoft.png" alt="Hypersoft">
                  </label>
                  <div class="icon-label">Hypersoft</div>
                </div>
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_tyre_superhard.png" data-type="fixed">
                    <img src="/media/icons/icon_tyre_superhard.png" alt="Superhard">
                  </label>
                  <div class="icon-label">Superhard</div>
                </div>
                <!-- New option: Red Bull coloured icon -->
                <div class="icon-option">
                  <label>
                    <input type="radio" name="avatar-icon" value="icon_redbullcolour" data-type="fixed">
                    <img src="/media/icons/icon_redbullcolour.png" alt="Red Bull Colour">
                  </label>
                  <div class="icon-label">Red Bull</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Colour Options -->
          <div class="colour-options-section">
            <h3 class="mb-3 heading-text-3">Colour Options:</h3>
            <div class="colour-pickers">
              <div class="colour-picker-group">
                <label for="icon-color" class="icon-label">Icon:</label>
                <input type="color" id="icon-color" class="form-control">
              </div>
              <div class="colour-picker-group">
                <label for="background-color" class="icon-label">Background:</label>
                <input type="color" id="background-color" class="form-control">
              </div>
            </div>
          </div>
          
          <!-- New Avatar Preview -->
          <div class="new-avatar-preview-section">
            <h3 class="mb-3 heading-text-3">New Avatar Preview</h3>
            <div id="new-avatar" class="avatar-preview preview">A</div>
          </div>
          
          <!-- Action Buttons -->
          <div class="action-buttons">
            <button id="reset-avatar" class="btn btn-dark">Reset to Default</button>
            <button id="save-avatar" class="btn btn-primary">Save Avatar</button>
          </div>
        </div>
      </div>
  
      <!-- Password Tab -->
      <div class="tab-pane fade" id="passwordSection" role="tabpanel" aria-labelledby="password-tab">
        <h2 class="mb-3 heading-text-2 mt-3">Password</h2>
        <h3 class="mb-3 heading-text-3">Forgot Password</h3>
        <div>
          <p>
            If you have forgotten your password, email <a href="mailto:f1predictionsform@outlook.com?subject=F1 Predictions Form Password Reset&body=Hi, I would like to request a password reset. My username is: ">f1predictionsform@outlook.com</a> with your username.
            You will receive a response with a new password, which you can change using the form below. Passwords are encrypted and as a result can only be reset.
          </p>
        </div>
        <h3 class="mb-3 heading-text-3">Change Password</h3>
        <form id="passwordResetForm">
          <!-- Autofilled Logged-In Name -->
          <div class="mb-3">
            <label for="logged-in-name" class="form-label">Name:</label>
            <input type="text" id="logged-in-name" class="form-control" disabled>
          </div>
          <!-- Existing PIN -->
          <div class="mb-3">
            <label for="current-pin" class="form-label">Current PIN:</label>
            <input type="password" id="current-pin" class="form-control" placeholder="Re-enter your current PIN" maxlength="4" pattern="^\d{4}$" required>
          </div>
          <!-- New PIN -->
          <div class="mb-3">
            <label for="new-pin" class="form-label">New PIN:</label>
            <input type="password" id="new-pin" class="form-control" placeholder="Enter new PIN" maxlength="4" pattern="^\d{4}$" required>
          </div>
          <!-- Confirm New PIN -->
          <div class="mb-3">
            <label for="confirm-new-pin" class="form-label">Confirm New PIN:</label>
            <input type="password" id="confirm-new-pin" class="form-control" placeholder="Re-enter new PIN" maxlength="4" pattern="^\d{4}$" required>
          </div>
          <!-- Update Password Button -->
          <div class="text-center">
            <button type="submit" id="passwordUpdateBtn" class="btn btn-primary">Update Password</button>
          </div>
        </form>
      </div>
    </div>
  
    <!-- LOGIN MODAL -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title heading-text-3" id="loginModalLabel">Log In</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="login-form">
          <div class="mb-3">
            <label for="login-player-name" class="form-label">Name:</label>
            <!-- Use an input with a datalist for suggestions -->
            <input list="players-list" id="login-player-name" class="form-control" required />
            <datalist id="players-list">
              <!-- Options will be populated dynamically -->
            </datalist>
          </div>
          <div class="mb-3">
            <label for="login-pin" class="form-label">PIN:</label>
            <input type="password" id="login-pin" class="form-control" maxlength="4" pattern="\d*" inputmode="numeric" required />
          </div>
          
          <div class="mb-3">
            <label for="rememberMe" class="form-check-label">
              <input type="checkbox" id="rememberMe" class="form-check-input" />
              Keep me logged in for 30 days
            </label>
          </div>
          <div class="d-grid gap-2 col-6 mx-auto">
              <button type="submit" class="btn btn-primary" disabled>Log In</button>
          </div>
          <hr>
          <div class="mb-3">
            Create an account on the <a href="/register">Register Page</a>.
         </div>
          <div class="mb-3">
            Forgot password? Visit the <a href="/account">Account Page</a>.
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Custom Alert Modal (No Header) -->
<div class="modal fade" id="customAlertModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Custom Confirm Modal -->
<div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customConfirmModalLabel">Confirm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Confirm message will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" id="customConfirmCancel" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="customConfirmOk">OK</button>
      </div>
    </div>
  </div>
</div>
  </main>
  
  
  <footer class="bg-light text-black text-center py-1 body-text-xs">
    <p>&copy; 2025 F1 Predictions Form</p>
  </footer>
  
<!-- Bootstrap JS Bundle (Local) -->
<script src="/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { fetchData, getCookie, darkenColor, getColorForLetter, renderAvatar, showCustomAlert, showCustomConfirm } from '/script.js';
  // ====================================
  // === AUTOFILL PASSWORD RESET FORM ===
  // ====================================
    // Existing function to autofill the password reset form.
    async function autofillLoggedInName() {
      const playerId = getCookie("playerId");
      const loggedInNameField = document.getElementById("logged-in-name");
      const currentPINField = document.getElementById("current-pin");
      const newPINField = document.getElementById("new-pin");
      const confirmNewPINField = document.getElementById("confirm-new-pin");
      const updateButton = document.getElementById("passwordUpdateBtn");
      
      if (!playerId) {
        loggedInNameField.value = "";
        loggedInNameField.placeholder = "Please log in to change your password.";
        loggedInNameField.disabled = true;
        currentPINField.disabled = true;
        newPINField.disabled = true;
        confirmNewPINField.disabled = true;
        updateButton.disabled = true;
        return;
      }
      
      // Logged in: fetch player's name.
      const { data: player, error } = await supabase
        .from('players')
        .select('name')
        .eq('id', playerId)
        .single();
        
      if (error || !player) {
        console.error("Error fetching player name:", error);
        return;
      }
      
      loggedInNameField.value = player.name;
      loggedInNameField.disabled = true;
      currentPINField.disabled = false;
      newPINField.disabled = false;
      confirmNewPINField.disabled = false;
      updateButton.disabled = false;
    }

  // =================================
  // === AVATAR CUSTOMISATION CODE ===
  // =================================
    // New function to initialise (or clear) the avatar customisation UI.
    async function initializeAvatarCustomization() {
      const currentAvatarEl = document.getElementById('current-avatar');
      const newAvatarEl = document.getElementById('new-avatar');
      const iconColorPicker = document.getElementById('icon-color');
      const backgroundColorPicker = document.getElementById('background-color');
      const saveButton = document.getElementById('save-avatar');
      const resetButton = document.getElementById('reset-avatar');

      // Always disable the Save button initially.
      saveButton.disabled = true;
      resetButton.disabled = false;

      const playerId = getCookie('playerId');
      if (!playerId) {
        // User logged out: clear the form and disable fields.
        currentAvatarEl.textContent = '';
        newAvatarEl.textContent = '';
        iconColorPicker.value = '#ffffff';
        backgroundColorPicker.value = '#000000';
        iconColorPicker.disabled = true;
        backgroundColorPicker.disabled = true;
        document.querySelectorAll('input[name="avatar-icon"]').forEach(radio => {
          radio.checked = false;
          radio.disabled = true;
        });
        return;
      }

      // Re-enable form fields if a user is logged in.
      iconColorPicker.disabled = false;
      backgroundColorPicker.disabled = false;
      document.querySelectorAll('input[name="avatar-icon"]').forEach(radio => {
        radio.disabled = false;
      });

      // Fetch user avatar settings from Supabase.
      const { data: user, error } = await supabase
        .from('players')
        .select('avatar_settings, name')
        .eq('id', playerId)
        .single();

      if (error) {
        console.error('Error fetching avatar settings:', error);
        return;
      }

      const letter = user.name.charAt(0).toUpperCase();
      // Update the letter radio option display.
      const letterIconEl = document.querySelector('input[name="avatar-icon"][value="letter"] + .icon-image');
      if (letterIconEl) {
        letterIconEl.textContent = letter;
        letterIconEl.style.fontFamily = "'Montserrat', Helvetica, sans-serif";
        letterIconEl.style.fontWeight = "bold";
      }

      // Use saved settings if available, or default to a letter avatar.
      let savedSettings = user.avatar_settings || {
        type: 'letter',
        icon: 'letter',
        iconColor: '#ffffff',
        backgroundColor: getColorForLetter(letter)
      };

      // Render the current avatar preview.
      renderAvatar(currentAvatarEl, savedSettings, letter);

      // Populate the UI with saved settings.
      const radio = document.querySelector(`input[name="avatar-icon"][value="${savedSettings.icon}"]`);
      if (radio) {
        radio.checked = true;
        // Disable the icon colour picker for fixed icons.
        iconColorPicker.disabled = (radio.dataset.type === 'fixed');
      }
      if (savedSettings.iconColor) iconColorPicker.value = savedSettings.iconColor;
      if (savedSettings.backgroundColor) backgroundColorPicker.value = savedSettings.backgroundColor;

      // Helper: read current settings from the UI.
      function getAvatarSettingsFromUI() {
        const selectedRadio = document.querySelector('input[name="avatar-icon"]:checked');
        let type, icon;
        if (selectedRadio) {
          icon = selectedRadio.value;
          type = selectedRadio.dataset.type;
        } else {
          type = 'letter';
          icon = 'letter';
        }
        return {
          type,
          icon,
          iconColor: (type === 'fixed') ? null : iconColorPicker.value,
          backgroundColor: backgroundColorPicker.value
        };
      }

      // Helper: check if the settings have changed.
      function checkForAvatarChanges() {
        const currentSettings = getAvatarSettingsFromUI();
        saveButton.disabled = (JSON.stringify(currentSettings) === JSON.stringify(savedSettings));
      }

      // Helper: update the new avatar preview.
      function updateNewAvatarPreview() {
        const settings = getAvatarSettingsFromUI();
        renderAvatar(newAvatarEl, settings, letter);
      }

      // Listen for changes on the radio options.
      document.querySelectorAll('input[name="avatar-icon"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const selected = document.querySelector('input[name="avatar-icon"]:checked');
          iconColorPicker.disabled = (selected.dataset.type === 'fixed');
          updateNewAvatarPreview();
          checkForAvatarChanges();
        });
      });

      // Listen for changes on the colour pickers.
      iconColorPicker.addEventListener('input', () => {
        updateNewAvatarPreview();
        checkForAvatarChanges();
      });
      backgroundColorPicker.addEventListener('input', () => {
        updateNewAvatarPreview();
        checkForAvatarChanges();
      });

      // Update preview on initialisation.
      updateNewAvatarPreview();

      // Save new avatar settings.
      saveButton.addEventListener('click', async () => {
        const newSettings = getAvatarSettingsFromUI();
        const { error } = await supabase
          .from('players')
          .update({ avatar_settings: newSettings })
          .eq('id', playerId);
        if (error) {
          console.error('Error updating avatar settings:', error);
          showCustomAlert('Failed to update avatar.');
        } else {
          showCustomAlert('Avatar updated!');
          renderAvatar(currentAvatarEl, newSettings, letter);
          savedSettings = newSettings;
          saveButton.disabled = true;
          // Also update the header avatar.
          const headerAvatar = document.getElementById('user-avatar');
          renderAvatar(headerAvatar, newSettings, letter);
        }
      });

      // Reset to default settings.
      resetButton.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm('Are you sure you want to reset to defaults?');
        if (!confirmed) {
          // User canceled the action
          return;
        }
        const { error } = await supabase
          .from('players')
          .update({ avatar_settings: null })
          .eq('id', playerId);
        if (error) {
          console.error('Error resetting avatar settings:', error);
          showCustomAlert('Failed to reset avatar.');
        } else {
          showCustomAlert('Avatar reset!');
          location.reload()
        }
      });
    }

    // Initial setup when the DOM is ready.
    document.addEventListener('DOMContentLoaded', () => {
      autofillLoggedInName();
      initializeAvatarCustomization();
    });

    // When the login state changes, update both the password reset and avatar forms.
    document.addEventListener("loginStateChanged", async (event) => {
      await autofillLoggedInName();
      await initializeAvatarCustomization();
      await updateRestrictedIcons();
    });

  // ================================
  // === PASSWORD RESET FUNCTIONS ===
  // ================================
    // Update Password Functionality for the password reset form
    document.getElementById("passwordResetForm").addEventListener("submit", async (event) => {
      event.preventDefault();

      // Get the input field values
      const currentPINField = document.getElementById("current-pin");
      const newPINField = document.getElementById("new-pin");
      const confirmNewPINField = document.getElementById("confirm-new-pin");

      const currentPIN = currentPINField.value.trim();
      const newPIN = newPINField.value.trim();
      const confirmNewPIN = confirmNewPINField.value.trim();

      // Validate that all PINs are 4 digits
      if (!/^\d{4}$/.test(currentPIN)) {
        showCustomAlert("Please enter a valid 4-digit current PIN.");
        return;
      }
      if (!/^\d{4}$/.test(newPIN)) {
        showCustomAlert("Please enter a valid 4-digit new PIN.");
        return;
      }
      if (newPIN !== confirmNewPIN) {
        showCustomAlert("New PIN and confirmation do not match.");
        return;
      }

      // Get the logged in player's ID (ensure getCookie is defined and imported)
      const playerId = getCookie("playerId");
      if (!playerId) {
        showCustomAlert("You must be logged in to update your password.");
        return;
      }

      try {
        // Fetch the player's current hashed password from Supabase
        const { data: player, error: fetchError } = await supabase
          .from("players")
          .select("password")
          .eq("id", playerId)
          .single();
          
        if (fetchError || !player) {
          console.error("Error fetching player data:", fetchError);
          showCustomAlert("Failed to fetch player data.");
          return;
        }

        // Compare the entered current PIN (hashed) with the stored hash
        const hashedCurrentPIN = CryptoJS.MD5(currentPIN).toString();
        if (hashedCurrentPIN !== player.password) {
          showCustomAlert("Current PIN is incorrect.");
          return;
        }

        // Hash the new PIN
        const hashedNewPIN = CryptoJS.MD5(newPIN).toString();

        // Update the player's password in Supabase
        const { error: updateError } = await supabase
          .from("players")
          .update({ password: hashedNewPIN })
          .eq("id", playerId);

        if (updateError) {
          console.error("Error updating password:", updateError);
          showCustomAlert("Failed to update password.");
          return;
        }

        showCustomAlert("Password updated successfully!");

        // Clear the form fields
        currentPINField.value = "";
        newPINField.value = "";
        confirmNewPINField.value = "";
      } catch (err) {
        console.error("Unexpected error:", err);
        showCustomAlert("An unexpected error occurred while updating your password.");
      }
    });

    async function updateRestrictedIcons() {
      const playerId = getCookie("playerId");
      // Locate the container element of the goat icon.
      const goatOption = document.getElementById('goat_icon').closest('.icon-option');
      
      // Check if the player is eligible.
      if (playerId == 1 || playerId == 57) {
        // Eligible: remove restricted class if it exists.
        if (goatOption.classList.contains('restricted')) {
          goatOption.classList.remove('restricted');
        }
      } else {
        // Not eligible: add restricted class if it's not already there.
        if (!goatOption.classList.contains('restricted')) {
          goatOption.classList.add('restricted');
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateRestrictedIcons();
    });
</script>
</body>
</html>