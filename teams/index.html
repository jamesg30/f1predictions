<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Page Details -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/media/f1_predictions_logo.ico" type="image/x-icon">
    <title>F1 Predictions | Teams</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/style.css">
    <!-- Supabase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Initialize Supabase globally
        const supabaseUrl = 'https://mbyhlefxnjjzmiwsvnaa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ieWhsZWZ4bmpqem1pd3N2bmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzODQwOTgsImV4cCI6MjA0OTk2MDA5OH0.4gcUcOfhyTspbcDn6gPxBKFSTu3zUbkBdNEhMq9MdnY';
        var supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>
    <script type="module" src="/script.js"></script>
</head>
<body>
    <header class="bg-light text-black py-2.5 d-flex align-items-center justify-content-between sticky-top">
        <!-- Left Section: Logo and Heading -->
        <div class="d-flex align-items-center">
            <a href="/" class="ms-2.5 me-2 d-flex align-items-center">
                <img src="/media/f1_predictions_logo.png" alt="Logo" style="height: 45px;">
            </a>
            <a href="/" class="text-decoration-none text-black">
                <h5 class="mb-0 pixel-art-heading-2">F1 Predictions</h5>
            </a>
        </div>
        
        <!-- Right Section: Hamburger Menu -->
        <div class="pixel-dropdown me-3">
            <button class="pixel-button" type="button" id="hamburgerMenu" data-bs-toggle="dropdown" aria-expanded="false">
                Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="hamburgerMenu">
                <li><a class="dropdown-item pixel-art-body-smallx" href="/">Home</a></li>
                <li><hr class="dropdown-divider"></li> <!-- Spacer -->
                <li><a class="dropdown-item pixel-art-body-smallx" href="/form">Form</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/teams">Teams</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/results">Results</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/register">Register</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/feedback">Feedback</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/info">Info</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/archive">Archive</a></li>
                <li><hr class="dropdown-divider"></li> <!-- Spacer -->
                <li><a class="dropdown-item pixel-art-body-smallx" href="/admin">Admin</a></li>
            </ul>
        </div>
    </header>    
    
    <main class="container my-5">
        <!-- Tabs Navigation -->
        <ul class="nav nav-underline mb-4" id="tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="team-standings-and-cards-tab" data-bs-toggle="tab" href="#team-standings-and-cards" role="tab" aria-controls="register-player" aria-selected="true">Team Standings and Cards</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="submit-cards-tab" data-bs-toggle="tab" href="#submit-cards" role="tab" aria-controls="register-team" aria-selected="false">Submit Cards</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="casino-tab" data-bs-toggle="tab" href="#casino" role="tab" aria-controls="register-team" aria-selected="false">Casino</a>
            </li>
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content" id="tab-content">
            <!-- Team Standings and Cards -->
            <div id="team-standings-and-cards" class="tab-pane fade show active" role="tabpanel" aria-labelledby="team-standings-and-cards-tab">
              <h2 class="mb-3 pixel-art-heading-3">Team Standings and Cards</h2>
              <!-- Loading Indicator for Player Results -->
              <div id="playerLoading" class="loading-indicator mb-3 pixel-art-heading-2" style="display: none;">
                Results loading...
                <div class="loading-bar"></div>
              </div>
              <div class="list-group">
                <!-- List items will be generated here dynamically by the JS below -->
              </div>
            </div>

            <!-- Submit Cards -->
            <div id="submit-cards" class="tab-pane fade" role="tabpanel" aria-labelledby="submit-cards-tab">
                <h2 class="mb-3 pixel-art-heading-3">Submit Cards</h2>
                <div class="mb-3">
                    <p>You are submitting cards for:</p>
                    <ul class="list-group">
                        <li id="current-race-name" class="list-group-item">Loading...</li> <!-- Dynamically loaded race name -->
                    </ul>
                </div>
                <div class="alert alert-info" role="alert">
                    <p class="mb-0">
                        Only submit this form if you want to submit a card for the current round. Otherwise, you do not need to submit anything.
                    </p>
                </div>
                <div class="mb-3">
                    <label for="team-select" class="form-label">Select Team:</label>
                    <select id="team-select" class="form-select" disabled>
                        <option value="" disabled selected>Select a team</option>
                    </select>
                </div>
                <div id="team-card-stock"></div>

                <p>Select Card:</p>
                <ul class="list-group">
                    <li class="list-group-item">
                        <input class="form-check-input me-1 card-option" type="radio" name="card" value="aero" id="card-aero" disabled>
                        <label class="form-check-label stretched-link" for="card-aero">
                            <img src="/media/cards/card_aero.png" style="float:left; width: 45px; height: 61px; image-rendering: pixelated;">
                        </label>
                    </li>
                    <li class="list-group-item">
                        <input class="form-check-input me-1 card-option" type="radio" name="card" value="double" id="card-double" disabled>
                        <label class="form-check-label stretched-link" for="card-double">
                            <img src="/media/cards/card_double.png" style="float:left; width: 45px; height: 61px; image-rendering: pixelated;">
                        </label>
                    </li>
                    <li class="list-group-item">
                        <input class="form-check-input me-1 card-option" type="radio" name="card" value="halo" id="card-halo" disabled>
                        <label class="form-check-label stretched-link" for="card-halo">
                            <img src="/media/cards/card_halo.png" style="float:left; width: 45px; height: 61px; image-rendering: pixelated;">
                        </label>
                    </li>
                    <li class="list-group-item">
                        <input class="form-check-input me-1 card-option" type="radio" name="card" value="report" id="card-report" disabled>
                        <label class="form-check-label stretched-link" for="card-report">
                            <img src="/media/cards/card_report.png" style="float:left; width: 45px; height: 61px; image-rendering: pixelated;">
                        </label>
                    </li>
                    <li class="list-group-item">
                        <input class="form-check-input me-1 card-option" type="radio" name="card" value="swap" id="card-swap" disabled>
                        <label class="form-check-label stretched-link" for="card-swap">
                            <img src="/media/cards/card_swap.png" style="float:left; width: 45px; height: 61px; image-rendering: pixelated;">
                        </label>
                    </li>
                    <li class="list-group-item">
                        <input class="form-check-input me-1 card-option" type="radio" name="card" value="play-no-cards" id="card-none" disabled>
                        <label class="form-check-label stretched-link" for="card-none">
                            Reset Played Cards
                        </label>
                    </li>
                </ul>

                <div class="mb-3" id="select-team-container" style="display: none;">
                    <label for="card-select" class="form-label">(for Report/Swap only) Select team to report/swap:</label>
                    <select id="card-select" class="form-select"></select> <!-- SELECT TEAM TO REPORT OR SWAP -->
                </div>

                <div class="mb-3" style="margin-top: 10px">
                    <button id="submit-card-btn" class="pixel-button primary" disabled>Submit Card</button>
                </div>

                <div class="alert alert-info" role="alert">
                    <h4 class="alert-heading">Tips:</h4>
                    <p class="mb-0">
                        To remove a card you have played, select the 'Reset Played Cards' option.
                    </p>
                    <p>
                        There is no way to view cards once they have been played. This ensures other players cannot see what card you have played.<br>
                        If you are unsure what card you played, remove it using 'Reset Played Cards' and then resubmit.<br>
                    </p>
                </div>
            </div>


            <!-- Casino -->
            <!-- Casino -->
            <div id="casino" class="tab-pane fade" role="tabpanel" aria-labelledby="casino-tab">
              <div id="casino-container">
                  <div id="casino-header">
                      <img src="/media/casino/casino.png" class="casino-title">
                      <p class="casino-info">
                          The Casino opens during the Monaco and Las Vegas GP. Bet your team's points here on different questions.
                      </p>
                  </div>

                  <!-- Team Selection -->
                  <label for="casino-team-select" class="casino-label">Select Your Team:</label>
                  <select id="casino-team-select" class="form-select">
                      <option value="">-- Select Team --</option>
                  </select>
                  <div id="casino-loading" class="casino-loading-indicator" style="display: none;">
                    Loading existing bets...
                    <div class="casino-loading-bar"></div>
                  </div>
                  
                  <!-- Betting Tables -->
                  <div id="casino-tables"></div>

                  <!-- Submit Button -->
                  <button id="submit-bets" class="casino-button" style="margin-top: 15px" disabled>Submit Bets</button>
              </div>
            </div>
        </div>
    </main>
 
    <footer class="bg-light text-black text-center py-1 pixel-art-body-smallx">
        <p>&copy; 2024 F1 Predictions Form</p>
    </footer>
    <script>
// Global variable to store teams data once loaded.
let teamsData = [];

/**
 * loadRaceName - Fetches the current race name based on the race number in form_details.
 */
async function loadRaceName() {
  try {
    const { data: formDetails, error: formError } = await supabase
      .from('form_details')
      .select('race_number')
      .single();
    if (formError || !formDetails) {
      console.error("Error fetching race number:", formError);
      return;
    }
    const raceNumber = formDetails.race_number;

    const { data: raceData, error: raceError } = await supabase
      .from('calendar')
      .select('name')
      .eq('race_number', raceNumber)
      .single();
    if (raceError || !raceData) {
      console.error("Error fetching race name:", raceError);
      return;
    }
    document.getElementById("current-race-name").textContent = `${raceData.name} GP`;
  } catch (err) {
    console.error("loadRaceName error:", err);
  }
}

/**
 * loadTeamsForCards - Loads the entire teams table and populates the team-select dropdown.
 */
async function loadTeamsForCards() {
  try {
    const { data, error } = await supabase.from('teams').select('*');
    if (error) {
      console.error("Error loading teams:", error);
      return;
    }
    teamsData = data; // cache teams data
    const teamSelect = document.getElementById("team-select");
    teamSelect.innerHTML = '<option value="" disabled selected>Select a team</option>'; // Placeholder

    data.forEach(team => {
      const option = document.createElement("option");
      option.value = team.id;
      option.textContent = team.name;
      teamSelect.appendChild(option);
    });

    teamSelect.disabled = false; // Enable dropdown after loading

    // Update card stock display when a team is selected.
    updateTeamCardStock();
  } catch (err) {
    console.error("loadTeamsForCards error:", err);
  }
}

/**
 * updateTeamCardStock - Displays card stock for the selected team.
 * It shows the sum of played and unplayed for each card and disables options with zero stock.
 */
function updateTeamCardStock() {
  const teamSelect = document.getElementById("team-select");
  const selectedTeamId = teamSelect.value;
  const team = teamsData.find(t => t.id == selectedTeamId);
  if (!team) return;
  
  // Calculate stock for each card type.
  const cardStock = {
    aero: (Number(team.card_aero_unplayed) || 0) + (Number(team.card_aero_played) || 0),
    double: (Number(team.card_double_unplayed) || 0) + (Number(team.card_double_played) || 0),
    halo: (Number(team.card_halo_unplayed) || 0) + (Number(team.card_halo_played) || 0),
    report: (Number(team.card_report_unplayed) || 0) + (Number(team.card_report_played) || 0),
    swap: (Number(team.card_swap_unplayed) || 0) + (Number(team.card_swap_played) || 0)
  };
  
  // Update stock display.
  const stockEl = document.getElementById("team-card-stock");
  stockEl.innerHTML = `
    <p><strong>Team Card Stock (as of last round):</strong></p>
    <ul>
      <li>Aero: ${cardStock.aero}</li>
      <li>Double: ${cardStock.double}</li>
      <li>Halo: ${cardStock.halo}</li>
      <li>Report: ${cardStock.report}</li>
      <li>Swap: ${cardStock.swap}</li>
    </ul>
  `;
  
  // Disable radio buttons if no stock.
  const cardOptions = {
    aero: cardStock.aero,
    double: cardStock.double,
    halo: cardStock.halo,
    report: cardStock.report,
    swap: cardStock.swap
  };
  
  document.querySelectorAll("input[name='card']").forEach(radio => {
    const val = radio.value;
    if (val in cardOptions) {
      radio.disabled = (cardOptions[val] === 0);
      radio.parentElement.title = radio.disabled ? `You have no ${val} cards remaining.` : "";
    } else if (val === "play-no-cards") {
      radio.disabled = false;
    }
  });
  
  // (Removed blanket enabling of card options to preserve disabled state.)
  
  // Enable the submit button if a team is selected.
  document.getElementById("submit-card-btn").disabled = false;
  
  // Also update the report/swap team dropdown if needed.
  updateTeamDropdownForSpecialCards();
}

/**
 * updateTeamDropdownForSpecialCards - When a Report or Swap card is selected,
 * populate the dropdown with teams (excluding the selected team).
 */
function updateTeamDropdownForSpecialCards() {
  const selectedTeamId = document.getElementById("team-select").value;
  const selectedCard = document.querySelector("input[name='card']:checked")?.value;
  const selectTeamContainer = document.getElementById("select-team-container");
  const cardSelect = document.getElementById("card-select");

  if (selectedCard === "report" || selectedCard === "swap") {
    selectTeamContainer.style.display = "block";
    cardSelect.innerHTML = '<option value="" disabled selected>Select a team</option>';
    teamsData
      .filter(t => t.id != selectedTeamId)
      .forEach(team => {
        const option = document.createElement("option");
        option.value = team.id;
        option.textContent = team.name;
        cardSelect.appendChild(option);
      });
  } else {
    selectTeamContainer.style.display = "none";
  }
}

/**
 * submitCards - Called when the user clicks the "Submit Card" button.
 * It resets played cards to unplayed, then applies the chosen card play.
 * For Report/Swap, the selected team from the dropdown is recorded.
 * "Play no cards" resets all played cards to unplayed and clears extra columns.
 * After submission, the form resets.
 */
async function submitCards() {
  const teamSelect = document.getElementById("team-select");
  const selectedTeamId = teamSelect.value;
  const team = teamsData.find(t => t.id == selectedTeamId);
  if (!team) {
    alert("Team not found.");
    return;
  }
  
  // Get the selected card value.
  const selectedCardRadio = document.querySelector("input[name='card']:checked");
  if (!selectedCardRadio) {
    alert("Please select a card option.");
    return;
  }
  const selectedCard = selectedCardRadio.value; // e.g., 'aero', 'double', 'halo', 'report', 'swap', or 'play-no-cards'
  
  // For report or swap, get the target team from the dropdown.
  let targetTeamId = null;
  if (selectedCard === "report" || selectedCard === "swap") {
    targetTeamId = document.getElementById("card-select").value;
    if (!targetTeamId) {
      alert("Please select a team to report or swap.");
      return;
    }
  }
  
  // Prepare new card values:
  // Reset: for each card type, new_unplayed = current_unplayed + played; played = 0.
  const cardTypes = ["aero", "double", "halo", "report", "swap"];
  const updatedValues = {};
  cardTypes.forEach(card => {
    const unplayedCol = `card_${card}_unplayed`;
    const playedCol = `card_${card}_played`;
    const unplayed = Number(team[unplayedCol]) || 0;
    const played = Number(team[playedCol]) || 0;
    updatedValues[unplayedCol] = unplayed + played;
    updatedValues[playedCol] = 0;
  });
  
  if (selectedCard !== "play-no-cards") {
    // For the selected card, subtract 1 from unplayed and add 1 to played.
    const unplayedCol = `card_${selectedCard}_unplayed`;
    const playedCol = `card_${selectedCard}_played`;
    if (updatedValues[unplayedCol] <= 0) {
      alert(`You do not have any ${selectedCard} cards available.`);
      return;
    }
    updatedValues[unplayedCol] -= 1;
    updatedValues[playedCol] = 1;
  } else {
    // If "Play no cards" is selected, clear extra columns.
    updatedValues.card_swap_time = null;
    updatedValues.card_swap_team_selected = null;
    updatedValues.card_report_team_selected = null;
  }
  
  // Record target team ID for report or swap.
  if (selectedCard === "report") {
    updatedValues.card_report_team_selected = targetTeamId;
  } else if (selectedCard === "swap") {
    updatedValues.card_swap_team_selected = targetTeamId;
    updatedValues.card_swap_time = new Date().toISOString(); // Record timestamp
  }
  
  // Update the team's row in the teams table.
  const { error: updateError } = await supabase
    .from('teams')
    .update(updatedValues)
    .eq('id', selectedTeamId);
  if (updateError) {
    console.error("Error updating team card submission:", updateError);
    alert("Failed to submit cards.");
    return;
  }
  
  alert("Cards submitted successfully!");
  
  // Reset the form:
  // Clear team selection.
  const teamSelectElem = document.getElementById("team-select");
  teamSelectElem.value = "";
  teamSelectElem.disabled = true;
  // Clear team card stock.
  document.getElementById("team-card-stock").innerHTML = "";
  // Uncheck all card radio buttons and disable them.
  document.querySelectorAll("input[name='card']").forEach(radio => {
    radio.checked = false;
    radio.disabled = true;
  });
  // Hide the report/swap dropdown.
  document.getElementById("select-team-container").style.display = "none";
  // Disable submit button.
  document.getElementById("submit-card-btn").disabled = true;
  
  // Reload teams data to refresh the form.
  await loadTeamsForCards();
}

/**
 * loadSubmitCardsPage - Initializes the submit cards page.
 */
async function loadSubmitCardsPage() {
  await loadRaceName();
  await loadTeamsForCards();

  // Bind change event on team-select to update card stock display.
  document.getElementById("team-select").addEventListener("change", updateTeamCardStock);
  // Bind change event on card radio buttons to update the report/swap team dropdown.
  document.querySelectorAll("input[name='card']").forEach(input => {
    input.addEventListener("change", updateTeamDropdownForSpecialCards);
  });
  document.getElementById("submit-card-btn").addEventListener("click", submitCards);
}

// Initialize the page when DOM is ready.
document.addEventListener("DOMContentLoaded", loadSubmitCardsPage);

// --- TEAM STANDING AND CARDS ---
// ---------- HELPER FUNCTION ----------
async function getTable(tableName) {
  const { data, error } = await supabase.from(tableName).select('*');
  if (error) {
    console.error(`Error fetching ${tableName}:`, error);
    throw error;
  }
  return data;
}

// ---------- LOAD TEAM STANDINGS AND CARDS ----------
// ---------- LOAD TEAM STANDINGS AND CARDS ----------
async function loadTeamStandingsAndCards() {
  try {
    // Show loading indicator
    const loadingIndicator = document.getElementById('playerLoading');
    loadingIndicator.style.display = 'block';
    loadingIndicator.innerHTML = "Team Standings loading...<div class='loading-bar'></div>";
    // 1. Retrieve the current year from form_details (assumes a single row with id=1)
    const { data: formDetails, error: formDetailsError } = await supabase
      .from('form_details')
      .select('*')
      .eq('id', 1)
      .single();
    if (formDetailsError) {
      console.error('Error fetching form details:', formDetailsError.message);
      return;
    }
    const currentYear = formDetails.current_year;

    // 2. Download the season_team_{year} table (which contains team standings)
    const seasonTeamTable = `season_team_${currentYear}`;
    const seasonTeamData = await getTable(seasonTeamTable);

    // 3. Determine the last race with data using the special row (team_id === 0)
    const raceNamesRow = seasonTeamData.find(row => row.team_id === 0);
    let lastRace = 0;
    if (raceNamesRow) {
      // Assume race columns are named race_1, race_2, ‚Ä¶, race_32.
      for (let i = 1; i <= 32; i++) {
        const col = `race_${i}`;
        if (raceNamesRow[col] !== null && raceNamesRow[col] !== "") {
          lastRace = i;
        } else {
          break;
        }
      }
    }

    // 4. Filter out the special "Race Names" row (team_id === 0)
    const teamStandings = seasonTeamData.filter(row => row.team_id !== 0);

    // 5. For each team, compute the grand total by summing races 1 to lastRace.
    teamStandings.forEach(team => {
      let total = 0;
      for (let i = 1; i <= lastRace; i++) {
        const col = `race_${i}`;
        if (team[col] !== null && team[col] !== "") {
          // Remove any extra tags (e.g. "(double)", "(aero)") using a regex.
          const numStr = team[col].replace(/\(.*?\)/g, "").trim();
          const num = parseFloat(numStr);
          if (!isNaN(num)) {
            total += num;
          }
        }
      }
      team.grand_total = total;
    });

    // 6. Sort teams by grand_total descending.
    teamStandings.sort((a, b) => b.grand_total - a.grand_total);

    // 7. Compute ranking with simple tie‚Äëhandling.
    let currentRank = 1;
    let prevScore = null;
    teamStandings.forEach((team, index) => {
      if (prevScore === null || team.grand_total !== prevScore) {
        currentRank = index + 1;
      }
      team.rank = currentRank;
      prevScore = team.grand_total;
    });

    // 8. Download the teams table (to retrieve card stock and player info)
    const teamsData = await getTable('teams');
    // Build a map of teams by team_id for quick lookup.
    const teamsMap = {};
    teamsData.forEach(team => {
      teamsMap[team.id] = team;
    });

    // 9. Define the card types and image source.
    // Note: We now use a "name" property so that we can sum the played and unplayed stock.
    const cardTypes = [
      { name: 'double', src: '/media/cards/card_double.png' },
      { name: 'aero', src: '/media/cards/card_aero.png' },
      { name: 'halo', src: '/media/cards/card_halo.png' },
      { name: 'report', src: '/media/cards/card_report.png' },
      { name: 'swap', src: '/media/cards/card_swap.png' }
    ];

    // 10. Build the HTML list items.
    // The container is the inner div with class "list-group" inside the section with id "team-standings-and-cards".
    const container = document.querySelector('#team-standings-and-cards .list-group');
    container.innerHTML = ''; // Clear any existing content

    teamStandings.forEach(team => {
      // Look up additional team info from the teams table.
      const teamInfo = teamsMap[team.team_id] || {};

      // Get the player names: use values from season_team_{year} if present; otherwise, fall back on teams table.
      const player1 = team.player_name_1 || teamInfo.player1 || '';
      const player2 = team.player_name_2 || teamInfo.player2 || '';
      const playersText = `Players: ${player1}${(player1 && player2) ? ', ' : ''}${player2}`;

      // Build the card images.
      // For each card type, compute the total by summing the unplayed and played counts.
      let cardImagesHTML = '';
      cardTypes.forEach(card => {
        const count = (Number(teamInfo[`card_${card.name}_unplayed`]) || 0) +
                      (Number(teamInfo[`card_${card.name}_played`]) || 0);
        for (let i = 0; i < count; i++) {
          cardImagesHTML += `<img src="${card.src}" style="float:left; width: 45px; height: 61px; image-rendering: pixelated; margin-right: 5px;">`;
        }
      });

      // Create the list-group item.
      const aElem = document.createElement('a');
      aElem.href = "#";
      aElem.className = "list-group-item";
      aElem.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-3 pixel-art-heading-2">${team.rank}. ${team.team_name}</h5>
          <small class="pixel-art-body-small">${team.grand_total} pts</small>
        </div>
        <p class="mb-1">${playersText}</p>
        <p class="mb-1">Cards Left:</p>
        <div>${cardImagesHTML}</div>
      `;
      container.appendChild(aElem);
    });
  } catch (err) {
    console.error("loadTeamStandingsAndCards error:", err);
  }
  // Hide the loading indicator once the process is complete
  document.getElementById('playerLoading').style.display = 'none';
}

// ---------- INITIALIZATION ----------
document.addEventListener("DOMContentLoaded", () => {
  loadTeamStandingsAndCards();
});

document.addEventListener("DOMContentLoaded", async function () {
    const teamSelectCasino = document.getElementById("casino-team-select");
    const casinoTables = document.getElementById("casino-tables");
    const submitButton = document.getElementById("submit-bets");

    let betsEnabled = {};
    let betOdds = {};
    let betQuestions = {};
    let betMaxLimits = {}; // Store max bet limits
    let currentBets = [0, 0, 0, 0, 0];

    // Fetch data from Supabase
    async function fetchData(table, fields = '*') {
        try {
            const { data, error } = await supabase.from(table).select(fields);
            if (error) {
                console.error(`Error fetching ${table}:`, error);
                return [];
            }
            console.log(`Fetched ${table} data:`, data);
            return data || [];
        } catch (err) {
            console.error(`Unexpected error fetching ${table}:`, err);
            return [];
        }
    }

    // Load Casino Data
    async function loadCasinoData() {
        let data = await fetchData("casino", "*");
        if (!data.length) {
            console.warn("Casino data is empty.");
            return;
        }

        betsEnabled = data.find(row => row.team_id === -1) || {};
        betOdds = data.find(row => row.team_id === 0) || {};
        betQuestions = data.find(row => row.team_id === -2) || {};
        let maxBetRow = data.find(row => row.team_id === -3) || {}; // Get max bet values

        console.log("betsEnabled (raw):", betsEnabled);

        // Convert string "true"/"false" to actual booleans
        Object.keys(betsEnabled).forEach(key => {
            if (betsEnabled[key] === "true") betsEnabled[key] = true;
            if (betsEnabled[key] === "false") betsEnabled[key] = false;
        });

        // Convert max bet values from string to number
        Object.keys(maxBetRow).forEach(key => {
            if (key.startsWith("bet_")) {
                betMaxLimits[key] = parseInt(maxBetRow[key]) || 10; // Default max bet = 10
            }
        });

        console.log("Max Bet Limits:", betMaxLimits);

        createBetTables();
    }

    // Load Team Dropdown
    async function populateTeamDropdown() {
        const teams = await fetchData('teams', 'id, name');

        if (!teams.length) {
            console.warn("No teams found.");
            return;
        }

        console.log("Populating team dropdown...");

        if (!teamSelectCasino) {
            console.error("teamSelectCasino element not found!");
            return;
        }

        teamSelectCasino.innerHTML = "";

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Select a team";
        placeholder.disabled = true;
        placeholder.selected = true;
        teamSelectCasino.appendChild(placeholder);

        teams.forEach(team => {
            console.log(`Adding team: ${team.name} (ID: ${team.id})`);
            const option = document.createElement("option");
            option.value = team.id;
            option.textContent = team.name;
            teamSelectCasino.appendChild(option);
        });

        teamSelectCasino.selectedIndex = 0;
        teamSelectCasino.dispatchEvent(new Event("change"));

        console.log("Team dropdown populated successfully.");
    }

    // Create Bet Tables
    function createBetTables() {
        casinoTables.innerHTML = "";

        for (let i = 1; i <= 5; i++) {
            const isEnabled = betsEnabled[`bet_${i}`];
            console.log(`Checking bet_${i}:`, isEnabled, `(Type: ${typeof isEnabled})`);

            if (!isEnabled) {
                console.log(`Skipping bet_${i} (not enabled)`);
                continue;
            }

            const maxBet = betMaxLimits[`bet_${i}`] || 10; // Use max bet limit

            const table = document.createElement("div");
            table.classList.add("bet-table");

            table.innerHTML = `
                <!-- Row 1: Bet Question -->
                <div class="bet-question">${betQuestions[`bet_${i}`]}</div>

                <!-- Row 2: Odds and Max Bet -->
                <div class="bet-info">
                    <span class="bet-odds pixel-art-body-white">Odds: ${betOdds[`bet_${i}`]}:1</span>
                    <span class="max-bet pixel-art-body-white">Max Bet: ${maxBet}</span>
                </div>

                <!-- Row 3: Controls and Coin Display -->
                <div class="bet-controls">
                    <button class="bet-button" data-index="${i}" data-action="decrease" disabled>-</button>
                    <input type="text" class="bet-amount" id="bet-${i}" value="0" readonly>
                    <button class="bet-button" data-index="${i}" data-action="increase" disabled>+</button>
                    <img src="/media/casino/coin_1.png" class="coin-display" id="coin-${i}" style="visibility: hidden;">
                </div>
            `;

            casinoTables.appendChild(table);
            console.log(`Rendered bet_${i} table.`);
        }
    }

    // Handle Team Selection
    teamSelectCasino.addEventListener("change", async function () {
    const teamId = teamSelectCasino.value;
    if (!teamId) {
        submitButton.disabled = true;
        document.querySelectorAll(".bet-button").forEach(btn => btn.disabled = true);
        console.log("No team selected. Betting disabled.");
        return;
    }

    // Show loading indicator only if the team has existing bets
    let data = await fetchData("casino", "*");
    let teamBets = data.find(row => row.team_id == teamId);

    if (teamBets) {
        document.getElementById("casino-loading").style.display = "block";
        submitButton.disabled = true;
        document.querySelectorAll(".bet-button").forEach(btn => btn.disabled = true);

        // Wait for 2 seconds to simulate loading
        await new Promise(resolve => setTimeout(resolve, 2000));

        document.getElementById("casino-loading").style.display = "none";
    }

    // Always enable betting after loading, even if no previous bets exist
    submitButton.disabled = false;
    document.querySelectorAll(".bet-button").forEach(btn => btn.disabled = false);

    // Load existing bets (or set to 0 if no previous bets exist)
    for (let i = 1; i <= 5; i++) {
        const betInput = document.getElementById(`bet-${i}`);
        if (betInput) {
            const betValue = teamBets ? teamBets[`bet_${i}`] || 0 : 0;
            betInput.value = betValue;
            currentBets[i - 1] = parseInt(betValue);
            updateCoinDisplay(i);
            console.log(`Set bet_${i} to ${betValue} for team ${teamId}.`);
        }
    }
});



    // Adjust Bets
    document.addEventListener("click", function (event) {
        if (!event.target.classList.contains("bet-button")) return;

        const index = event.target.dataset.index;
        const action = event.target.dataset.action;
        const betInput = document.getElementById(`bet-${index}`);
        let betValue = parseInt(betInput.value);
        const maxBet = betMaxLimits[`bet_${index}`] || 10; // Get max bet

        if (action === "increase" && betValue < maxBet) betValue++;
        if (action === "decrease" && betValue > 0) betValue--;

        betInput.value = betValue;
        currentBets[index - 1] = betValue;
        updateCoinDisplay(index);
        console.log(`Bet ${index} updated: ${betValue}`);
    });

    function updateCoinDisplay(index) {
        const coinImg = document.getElementById(`coin-${index}`);
        if (currentBets[index - 1] > 0) {
            coinImg.src = `/media/casino/coin_${currentBets[index - 1]}.png`;
            coinImg.style.visibility = "visible";
        } else {
            coinImg.style.visibility = "hidden";
        }
    }

    // Submit Bets
    submitButton.addEventListener("click", async function () {
    const selectedTeamIdCasino = parseInt(teamSelectCasino.value); // Ensure it's an integer
    if (!selectedTeamIdCasino) {
        alert("Please select a team.");
        return;
    }

    const betsToSubmit = {};
    for (let i = 1; i <= 5; i++) {
        const betAmount = currentBets[i - 1].toString(); // Ensure bet_1 ‚Üí bet_5 are stored as text
        if (parseInt(betAmount) > 0) {
            betsToSubmit[`bet_${i}`] = betAmount;
        }
    }

    if (Object.keys(betsToSubmit).length === 0) {
        alert("Please place some bets before submitting.");
        return;
    }

    // Construct the data to submit
    const betData = {
        team_id: selectedTeamIdCasino,
        team_name: teamSelectCasino.options[teamSelectCasino.selectedIndex].text,
        ...betsToSubmit,
    };

    console.log("üîç Checking if team_id exists:", selectedTeamIdCasino);

    // Step 1: Check if a row for this team_id already exists
    const { data: existingRows, error: fetchError } = await supabase
        .from("casino")
        .select("team_id")
        .eq("team_id", selectedTeamIdCasino);

    if (fetchError) {
        console.error("‚ùå Error checking existing bets:", fetchError);
        alert("Failed to check existing bets.");
        return;
    }

    console.log("üìù Existing team check result:", existingRows);

    let query;
    if (existingRows.length > 0) {
        // Step 2: If it exists, update the row
        console.log("üîÑ Updating existing bet for team_id:", selectedTeamIdCasino);
        query = supabase.from("casino").update(betData).eq("team_id", selectedTeamIdCasino);
    } else {
        // Step 3: If it does not exist, insert a new row
        console.log("‚ûï Inserting new bet for team_id:", selectedTeamIdCasino);
        query = supabase.from("casino").insert([betData]);
    }

    const { data, error } = await query;

    if (error) {
        console.error("‚ùå Error submitting bets:", error);
        alert("Failed to submit bets.");
    } else {
        console.log("‚úÖ Bets submitted successfully:", data);
        alert("Bets submitted successfully!");
    }
});




    await loadCasinoData();
    await populateTeamDropdown();
});






    </script>
    <!-- Bootstrap JS Bundle (Local) -->
    <script src="/js/bootstrap.bundle.min.js"></script>
</body>
</html>