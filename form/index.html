<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Page Details -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/media/f1_predictions_logo.ico" type="image/x-icon">
    <title>F1 Predictions | Form</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/style.css">
    <!-- Supabase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Initialize Supabase globally
        const supabaseUrl = 'https://mbyhlefxnjjzmiwsvnaa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ieWhsZWZ4bmpqem1pd3N2bmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzODQwOTgsImV4cCI6MjA0OTk2MDA5OH0.4gcUcOfhyTspbcDn6gPxBKFSTu3zUbkBdNEhMq9MdnY';
        var supabase = supabase.createClient(supabaseUrl, supabaseKey);
    
        // Function to update the form title based on the race name
        async function updateFormTitle() {
            try {
                // Fetch the race number from form_details
                const { data: formDetails, error: formDetailsError } = await supabase
                    .from('form_details')
                    .select('race_number')
                    .eq('id', 1)
                    .single();
    
                if (formDetailsError) {
                    console.error('Error fetching form details:', formDetailsError);
                    return;
                }
    
                const raceNumber = formDetails.race_number;
    
                // Fetch the race name from the calendar table
                const { data: raceDetails, error: raceDetailsError } = await supabase
                    .from('calendar')
                    .select('name')
                    .eq('race_number', raceNumber)
                    .single();
    
                if (raceDetailsError) {
                    console.error('Error fetching race details:', raceDetailsError);
                    return;
                }
    
                const raceName = raceDetails.name;
    
                // Update the form title
                const formTitle = document.getElementById('form-title');
                formTitle.textContent = `${raceName} GP Form`;
            } catch (error) {
                console.error('Error updating form title:', error);
            }
        }
    
        // Call the function to update the form title as soon as possible
        updateFormTitle();
    </script>
    
</head>
<body>
    <header class="bg-light text-black py-2.5 d-flex align-items-center justify-content-between sticky-top">
        <!-- Left Section: Logo and Heading -->
        <div class="d-flex align-items-center">
            <a href="/" class="ms-2.5 me-2 d-flex align-items-center">
                <img src="/media/f1_predictions_logo.png" alt="Logo" style="height: 45px;">
            </a>
            <a href="/" class="text-decoration-none text-black">
                <h5 class="mb-0 pixel-art-heading-2">F1 Predictions</h5>
            </a>
        </div>
        
        <!-- Right Section: Hamburger Menu -->
        <div class="pixel-dropdown me-3">
            <button class="pixel-button" type="button" id="hamburgerMenu" data-bs-toggle="dropdown" aria-expanded="false">
                Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="hamburgerMenu">
                <li><a class="dropdown-item pixel-art-body-smallx" href="/">Home</a></li>
                <li><hr class="dropdown-divider"></li> <!-- Spacer -->
                <li><a class="dropdown-item pixel-art-body-smallxb" href="/form">Form</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/teams">Teams</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/results">Results</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/register">Register</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/feedback">Feedback</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/info">Info</a></li>
                <li><a class="dropdown-item pixel-art-body-smallx" href="/archive">Archive</a></li>
                <li><hr class="dropdown-divider"></li> <!-- Spacer -->
                <li><a class="dropdown-item pixel-art-body-smallx" href="/admin">Admin</a></li>
            </ul>
        </div>
    </header>     
    
    <main class="container my-5">
    <div class="container my-5">
        <h2 id="form-title" class="mb-3 pixel-art-heading-3">Form</h2>
        <!-- Form Countdown Timer -->
        <div id="form-countdown-container" style="display: none;">
            <strong>Time left: </strong>
            <span id="form-countdown"></span>
        </div>
        <div id="form-content">
            <form id="prediction-form" action="/submit" method="POST">
                <div id="form-section-1"></div>
                <!-- Add this to your HTML body, preferably near the player name input field -->
                 <!-- Loading Indicator for Form Blocks -->
                <div id="formLoading" class="loading-indicator mb-3 pixel-art-heading-2" style="display: none;">
                    Form loading...
                    <div class="loading-bar"></div>
                </div>
                <div id="repeated-predictions-alert" class="pixel-alert pixel-alert-warning d-none">
                    Player has already submitted predictions. Submitting new predictions will override the previous ones.
                </div>
                <div class="pixel-alert pixel-alert-info">
                    Not seeing your name? Register at the <a href="/register">Register Page</a>.
                </div>
                <div>
                    <p><i>For detailed question rules, please see info page.</i></p>
                </div>
                
                <hr>
                
                <!-- Starting Grid Block with Image -->
                <div id="starting-grid">
                    <h5 class="mb-3 pixel-art-heading-2">Starting Grid</h5>
                    <img id="startingGridPlaceholder" src="" alt="Starting Grid" style="max-width: 100%; max-height: 300px; height: auto;" />
                </div>
                
                <hr>

                <div>
                    <h5 class="mb-3 pixel-art-heading-2">Top 6 Predictions</h5>
                    <p><i>Up to 2 points per prediction, 1 bonus point for winner</i></p>
                </div>
                <div id="form-section-2"></div>

                <hr>

                <div>
                    <h5 class="mb-3 pixel-art-heading-2">Other Predictions</h5>
                    <p><i>1 point per prediction, unless otherwise specified</i></p>
                </div>
                <div id="form-section-3"></div>
                
                <hr>

                <div>
                    <h5 class="mb-3 pixel-art-heading-2">Winning Margin</h5>
                    <p><i>1 point for closest guess</i></p>
                </div>
                <div id="form-section-4"></div>
                    
                <!-- Submit Button -->
                <div class="text-center mt-4">
                    <button type="submit" class="pixel-button primary">Submit</button>
                </div>
            </form>
        </div>
    </div>
</main>

<footer class="bg-light text-black text-center py-1 pixel-art-body-smallx">
    <p>&copy; 2024 F1 Predictions Form</p>
</footer>

    <!-- Form Script -->
    <script type="module">
        import { generateFormBlocks } from '/script.js';

        // -------------------------------
        // FETCH RACE DETAILS
        // -------------------------------
        async function fetchRaceDetails() {
        try {
            // First, fetch the race number from form_details
            const { data: formDetails, error: formDetailsError } = await supabase
            .from('form_details')
            .select('race_number')
            .eq('id', 1)
            .single();
            if (formDetailsError) {
            console.error('Error fetching form details:', formDetailsError);
            return null;
            }
            const raceNumber = formDetails.race_number;

            // Then, fetch the race details from the calendar table
            const { data: raceDetails, error: raceDetailsError } = await supabase
            .from('calendar')
            .select('*')
            .eq('race_number', raceNumber)
            .single();
            if (raceDetailsError) {
            console.error('Error fetching race details:', raceDetailsError);
            return null;
            }

            return raceDetails;
        } catch (error) {
            console.error('Error fetching race details:', error);
            return null;
        }
        }

        // -------------------------------
        // START FORM COUNTDOWN TIMER
        // -------------------------------
        /**
         * Starts a countdown for the form until the race begins.
         * @param {Date} targetDate - The race start date.
         * @param {function} onEnd - Callback executed when countdown reaches zero.
         */
        function startFormCountdown(targetDate, onEnd) {
        const countdownElement = document.getElementById("form-countdown");
        if (!countdownElement) {
            console.error("Countdown element not found.");
            return;
        }
        
        let timer;
        
        function updateCountdown() {
            const now = new Date();
            const timeLeft = targetDate - now;
            
            if (timeLeft <= 0) {
            clearInterval(timer);
            countdownElement.textContent = "Submissions closed. Race has started.";
            if (typeof onEnd === "function") {
                onEnd();
            }
            return;
            }
            
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            let countdownStr = "";
            if (days > 0) {
            countdownStr += `${days}d `;
            }
            countdownStr += `${hours}h ${minutes}m ${seconds}s`;
            
            countdownElement.textContent = countdownStr;
        }
        
        updateCountdown();
        timer = setInterval(updateCountdown, 1000);
        }

        // -------------------------------
        // CHECK FORM ENABLED STATUS
        // -------------------------------
        async function checkFormStatus() {
        try {
            const { data: formDetails, error: formDetailsError } = await supabase
            .from('form_details')
            .select('form_enabled')
            .eq('id', 1)
            .single();

            if (formDetailsError) {
            console.error('Error fetching form status:', formDetailsError);
            return false;
            }

            return formDetails.form_enabled;
        } catch (error) {
            console.error('Error fetching form status:', error);
            return false;
        }
        }

        // -------------------------------
        // MAIN FORM PAGE LOGIC
        // -------------------------------
        document.addEventListener('DOMContentLoaded', async () => {
        // First, fetch both the form enabled status and the race details
        const formEnabled = await checkFormStatus();
        const raceDetails = await fetchRaceDetails();
        let raceHasStarted = false;

        if (raceDetails) {
            const raceStart = new Date(raceDetails.date);
            raceHasStarted = new Date() >= raceStart;

            // Optionally update the form title (if updateFormTitle is defined elsewhere)
            await updateFormTitle();

            // Show the form countdown container
            const formCountdownContainer = document.getElementById("form-countdown-container");
            if (formCountdownContainer) {
            formCountdownContainer.style.display = "block";
            }
            // Start the countdown if the race hasn't started;
            // otherwise, immediately show "Race has started!" in the countdown element.
            if (!raceHasStarted) {
            startFormCountdown(raceStart, () => {
                // When the countdown ends, disable the form automatically
                document.getElementById('form-content').innerHTML = 
                '<div class="pixel-alert pixel-alert-warning">The form is now closed as the race has started.</div>';
            });
            } else {
            const countdownElement = document.getElementById("form-countdown");
            if (countdownElement) {
                countdownElement.textContent = "Submissions closed. Race has started.";
            }
            }
        }

        // If the form is not enabled OR the race has already started, show a closed message and exit.
        if (!formEnabled || raceHasStarted) {
            document.getElementById('form-content').innerHTML = 
            '<div class="pixel-alert pixel-alert-warning" role="alert">The form is currently closed.</div>';
            return;
        }

        // -------------------------------
        // CONTINUE WITH EXISTING FORM LOGIC
        // -------------------------------
        const loadingIndicator = document.getElementById('formLoading');
        loadingIndicator.style.display = 'block';

        const form = document.getElementById('prediction-form');
        const alertContainer = document.getElementById('repeated-predictions-alert');
        const startingGridPlaceholder = document.getElementById("startingGridPlaceholder");
        const bucketName = "media";
        const fileNamePrefix = "current_starting_grid";
        const fileExtensions = ["png", "jpg", "jpeg"];
        let existingSubmissions = [];

        // Fetch form configuration to determine required fields
        let formConfig = [];
        async function fetchFormConfig() {
            const { data, error } = await supabase
            .from('form_configuration')
            .select('id, enabled');
            if (error) {
            console.error('Error fetching form configuration:', error);
            return;
            }
            formConfig = data;
        }

        await fetchFormConfig();

        // Load existing submissions on page load
        async function loadExistingSubmissions() {
            const { data: formDetails, error: formDetailsError } = await supabase
            .from('form_details')
            .select('race_number')
            .eq('id', 1)
            .single();

            if (formDetailsError) {
            console.error('Error fetching form details:', formDetailsError);
            return;
            }

            const raceNumber = formDetails.race_number;

            const { data: submissions, error: submissionsError } = await supabase
            .from('form_raw')
            .select('player_id')
            .eq('race_number', raceNumber);

            if (submissionsError) {
            console.error('Error fetching existing submissions:', submissionsError);
            return;
            }

            existingSubmissions = submissions.map(submission => submission.player_id);
            console.log('Existing Submissions:', existingSubmissions); // Debug log
        }

        await loadExistingSubmissions();

        // Load the starting grid image
        async function loadStartingGridImage() {
            console.log("Loading starting grid image...");
            for (const ext of fileExtensions) {
            const fileName = `${fileNamePrefix}.${ext}`;
            const { data, error } = await supabase.storage
                .from(bucketName)
                .download(fileName);

            if (error) {
                console.log(`Error loading ${fileName}:`, error.message);
            } else {
                console.log(`Loaded ${fileName}`);
                const url = URL.createObjectURL(data);
                startingGridPlaceholder.src = url;
                return; // Exit once a file is found
            }
            }
            console.error("No matching file found");
            startingGridPlaceholder.src = ""; // Reset if no file found
        }

        await loadStartingGridImage();

        // Dynamically populate the form based on configuration
        await generateFormBlocks(); // Generates the form sections

        // Add event listener to player name input after form is generated
        const playerNameInput = document.querySelector('#input-1'); // Select the input with id-1
        if (playerNameInput) {
            playerNameInput.addEventListener('change', () => {
            const playerId = Number(playerNameInput.value);
            if (existingSubmissions.includes(playerId)) {
                alertContainer.classList.remove('d-none');
            } else {
                alertContainer.classList.add('d-none');
            }
            });
        }

        // Handle form submission
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default submission

            // Fetch form details
            const { data: formDetails, error: formDetailsError } = await supabase
            .from('form_details')
            .select('race_number, form_enabled')
            .eq('id', 1)
            .single();

            if (formDetailsError) {
            alert('Error fetching form details');
            console.error('Error fetching form details:', formDetailsError);
            return;
            }

            if (!formDetails.form_enabled) {
            alert('Form submissions are currently closed.');
            return;
            }

            // Collect form data
            const formData = new FormData(form);
            const playerId = Number(formData.get('input-1'));
            const raceNumber = formDetails.race_number;

            // Validate required fields
            for (const config of formConfig) {
            if (config.enabled) {
                const value = formData.get(`input-${config.id}`);
                if (!value) {
                alert(`Please fill out all required fields.`);
                return;
                }
            }
            }

            // Check if the player has already submitted predictions for this race
            if (existingSubmissions.includes(playerId)) {
            alertContainer.classList.remove('d-none');
            }

            // Prepare submission data
            const submissionData = {
            submission_time: new Date().toISOString(),
            race_number: raceNumber,
            player_id: playerId,
            };

            // Collect all form inputs
            for (let i = 2; i <= 28; i++) {
            submissionData[`form_id_${i}`] = formData.get(`input-${i}`);
            }

            // Save to Supabase (insert or update)
            let saveError;
            if (existingSubmissions.includes(playerId)) {
            const { error: updateError } = await supabase
                .from('form_raw')
                .update(submissionData)
                .eq('player_id', playerId)
                .eq('race_number', raceNumber);
            saveError = updateError;
            } else {
            const { error: insertError } = await supabase
                .from('form_raw')
                .insert([submissionData]);
            saveError = insertError;
            }

            if (saveError) {
            alert('Error saving form submission');
            console.error('Error saving form submission:', saveError);
            return;
            }

            // Store submission data in local storage
            localStorage.setItem('submissionData', JSON.stringify(submissionData));

            // Redirect to confirmation page
            window.location.href = '/confirmation';
        });
        });
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="/js/bootstrap.bundle.min.js"></script>
</body>
</html>
