<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Page Details 1 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script>
      (function() {
        const darkMode = localStorage.getItem('darkMode') === 'true';
        const cssFile = darkMode ? '/dark.css' : '/light.css';
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = cssFile;
        link.id = 'themeStylesheet';
        document.head.appendChild(link);
        console.log(`Loaded: ${cssFile}`);
      })();
    </script>
    <!-- Page Details 2 -->
    <link rel="icon" href="/media/f1_predictions_logo.ico" type="image/x-icon">
    <title>F1 Predictions | Admin</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/media/f1_predictions_logo.png">

    <!-- Supabase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        const supabaseUrl = 'https://mbyhlefxnjjzmiwsvnaa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ieWhsZWZ4bmpqem1pd3N2bmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzODQwOTgsImV4cCI6MjA0OTk2MDA5OH0.4gcUcOfhyTspbcDn6gPxBKFSTu3zUbkBdNEhMq9MdnY';
        var supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>

    <style>
        #password-input-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 200px);
            text-align: center;
        }
        #password-error {
            color: red;
            margin-top: 10px;
        }
        #admin-content {
            display: none;
        }
        html, body {
            overflow-x: hidden;
        }
        /* Unified progress component */
        .step-progress-wrap {
            display: none;
            margin-bottom: 1rem;
        }
        .step-progress-wrap.active {
            display: block;
        }
        .step-status-text {
            font-size: 0.875rem;
            color: #555;
            margin-top: 0.25rem;
            min-height: 1.25em;
        }
        .step-debug-log {
            font-size: 0.75rem;
            max-height: 150px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.5rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        /* Auto-expanding textareas */
        textarea.auto-expand {
            resize: none;
            overflow: hidden;
            min-height: 38px;
            line-height: 1.5;
            padding: 6px 12px;
        }
        /* Data freshness badge */
        .data-freshness {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        .data-freshness .badge {
            font-size: 0.7rem;
        }
    </style>

    <!-- Encryption Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- script.js import -->
    <script type="module" src="/script.js"></script>
</head>
<body>
    <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x" style="z-index: 9999;"></div>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
          <div class="container-fluid d-flex flex-wrap flex-lg-nowrap align-items-center">
            <button class="navbar-toggler d-lg-none order-1" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown"
              aria-expanded="false" aria-label="Toggle navigation">
              <span class="burger"><span></span><span></span><span></span></span>
            </button>
            <a class="navbar-brand mx-auto mx-lg-0 order-2 order-lg-1" href="/">
              <img src="/media/f1_predictions_logo.png" alt="Logo" width="45" height="45" class="me-2">
              <span class="fs-5 d-none d-lg-inline heading-text-11" style="margin-right: 8px">F1 Predictions</span>
            </a>
            <div class="d-flex align-items-center order-3 order-lg-3 ms-lg-auto account-controls">
              <div class="dropdown" id="avatarDropdownContainer">
                <a href="#" id="userDropdown" class="d-flex align-items-center text-decoration-none"
                  data-bs-toggle="dropdown" aria-expanded="false">
                  <div id="user-avatar" class="user-avatar" style="background-color: #ccc;"></div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown" id="logoutMenuItem">
                  <li id="loggedInUserDisplay" class="dropdown-item-text body-text" style="color: darkgrey;">
                    Logged in as <br><strong></strong>
                  </li>
                  <li><a class="dropdown-item body-text-xs" href="/account">Account</a></li>
                  <li>
                    <div class="dropdown-item no-highlight">
                      <div class="form-check form-switch" style="line-height: 2; vertical-align: middle;">
                        <input class="form-check-input" type="checkbox" id="darkModeToggle" style="margin-top: 0.5rem">
                        <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
                      </div>
                    </div>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item body-text-xs" href="#" id="logoutBtn">Log Out</a></li>
                </ul>
              </div>
              <button id="loginButton" type="button" class="btn btn-outline-dark ms-2 text-nowrap d-none"
                data-bs-toggle="modal" data-bs-target="#loginModal">Log In</button>
            </div>
            <div class="collapse navbar-collapse order-4 w-100 order-lg-2 w-lg-auto" id="navbarNavDropdown">
              <ul class="navbar-nav mx-auto mx-lg-0">
                <li class="nav-item"><a class="nav-link body-text-xs" href="/form">Form</a></li>
                <li class="nav-item"><a class="nav-link body-text-xs" href="/teams">Teams</a></li>
                <li class="nav-item"><a class="nav-link body-text-xs" href="/results">Results</a></li>
                <li class="nav-item"><a class="nav-link body-text-xs" href="/register">Register</a></li>
                <li class="nav-item"><a class="nav-link body-text-xs" href="/feedback">Feedback</a></li>
                <li class="nav-item"><a class="nav-link body-text-xs" href="/info">Info</a></li>
                <li class="nav-item"><a class="nav-link body-text-xs" href="/minigames">Minigames</a></li>
              </ul>
            </div>
          </div>
        </nav>
    </header>

    <main id="password-input-section">
        <h4 class="heading-text-3">Admin Page</h4>
        <input type="password" id="password-input" class="form-control w-25 text-center" placeholder="Enter Password">
        <button id="login-button" class="btn btn-dark mt-3" onclick="validatePassword()">Submit</button>
        <p id="password-error" style="display: none;">Incorrect Password. Please try again.</p>
    </main>

    <main id="admin-content" class="container my-5">
        <div class="d-flex justify-content-left">
            <h2 class="mb-3 heading-text-2">Admin</h2>
        </div>

        <!-- Information Dashboard -->
        <div class="container mt-4">
            <div class="card">
              <div class="card-header">Information Dashboard</div>
              <div class="card-body">
                <form id="dashboard-form">
                  <div class="row mb-2">
                    <div class="col-md-6">
                      <label for="race-select" class="form-label">Current Race</label>
                      <select class="form-select" id="race-select"></select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Number of Form Responses</label>
                      <p id="form-responses" class="form-text">Loading...</p>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-md-6">
                      <label class="form-label">Form Status</label>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="form-status">
                        <label class="form-check-label" for="form-status" id="form-status-label">Loading...</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="current-year" class="form-label">Current Year</label>
                      <input type="number" class="form-control" id="current-year" min="2000" max="2100">
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-md-6">
                      <label class="form-label">Main Page Alert Text</label>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="main-page-alert-enabled">
                        <label class="form-check-label" for="main-page-alert-enabled" id="main-page-alert-enabled-label">Loading...</label>
                      </div>
                      <textarea class="form-control auto-expand" id="main-page-alert-text-input" rows="1" placeholder="Enter main page alert HTML"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="main-page-alert-type-select" class="form-label">Main Page Alert Type</label>
                      <select class="form-select" id="main-page-alert-type-select">
                        <option value="primary">Primary</option>
                        <option value="secondary">Secondary</option>
                        <option value="success">Success</option>
                        <option value="danger">Danger</option>
                        <option value="warning">Warning</option>
                        <option value="info" selected>Info</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-md-6">
                      <label class="form-label">Form Status Text</label>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="form-status-text-enabled">
                        <label class="form-check-label" for="form-status-text-enabled" id="form-status-text-enabled-label">Loading...</label>
                      </div>
                      <input type="text" class="form-control" id="form-status-text">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Form Alert Text</label>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="form-alert-text-enabled">
                        <label class="form-check-label" for="form-alert-text-enabled" id="form-alert-text-enabled-label">Loading...</label>
                      </div>
                      <input type="text" class="form-control" id="form-alert-text-input">
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-md-6">
                      <label for="results-display-race-select" class="form-label">Results Display Race</label>
                      <select class="form-select" id="results-display-race-select"></select>
                    </div>
                    <div class="col-md-6">
                      <label for="results-display-type-select" class="form-label">Results Display Type</label>
                      <select class="form-select" id="results-display-type-select">
                        <option value="Scored Results">Scored Results</option>
                        <option value="Unscored Predictions">Unscored Predictions</option>
                        <option value="No Display">No Display</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-md-6">
                      <label for="background-image-select" class="form-label">Main Page Background</label>
                      <select class="form-select" id="background-image-select">
                        <option value="background_australia.png">Australia</option>
                        <option value="background_monaco.png">Monaco</option>
                        <option value="background_spa.png">Spa</option>
                        <option value="background_ferrari.png">Ferrari</option>
                        <option value="background_redbull.png">Red Bull</option>
                        <option value="background_oscar.png">Oscar</option>
                      </select>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary" id="save-changes" disabled>Save Changes</button>
                </form>
              </div>
            </div>
        </div>

        <div>
        <hr>

        <ul class="nav nav-underline mb-4" id="tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="form-configuration-tab" data-bs-toggle="tab" href="#form-configuration" role="tab">Form Configuration</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="grid-upload-tab" data-bs-toggle="tab" href="#grid-upload" role="tab">Grid Upload</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="results-entry-tab" data-bs-toggle="tab" href="#results-entry" role="tab">Results Entry</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="scoring-tab" data-bs-toggle="tab" href="#scoring" role="tab">Scoring</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="season-player-tab" data-bs-toggle="tab" href="#season-player" role="tab">Season Player</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="season-team-tab" data-bs-toggle="tab" href="#season-team" role="tab">Season Team</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="casino-tab" data-bs-toggle="tab" href="#casino" role="tab">Casino</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="feedback-tab" data-bs-toggle="tab" href="#feedback" role="tab">Feedback</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="edit-lists-dropdown" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Edit Lists</a>
                <ul class="dropdown-menu" aria-labelledby="edit-lists-dropdown">
                    <li><a class="dropdown-item" id="edit-players-tab" data-bs-toggle="tab" href="#edit-players" role="tab">Edit Players</a></li>
                    <li><a class="dropdown-item" id="edit-teams-tab" data-bs-toggle="tab" href="#edit-teams" role="tab">Edit Teams</a></li>
                    <li><a class="dropdown-item" id="edit-drivers-tab" data-bs-toggle="tab" href="#edit-drivers" role="tab">Edit Drivers</a></li>
                    <li><a class="dropdown-item" id="edit-constructors-tab" data-bs-toggle="tab" href="#edit-constructors" role="tab">Edit Constructors</a></li>
                    <li><a class="dropdown-item" id="edit-calendar-tab" data-bs-toggle="tab" href="#edit-calendar" role="tab">Edit Calendar</a></li>
                </ul>
            </li>
        </ul>

        <div class="tab-content" id="tab-content">

            <!-- Form Configuration Tab -->
            <div id="form-configuration" class="tab-pane fade show active" role="tabpanel">
                <form id="form-configuration-form">
                <div><h4 class="mb-3 heading-text-3">Form Configuration</h4></div>
                <div class="mb-3">
                    <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enableFixedEditing">
                    <label class="form-check-label" for="enableFixedEditing">Enable fixed question editing</label>
                    </div>
                </div>
                <div class="table-responsive" style="overflow-x: auto; max-width: 100%;">
                    <table class="table">
                    <thead>
                        <tr>
                        <th>ID</th><th>Enabled</th><th>Text</th><th>Response Type</th><th>Scoring Type</th>
                        </tr>
                    </thead>
                    <tbody id="form-configuration-rows"></tbody>
                    </table>
                </div>
                <button id="saveChangesButton" class="btn btn-primary" disabled>Save Changes</button>
                </form>
            </div>

            <!-- Results Entry Tab -->
            <div id="results-entry" class="tab-pane fade" role="tabpanel">
                <h4 id="results-entry-title" class="mb-1 heading-text-3">Results Entry</h4>
                <!-- Last submission info -->
                <div id="results-last-submitted" class="data-freshness mb-2" style="display:none;">
                    Last submitted: <span id="results-last-submitted-time"></span>
                </div>
                <div id="formLoading" class="loading-indicator mb-3 heading-text-3" style="display: none;">
                    Form loading...
                    <div class="loading-bar"></div>
                </div>
                <div id="repeated-results-alert" class="alert alert-warning d-none" role="alert">
                    Results have already been submitted for this race. Submitting again will override the previous entry.
                </div>
                <form id="results-form">
                    <div id="form-section-1" style="display: none;"></div>
                    <div id="form-section-2"></div>
                    <div id="form-section-3"></div>
                    <div id="form-section-4"></div>
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary">Submit Results</button>
                    </div>
                </form>
            </div>

            <!-- Grid Upload Tab -->
            <div id="grid-upload" class="tab-pane fade" role="tabpanel">
                <h4 class="mb-3 heading-text-3">Grid Upload</h4>
                <div>
                    <p>Current Photo:</p>
                    <img id="currentGridImage" src="" alt="Current Grid Image" style="max-width: 100%; max-height: 150px; height: auto; margin-bottom: 10px;" />
                </div>
                <div class="input-group mb-3">
                    <input type="file" class="form-control" id="gridImageInput" accept="image/*">
                    <button class="btn btn-primary" id="uploadGridImageButton">Upload</button>
                </div>
                <p id="uploadStatus"></p>
            </div>

            <!-- Scoring Tab -->
            <div id="scoring" class="tab-pane fade" role="tabpanel" aria-labelledby="scoring-tab">
                <h4 class="mb-1 heading-text-3">Scoring</h4>
                <div id="scoring-freshness" class="data-freshness mb-2">
                    Data loaded at: <span id="scoring-loaded-at">—</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" id="scoring-refresh-btn">Refresh</button>
                </div>
                <ul id="raceInfo" class="list-group mb-3"></ul>
                <button id="scoreRoundButton" class="btn btn-primary mb-3">Score Round</button>
                <!-- Unified progress component -->
                <div class="step-progress-wrap" id="scoring-progress-wrap">
                    <div class="progress mb-1">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="step-status-text" id="scoring-status-text"></div>
                    <details class="mt-1">
                        <summary class="text-muted" style="font-size:0.75rem; cursor:pointer;">Debug log</summary>
                        <div class="step-debug-log" id="progressUpdates"></div>
                    </details>
                </div>
                <table id="scoreTable" class="table table-striped">
                    <thead><tr><th>Player</th><th>Grand Total</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Season Player Tab -->
            <div id="season-player" class="tab-pane fade" role="tabpanel">
                <h4 class="mb-1 heading-text-3">Season Player</h4>
                <div id="season-player-freshness" class="data-freshness mb-2">
                    Data loaded at: <span id="season-player-loaded-at">—</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" id="season-player-refresh-btn">Refresh</button>
                </div>
                <div class="container">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="current-year-season-player" class="form-label">Year</label>
                      <input type="text" id="current-year-season-player" class="form-control" readonly>
                      <label for="race-select-season-player" class="form-label mt-2">Select Race</label>
                      <select id="race-select-season-player" class="form-select"></select>
                    </div>
                    <div class="col-md-6">
                      <label for="race-info" class="form-label">Race Info</label>
                      <div id="race-info" class="border p-2" style="min-height: 60px;"></div>
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col">
                      <button id="update-season-player" class="btn btn-primary">Add Race to Season Player</button>
                    </div>
                  </div>
                  <!-- Unified progress component -->
                  <div class="step-progress-wrap" id="season-player-progress-wrap">
                      <div class="progress mb-1">
                          <div id="season-player-progress-bar" class="progress-bar" role="progressbar"
                              style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <div class="step-status-text" id="season-player-status-text"></div>
                      <details class="mt-1">
                          <summary class="text-muted" style="font-size:0.75rem; cursor:pointer;">Debug log</summary>
                          <div class="step-debug-log" id="season-player-debug-log"></div>
                      </details>
                  </div>
                  <ul id="totals-list" class="list-group"></ul>
                </div>
            </div>

            <!-- Season Team Tab -->
            <div id="season-team" class="tab-pane fade" role="tabpanel">
                <h4 class="mb-1 heading-text-3">Season Team</h4>
                <div id="season-team-freshness" class="data-freshness mb-2">
                    Data loaded at: <span id="season-team-loaded-at">—</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" id="season-team-refresh-btn">Refresh</button>
                </div>
                <div class="container">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="current-year-season-team" class="form-label">Year</label>
                        <input type="text" id="current-year-season-team" class="form-control" readonly>
                        <label for="race-select-season-team" class="form-label mt-2">Select Race</label>
                        <select id="race-select-season-team" class="form-select"></select>
                        <label for="raceType" class="form-label mt-2">Race Type:</label>
                        <select id="raceType" class="form-select">
                            <option value="card">Card Race</option>
                            <option value="casino">Casino Race</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="race-info-season-team" class="form-label">Race Info</label>
                        <div id="race-info-season-team" class="border p-2" style="min-height: 60px;"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <button id="update-season-season-team" class="btn btn-primary">Add Race to Team Scoring</button>
                    </div>
                </div>
                <!-- Unified progress for Team Scoring -->
                <div class="step-progress-wrap" id="season-team-scoring-progress-wrap">
                    <div class="progress mb-1">
                        <div id="season-team-scoring-bar" class="progress-bar" role="progressbar"
                            style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="step-status-text" id="season-team-scoring-status"></div>
                    <details class="mt-1">
                        <summary class="text-muted" style="font-size:0.75rem; cursor:pointer;">Debug log</summary>
                        <div class="step-debug-log" id="season-team-scoring-log"></div>
                    </details>
                </div>
                <ul id="totals-list-season-team" class="list-group mb-3"></ul>

                <div class="row mb-3">
                    <div class="col">
                        <button id="update-season-team-summary" class="btn btn-primary">Add Race to Season Team</button>
                    </div>
                </div>
                <!-- Unified progress for Season Team Summary -->
                <div class="step-progress-wrap" id="season-team-summary-progress-wrap">
                    <div class="progress mb-1">
                        <div id="season-team-summary-bar" class="progress-bar" role="progressbar"
                            style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="step-status-text" id="season-team-summary-status"></div>
                    <details class="mt-1">
                        <summary class="text-muted" style="font-size:0.75rem; cursor:pointer;">Debug log</summary>
                        <div class="step-debug-log" id="season-team-summary-log"></div>
                    </details>
                </div>
                </div>
            </div>

            <!-- Casino Tab -->
            <div id="casino" class="tab-pane fade show" role="tabpanel">
                <h4 class="mb-3 heading-text-3">Card/Casino Switch</h4>
                <div class="card">
                    <div class="card-header">Card/Casino Switch</div>
                    <div class="card-body">
                        <form id="casino-dashboard-form">
                            <label class="form-label">Casino Enabled</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="casino-status">
                                <label class="form-check-label" id="casino-status-label">Loading...</label>
                            </div>
                            <button type="submit" class="btn btn-primary" id="save-changes-casino-dashboard" disabled>Save Changes</button>
                        </form>
                    </div>
                </div>
                <div style="margin-top: 10px">
                    <form id="casino-form">
                        <h4 class="mb-3 heading-text-3">Casino</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Bet #</th><th>Enabled</th><th>Question</th>
                                    <th>Odds 1:N</th><th>Max Bet</th><th>Will Pay Out</th>
                                </tr>
                            </thead>
                            <tbody id="casino-rows"></tbody>
                        </table>
                        <button id="saveChangesButtonCasino" class="btn btn-primary" disabled>Save Changes</button>
                    </form>
                </div>
            </div>

            <!-- Feedback Tab -->
            <div id="feedback" class="tab-pane fade" role="tabpanel">
                <h4 class="mb-3 heading-text-3">Feedback</h4>
                <div id="feedback-cards" class="mt-3"></div>
            </div>

            <!-- Edit Players -->
            <div class="tab-pane fade" id="edit-players" role="tabpanel" aria-labelledby="edit-players-tab">
                <h4 class="mb-3 heading-text-3">Edit Players</h4>
                <table class="table">
                    <thead><tr><th>ID</th><th>Name</th><th>Team</th><th>Password</th><th>Actions</th></tr></thead>
                    <tbody id="players-table"></tbody>
                </table>
            </div>

            <!-- Edit Teams -->
            <div class="tab-pane fade" id="edit-teams" role="tabpanel" aria-labelledby="edit-teams-tab">
                <h4 class="mb-3 heading-text-3">Edit Teams</h4>
                <table class="table">
                    <thead><tr><th>ID</th><th>Name</th><th>Actions</th></tr></thead>
                    <tbody id="teams-table"></tbody>
                </table>
            </div>

            <!-- Edit Drivers -->
            <div class="tab-pane fade" id="edit-drivers" role="tabpanel" aria-labelledby="edit-drivers-tab">
                <h4 class="mb-3 heading-text-3">Edit Drivers</h4>
                <table class="table">
                    <thead><tr><th>ID</th><th>Name</th><th>Abbreviation</th><th>Constructor</th><th>Actions</th></tr></thead>
                    <tbody id="drivers-table"></tbody>
                </table>
                <button class="btn btn-primary" id="save-drivers">Save Changes</button>
                <h5>Add Driver</h5>
                <div>
                    <input type="text" id="new-driver-name" placeholder="Name">
                    <input type="text" id="new-driver-abbr" placeholder="Abbreviation">
                    <select id="new-driver-constructor"></select>
                    <button class="btn btn-success" id="add-driver">Add Driver</button>
                </div>
            </div>

            <!-- Edit Constructors -->
            <div class="tab-pane fade" id="edit-constructors" role="tabpanel" aria-labelledby="edit-constructors-tab">
                <h4 class="mb-3 heading-text-3">Edit Constructors</h4>
                <table class="table">
                    <thead><tr><th>ID</th><th>Name</th><th>Background Colour</th><th>Text Colour</th><th>Actions</th></tr></thead>
                    <tbody id="constructors-table"></tbody>
                </table>
                <button class="btn btn-primary" id="save-constructors">Save Changes</button>
                <h5>Add Constructor</h5>
                <div>
                    <input type="text" id="new-constructor-name" placeholder="Name">
                    <input type="text" id="new-constructor-bg" placeholder="Background Colour">
                    <input type="text" id="new-constructor-text" placeholder="Text Colour">
                    <button class="btn btn-success" id="add-constructor">Add Constructor</button>
                </div>
            </div>

            <!-- Edit Calendar -->
            <div class="tab-pane fade" id="edit-calendar" role="tabpanel" aria-labelledby="edit-calendar-tab">
                <h4 class="mb-3 heading-text-3">Edit Calendar</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th><th>Race Number</th><th>Race Name</th><th>Country</th>
                            <th>Date & Time (UTC+<span id="utc-offset"></span>)</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-table"></tbody>
                </table>
                <button class="btn btn-primary" id="save-calendar">Save Changes</button>
                <h5>Add Race</h5>
                <div>
                    <input type="number" id="new-race-number" placeholder="Race Number" class="form-control-inline">
                    <input type="text" id="new-race-name" placeholder="Race Name" class="form-control-inline">
                    <input type="text" id="new-race-country" placeholder="Country" class="form-control-inline">
                    <input type="datetime-local" id="new-race-date" step="1" class="form-control-inline">
                    <button class="btn btn-success" id="add-race">Add Race</button>
                </div>
            </div>
        </div>

        <!-- Results Entry: Confirmation Modal -->
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmationModalLabel">Submission Successful</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">The results have been successfully submitted.</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main>
        <!-- LOGIN MODAL -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title heading-text-3" id="loginModalLabel">Log In</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="login-form">
                    <div class="mb-3">
                      <label for="login-player-name" class="form-label">Name:</label>
                      <input list="players-list" id="login-player-name" class="form-control" required />
                      <datalist id="players-list"></datalist>
                    </div>
                    <div class="mb-3">
                      <label for="login-pin" class="form-label">PIN:</label>
                      <input type="password" id="login-pin" class="form-control" maxlength="4" pattern="\d*" inputmode="numeric" required />
                    </div>
                    <div class="mb-3">
                      <label for="rememberMe" class="form-check-label">
                        <input type="checkbox" id="rememberMe" class="form-check-input" />
                        Keep me logged in for 30 days
                      </label>
                    </div>
                    <div class="d-grid gap-2 col-6 mx-auto">
                        <button type="submit" class="btn btn-primary" disabled>Log In</button>
                    </div>
                    <hr>
                    <div class="mb-3">Create an account on the <a href="/register">Register Page</a>.</div>
                    <div class="mb-3">Forgot password? Visit the <a href="/account">Account Page</a>.</div>
                  </form>
                </div>
              </div>
            </div>
        </div>

        <!-- Custom Alert Modal -->
        <div class="modal fade" id="customAlertModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-body"></div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
              </div>
            </div>
        </div>

        <!-- Custom Confirm Modal -->
        <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="customConfirmModalLabel">Confirm</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-dark" id="customConfirmCancel" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" id="customConfirmOk">OK</button>
                </div>
              </div>
            </div>
        </div>
    </main>

    <footer class="bg-light text-black text-center py-1 body-text-xs">
        <p>&copy; 2025 F1 Predictions Form | Build 240</p>
    </footer>

<script src="/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { getCookie, showCustomAlert, showCustomConfirm, generateFormBlocks } from '/script.js';

    // ============================================================
    // === SHARED UTILITIES
    // ============================================================

    /** Fetch all rows from a Supabase table */
    async function getTable(tableName) {
        const { data, error } = await supabase.from(tableName).select('*');
        if (error) {
            console.error(`Error retrieving data from ${tableName}:`, error.message);
            return [];
        }
        return data;
    }

    /** Generic fetch ordered by id */
    async function fetchData(table) {
        const { data, error } = await supabase.from(table).select('*').order('id', { ascending: true });
        if (error) { console.error(`Error fetching ${table}:`, error); return []; }
        return data;
    }

    async function updateData(table, id, updates) {
        const { error } = await supabase.from(table).update(updates).eq('id', id);
        if (error) { console.error(`Error updating ${table} ID ${id}:`, error); return false; }
        return true;
    }

    async function deleteData(table, id) {
        const { error } = await supabase.from(table).delete().eq('id', id);
        if (error) { console.error(`Error deleting from ${table} ID ${id}:`, error); return false; }
        return true;
    }

    async function insertData(table, data) {
        const { error } = await supabase.from(table).insert(data);
        if (error) { console.error(`Error inserting into ${table}:`, error); return false; }
        return true;
    }

    function enableUpdateButton(inputId, buttonId, originalValue) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        input.addEventListener('input', () => {
            button.disabled = input.value.trim() === originalValue.trim();
        });
    }

    /** Format current time as HH:MM:SS */
    function nowTimestamp() {
        return new Date().toLocaleTimeString();
    }

    /** Set a freshness badge to current time */
    function markFresh(spanId) {
        const el = document.getElementById(spanId);
        if (el) el.textContent = nowTimestamp();
    }

    // ============================================================
    // === UNIFIED PROGRESS HELPERS
    // ============================================================

    /**
     * Progress controller for a step.
     * @param {string} wrapId   - id of the .step-progress-wrap div
     * @param {string} barId    - id of the progress-bar div
     * @param {string} statusId - id of the .step-status-text div
     * @param {string} logId    - id of the .step-debug-log div
     */
    function makeProgress(wrapId, barId, statusId, logId) {
        const wrap = document.getElementById(wrapId);
        const bar  = document.getElementById(barId);
        const status = document.getElementById(statusId);
        const log  = document.getElementById(logId);

        return {
            show() { wrap.classList.add('active'); },
            hide() { wrap.classList.remove('active'); },
            reset() {
                if (bar) { bar.style.width = '0%'; bar.setAttribute('aria-valuenow', 0); }
                if (status) status.textContent = '';
                if (log) log.textContent = '';
                wrap.classList.add('active');
            },
            setPercent(pct) {
                const v = Math.min(100, Math.max(0, Math.round(pct)));
                if (bar) { bar.style.width = `${v}%`; bar.setAttribute('aria-valuenow', v); }
            },
            setStatus(msg) {
                if (status) status.textContent = msg;
            },
            log(msg) {
                console.log(msg);
                if (log) log.textContent += msg + '\n';
            },
            done(msg) {
                this.setPercent(100);
                this.setStatus(msg || 'Complete.');
            }
        };
    }

    // ============================================================
    // === AUTO-EXPANDING TEXTAREAS
    // ============================================================

    function initAutoExpand(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }
    document.addEventListener('input', e => {
        if (e.target.classList.contains('auto-expand')) initAutoExpand(e.target);
    });
    // Expand any textareas already in the DOM on load
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('textarea.auto-expand').forEach(initAutoExpand);
    });
    // Also expand dynamically injected textareas (form config rows) when rendered
    function expandNewTextareas(container) {
        container.querySelectorAll('textarea.auto-expand').forEach(initAutoExpand);
    }

    // ============================================================
    // === AUTO LOGIN / PASSWORD
    // ============================================================

    function checkAdminCookie(retries = 10, delay = 500) {
        if (getCookie("playerId") === "1") {
            document.getElementById("password-input-section").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
        } else if (retries > 0) {
            setTimeout(() => checkAdminCookie(retries - 1, delay), delay);
        }
    }
    checkAdminCookie();
    window.addEventListener("DOMContentLoaded", () => checkAdminCookie());

    const hashedPassword = "4e668929edb3bf915e1a3a9d96c3c97e";

    function validatePassword() {
        const inputPassword = document.getElementById("password-input").value.trim();
        const hashedInputPassword = CryptoJS.MD5(inputPassword).toString();
        if (hashedInputPassword === hashedPassword) {
            document.getElementById("password-input-section").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
        } else {
            const errorElement = document.getElementById("password-error");
            errorElement.style.display = "block";
            setTimeout(() => { errorElement.style.display = "none"; }, 3000);
        }
    }
    window.validatePassword = validatePassword;

    // ============================================================
    // === FORM CONFIGURATION TAB
    // ============================================================

    async function fetchAndRenderFormConfiguration() {
        const { data, error } = await supabase
            .from('form_configuration').select('*').order('id', { ascending: true });
        if (error) { console.error('Error fetching data:', error); return; }

        const rowsContainer = document.getElementById('form-configuration-rows');
        rowsContainer.innerHTML = '';
        const enableFixed = document.getElementById('enableFixedEditing')?.checked;

        data.forEach(row => {
            const isFixed = (row.id >= 1 && row.id <= 7) || row.id === 28;
            const disableAttr = isFixed && !enableFixed ? "disabled" : "";
            rowsContainer.innerHTML += `
            <tr>
                <td>${row.id}</td>
                <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="enabledSwitch${row.id}" ${row.enabled ? 'checked' : ''} ${disableAttr}>
                </div>
                </td>
                <td><textarea class="form-control auto-expand" id="text${row.id}" rows="1" ${disableAttr}>${row.text}</textarea></td>
                <td>
                <select class="form-select" id="responseType${row.id}" ${disableAttr}>
                    <option value="Select - Driver List" ${row.response_type === 'Select - Driver List' ? 'selected' : ''}>Select - Driver List</option>
                    <option value="Select - Driver List + DNF" ${row.response_type === 'Select - Driver List + DNF' ? 'selected' : ''}>Select - Driver List + DNF</option>
                    <option value="Select - Team List" ${row.response_type === 'Select - Team List' ? 'selected' : ''}>Select - Team List</option>
                    <option value="Select - Name List" ${row.response_type === 'Select - Name List' ? 'selected' : ''}>Select - Name List</option>
                    <option value="Number - Integer (0 - 20)" ${row.response_type === 'Number - Integer (0 - 20)' ? 'selected' : ''}>Number - Integer (0 - 20)</option>
                    <option value="Number - Integer (0 - 1000)" ${row.response_type === 'Number - Integer (0 - 1000)' ? 'selected' : ''}>Number - Integer (0 - 1000)</option>
                    <option value="Number - Decimal" ${row.response_type === 'Number - Decimal' ? 'selected' : ''}>Number - Decimal</option>
                    <option value="Radio - Yes/No" ${row.response_type === 'Radio - Yes/No' ? 'selected' : ''}>Radio - Yes/No</option>
                    <option value="Radio - Heads/Tails" ${row.response_type === 'Radio - Heads/Tails' ? 'selected' : ''}>Radio - Heads/Tails</option>
                </select>
                </td>
                <td>
                <select class="form-select" id="scoringType${row.id}" ${disableAttr}>
                    <option value="P1 Type (3)" ${row.scoring_type === 'P1 Type (3)' ? 'selected' : ''}>P1 Type (3)</option>
                    <option value="P2 Type (2)" ${row.scoring_type === 'P2 Type (2)' ? 'selected' : ''}>P2 Type (2)</option>
                    <option value="P3 Type (2)" ${row.scoring_type === 'P3 Type (2)' ? 'selected' : ''}>P3 Type (2)</option>
                    <option value="P4 Type (2)" ${row.scoring_type === 'P4 Type (2)' ? 'selected' : ''}>P4 Type (2)</option>
                    <option value="P5 Type (2)" ${row.scoring_type === 'P5 Type (2)' ? 'selected' : ''}>P5 Type (2)</option>
                    <option value="P6 Type (2)" ${row.scoring_type === 'P6 Type (2)' ? 'selected' : ''}>P6 Type (2)</option>
                    <option value="Simple (1)" ${row.scoring_type === 'Simple (1)' ? 'selected' : ''}>Simple (1)</option>
                    <option value="Driver + Team (2)" ${row.scoring_type === 'Driver + Team (2)' ? 'selected' : ''}>Driver + Team (2)</option>
                    <option value="Closest (1)" ${row.scoring_type === 'Closest (1)' ? 'selected' : ''}>Closest (1)</option>
                    <option value="Plus Minus One (2)" ${row.scoring_type === 'Plus Minus One (2)' ? 'selected' : ''}>Plus Minus One (2)</option>
                    <option value="Off (0)" ${row.scoring_type === 'Off (0)' ? 'selected' : ''}>Off (0)</option>
                </select>
                </td>
            </tr>`;
        });
        // Size any auto-expand textareas that were just injected
        expandNewTextareas(rowsContainer);
    }

    document.addEventListener('DOMContentLoaded', fetchAndRenderFormConfiguration);

    document.getElementById('enableFixedEditing')?.addEventListener('change', function() {
        const fixedIds = [1,2,3,4,5,6,7,28];
        fixedIds.forEach(id => {
            ['enabledSwitch','text','responseType','scoringType'].forEach(prefix => {
                const el = document.getElementById(`${prefix}${id}`);
                if (el) el.disabled = !this.checked;
            });
        });
    });

    function initializeSaveChangesButton() {
        const saveButton = document.querySelector('#saveChangesButton');
        const form = document.querySelector('#form-configuration-form');
        saveButton.disabled = true;
        form.addEventListener('input', () => { saveButton.disabled = false; });

        saveButton.addEventListener('click', async (event) => {
            event.preventDefault();
            const rows = Array.from(document.querySelectorAll('#form-configuration-rows tr'));
            const updates = rows.map(row => {
                const id = parseInt(row.children[0].textContent.trim());
                return {
                    id,
                    enabled: row.querySelector('input[type="checkbox"]').checked,
                    text: row.querySelector('textarea').value.trim(),
                    response_type: row.querySelector('td:nth-child(4) select').value,
                    scoring_type: row.querySelector('td:nth-child(5) select').value,
                };
            });

            const { error } = await supabase
                .from('form_configuration').upsert(updates, { onConflict: 'id' });
            if (error) {
                console.error('Error saving changes:', error);
                showCustomAlert('An error occurred while saving changes.');
                return;
            }
            saveButton.disabled = true;
            showCustomAlert('Changes saved successfully!');
        });
    }
    initializeSaveChangesButton();

    // ============================================================
    // === GRID UPLOAD TAB
    // ============================================================

    document.addEventListener("DOMContentLoaded", async () => {
        const bucketName = "media";
        const currentGridImage = document.getElementById("currentGridImage");
        const uploadStatus = document.getElementById("uploadStatus");

        async function loadGridImage() {
            const { data: formData, error: formError } = await supabase
                .from("form_details").select("form_image_name").eq("id", 1).single();
            if (formError || !formData?.form_image_name) {
                currentGridImage.src = ""; return;
            }
            const { data: fileData, error: downloadError } = await supabase.storage
                .from(bucketName).download(formData.form_image_name);
            if (!downloadError) currentGridImage.src = URL.createObjectURL(fileData);
        }

        document.getElementById("uploadGridImageButton").addEventListener("click", async () => {
            const input = document.getElementById("gridImageInput");
            if (!input.files.length) { uploadStatus.textContent = "Please select an image to upload."; return; }
            const file = input.files[0];
            const ext = file.name.split(".").pop().toLowerCase();
            const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
            const finalFileName = `starting_grid_${timestamp}.${ext}`;
            uploadStatus.textContent = "Uploading...";
            const { error: uploadError } = await supabase.storage.from(bucketName).upload(finalFileName, file, { upsert: true });
            if (uploadError) { uploadStatus.textContent = "Upload failed."; return; }
            uploadStatus.textContent = "Upload successful!";
            await supabase.from("form_details").update({ form_image_name: finalFileName }).eq("id", 1);
            await loadGridImage();
        });
        await loadGridImage();
    });

    // ============================================================
    // === RESULTS ENTRY TAB
    // ============================================================

    document.addEventListener('DOMContentLoaded', async () => {
        await updateResultsEntryTitle();

        const form = document.getElementById('results-form');
        let existingSubmissions = [];
        let formConfig = [];
        let currentRaceNumberForResults;

        async function fetchFormConfigForResults() {
            const { data, error } = await supabase.from('form_configuration').select('id, enabled');
            if (!error) formConfig = data;
        }

        async function loadResultsEntryData() {
            await fetchFormConfigForResults();

            const { data: formDetails, error: fdErr } = await supabase
                .from('form_details').select('race_number').eq('id', 1).single();
            if (fdErr) { console.error(fdErr); return; }
            currentRaceNumberForResults = formDetails.race_number;

            // Check for existing results submission (player_id = 0)
            const { data: submissions } = await supabase
                .from('form_raw')
                .select('player_id, submission_time')
                .eq('race_number', currentRaceNumberForResults);

            existingSubmissions = (submissions || []).map(s => s.player_id);

            if (existingSubmissions.includes(0)) {
                document.getElementById('repeated-results-alert').classList.remove('d-none');
                // Show last submission timestamp
                const resultEntry = submissions.find(s => s.player_id === 0);
                if (resultEntry?.submission_time) {
                    const ts = new Date(resultEntry.submission_time).toLocaleString();
                    document.getElementById('results-last-submitted-time').textContent = ts;
                    document.getElementById('results-last-submitted').style.display = 'block';
                }
            } else {
                document.getElementById('repeated-results-alert').classList.add('d-none');
                document.getElementById('results-last-submitted').style.display = 'none';
            }

            // Generate form blocks
            const loadingIndicator = document.getElementById('formLoading');
            loadingIndicator.style.display = 'block';
            await generateFormBlocks();
            loadingIndicator.style.display = 'none';

            // Autofill with existing results if present
            if (existingSubmissions.includes(0)) {
                await autofillResultsForm(currentRaceNumberForResults);
            }
        }

        /** Pre-fill the generated form inputs with the previously saved results */
        async function autofillResultsForm(raceNumber) {
            const { data: resultRow, error } = await supabase
                .from('form_raw')
                .select('*')
                .eq('race_number', raceNumber)
                .eq('player_id', 0)
                .single();
            if (error || !resultRow) return;

            for (let i = 2; i <= 28; i++) {
                const val = resultRow[`form_id_${i}`];
                if (val === null || val === undefined) continue;

                const inputName = `input-${i}`;
                const inputs = form.querySelectorAll(`[name="${inputName}"]`);

                if (inputs.length === 1) {
                    const el = inputs[0];
                    if (el.tagName === 'SELECT') {
                        el.value = val;
                        // Fire change event so colour styling (applied by generateFormBlocks) triggers
                        el.dispatchEvent(new Event('change', { bubbles: true }));
                    } else {
                        el.value = val;
                        el.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                } else if (inputs.length > 1) {
                    // Radio buttons
                    inputs.forEach(radio => {
                        if (radio.value === val) {
                            radio.checked = true;
                            // Fire change so any styling listeners on the radio group activate
                            radio.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                }
            }
        }

        await loadResultsEntryData();

        // Reload Results Entry data when tab is activated
        document.getElementById('results-entry-tab').addEventListener('shown.bs.tab', async () => {
            await loadResultsEntryData();
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const { data: formDetails, error: fdErr } = await supabase
                .from('form_details').select('race_number, form_enabled').eq('id', 1).single();
            if (fdErr) { showCustomAlert('Error fetching form details'); return; }
            if (!formDetails.form_enabled) { showCustomAlert('Form submissions are currently closed.'); return; }

            const formData = new FormData(form);
            const playerId = 0;
            const raceNumber = formDetails.race_number;

            for (const config of formConfig) {
                if (config.enabled && config.id !== 1) {
                    const value = formData.get(`input-${config.id}`);
                    if (!value) { showCustomAlert(`Please fill out all required fields.`); return; }
                }
            }

            const submissionData = {
                submission_time: new Date().toISOString(),
                race_number: raceNumber,
                player_id: playerId,
            };
            for (let i = 2; i <= 28; i++) {
                submissionData[`form_id_${i}`] = formData.get(`input-${i}`);
            }

            let saveError;
            if (existingSubmissions.includes(playerId)) {
                const { error } = await supabase.from('form_raw')
                    .update(submissionData).eq('player_id', playerId).eq('race_number', raceNumber);
                saveError = error;
            } else {
                const { error } = await supabase.from('form_raw').insert([submissionData]);
                saveError = error;
            }

            if (saveError) { showCustomAlert('Error saving form submission'); return; }

            // Refresh the form to a clean state
            await loadResultsEntryData();

            // Trigger a data refresh on the Scoring tab so it's ready
            await refreshScoringData();

            const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            confirmationModal.show();
        });
    });

    async function updateResultsEntryTitle() {
        try {
            const { data: formDetails } = await supabase
                .from('form_details').select('race_number').eq('id', 1).single();
            const { data: raceDetails } = await supabase
                .from('calendar').select('name').eq('race_number', formDetails.race_number).single();
            document.getElementById('results-entry-title').textContent =
                `Results Entry — ${raceDetails.name} GP`;
        } catch (e) { console.error('Error updating results entry title:', e); }
    }

    // ============================================================
    // === SCORING TAB
    // ============================================================

    // Module-level data store for Scoring tab (refreshable)
    let scoringData = {
        formRaw: [], formConfig: [], calendar: [], players: [],
        drivers: [], constructors: [], formDetails: [], loaded: false
    };

    async function refreshScoringData() {
        scoringData.formRaw       = await getTable('form_raw');
        scoringData.formConfig    = await getTable('form_configuration');
        scoringData.calendar      = await getTable('calendar');
        scoringData.players       = await getTable('players');
        scoringData.drivers       = await getTable('drivers');
        scoringData.constructors  = await getTable('constructors');
        scoringData.formDetails   = await getTable('form_details');
        scoringData.loaded = true;
        markFresh('scoring-loaded-at');
        renderScoringRaceInfo();
    }

    function renderScoringRaceInfo() {
        const { formRaw, calendar, formDetails } = scoringData;
        if (!formDetails.length) return;
        const relevantRaceNumber = formDetails[0].race_number;
        const raceInfoList = document.getElementById('raceInfo');
        raceInfoList.innerHTML = '';

        const race = calendar.find(r => r.race_number === relevantRaceNumber);
        const raceName = race ? race.name : 'Unknown Race';

        const raceItem = document.createElement('li');
        raceItem.className = 'list-group-item';
        raceItem.textContent = `Race: ${raceName} (Race Number: ${relevantRaceNumber})`;
        raceInfoList.appendChild(raceItem);

        const resultsSubmitted = formRaw.some(r => r.race_number === relevantRaceNumber && r.player_id === 0);
        const resultsItem = document.createElement('li');
        resultsItem.className = 'list-group-item';
        resultsItem.textContent = resultsSubmitted ? 'Results Submitted' : 'Results Not Submitted';
        resultsItem.style.color = resultsSubmitted ? 'darkgreen' : 'red';
        raceInfoList.appendChild(resultsItem);
    }

    document.addEventListener("DOMContentLoaded", async () => {
        await refreshScoringData();

        document.getElementById('scoring-refresh-btn').addEventListener('click', refreshScoringData);
        document.getElementById('scoring-tab').addEventListener('shown.bs.tab', refreshScoringData);

        const progress = makeProgress(
            'scoring-progress-wrap', 'progressBar',
            'scoring-status-text', 'progressUpdates'
        );

        document.getElementById('scoreRoundButton').addEventListener('click', async () => {
            // Ensure fresh data
            await refreshScoringData();

            const { formRaw, formConfig, calendar, players, drivers, constructors, formDetails } = scoringData;
            const relevantRaceNumber = formDetails[0].race_number;
            const currentYear = formDetails[0].current_year;

            const relevantResponses = formRaw.filter(r => r.race_number === relevantRaceNumber);
            const results = relevantResponses.find(r => r.player_id === 0);

            const race = calendar.find(r => r.race_number === relevantRaceNumber);
            const raceName = race ? race.name : 'Unknown Race';

            progress.reset();
            progress.setStatus('Starting scoring...');

            // Score helpers (same logic as before)
            function calculateScore(response, result, scoringType, results, currentQuestionID) {
                switch (scoringType) {
                    case 'Off (0)': return 0;
                    case 'P1 Type (3)':
                        if (response === result) return 3;
                        if (response === results.form_id_3) return 1.5;
                        if (response === results.form_id_4) return 1;
                        if (response === results.form_id_5) return 0.5;
                        return 0;
                    case 'P2 Type (2)':
                        if (response === result) return 2;
                        if (response === results.form_id_2 || response === results.form_id_4) return 1.5;
                        if (response === results.form_id_5) return 1;
                        if (response === results.form_id_6) return 0.5;
                        return 0;
                    case 'P3 Type (2)':
                        if (response === result) return 2;
                        if (response === results.form_id_3 || response === results.form_id_5) return 1.5;
                        if (response === results.form_id_6 || response === results.form_id_2) return 1;
                        if (response === results.form_id_7) return 0.5;
                        return 0;
                    case 'P4 Type (2)':
                        if (response === result) return 2;
                        if (response === results.form_id_4 || response === results.form_id_6) return 1.5;
                        if (response === results.form_id_3 || response === results.form_id_7) return 1;
                        if (response === results.form_id_2) return 0.5;
                        return 0;
                    case 'P5 Type (2)':
                        if (response === result) return 2;
                        if (response === results.form_id_5 || response === results.form_id_7) return 1.5;
                        if (response === results.form_id_4) return 1;
                        if (response === results.form_id_3) return 0.5;
                        return 0;
                    case 'P6 Type (2)':
                        if (response === result) return 2;
                        if (response === results.form_id_6) return 1.5;
                        if (response === results.form_id_5) return 1;
                        if (response === results.form_id_4) return 0.5;
                        return 0;
                    case 'Simple (1)': return response === result ? 1 : 0;
                    case 'Driver + Team (2)': {
                        if (response === result) return 2;
                        const rd = drivers.find(d => d.id === Number(response));
                        const rl = drivers.find(d => d.id === Number(result));
                        return (rd && rl && rd.constructor_id === rl.constructor_id) ? 1 : 0;
                    }
                    case 'Plus Minus One (2)':
                        return response === result ? 2 : Math.abs(response - result) === 1 ? 1 : 0;
                    case 'Closest (1)': {
                        const allResponses = formRaw
                            .filter(r => r.race_number === relevantRaceNumber && r.player_id !== 0 && r.player_id !== -1)
                            .map(r => Number(r[`form_id_${currentQuestionID}`]));
                        const resultNum = Number(results[`form_id_${currentQuestionID}`]);
                        const closestDiff = Math.min(...allResponses.map(r => Math.abs(r - resultNum)));
                        return Math.abs(Number(response) - resultNum) === closestDiff ? 1 : 0;
                    }
                    default: return 0;
                }
            }

            function convertResponseToText(response, responseType) {
                switch (responseType) {
                    case 'Select - Name List':
                        return players.find(p => p.id === parseInt(response))?.name || response;
                    case 'Select - Driver List':
                    case 'Select - Driver List + DNF':
                        if (response === 'no-dnf') return 'No DNFs';
                        return drivers.find(d => d.id === parseInt(response))?.abbreviation || response;
                    case 'Select - Team List':
                        return constructors.find(c => c.id === parseInt(response))?.name || response;
                    case 'Radio - Yes/No':
                        return response.toLowerCase() === 'yes' ? 'Yes' : 'No';
                    case 'Radio - Heads/Tails':
                        return response.toLowerCase() === 'heads' ? 'Heads' : 'Tails';
                    default: return response;
                }
            }

            function scoreResponses(playerResponses, results) {
                if (playerResponses.player_id === 0) return {};
                let scores = { form_id_1_score: 0 };
                formConfig.forEach(question => {
                    if (question.id !== 1 && question.enabled) {
                        scores[`form_id_${question.id}_score`] = calculateScore(
                            playerResponses[`form_id_${question.id}`],
                            results[`form_id_${question.id}`],
                            question.scoring_type, results, question.id
                        );
                    } else if (question.id !== 1) {
                        scores[`form_id_${question.id}_score`] = 0;
                    }
                });
                return scores;
            }

            function calculateSubtotals(scores) {
                let s1 = scores['form_id_1_score'] || 0, s2 = 0, s3 = 0, s4 = scores['form_id_28_score'] || 0;
                for (let i = 2; i <= 7; i++)  s2 += scores[`form_id_${i}_score`] || 0;
                for (let i = 8; i <= 27; i++) s3 += scores[`form_id_${i}_score`] || 0;
                return { subtotal_1: s1, subtotal_2: s2, subtotal_3: s3, subtotal_4: s4 };
            }

            function calculateGrandTotal(scores) {
                return Object.values(scores).reduce((a, b) => a + b, 0);
            }

            async function updateFormResponses(playerId, playerName, raceNumber, raceName, scores, grandTotal, entryType, responses) {
                let convertedResponses = {}, subtotal_1 = 0, subtotal_2 = 0, subtotal_3 = 0, subtotal_4 = 0;

                if (entryType === 'results') {
                    formConfig.forEach(q => {
                        if (q.id !== 1 && q.enabled) {
                            const r = responses[`form_id_${q.id}`];
                            if (r !== undefined) convertedResponses[`form_id_${q.id}`] = convertResponseToText(r, q.response_type);
                        }
                    });
                } else if (entryType !== 'player_lowest_score') {
                    const sub = calculateSubtotals(scores);
                    subtotal_1 = sub.subtotal_1; subtotal_2 = sub.subtotal_2;
                    subtotal_3 = sub.subtotal_3; subtotal_4 = sub.subtotal_4;
                    formConfig.forEach(q => {
                        if (q.id !== 1 && q.enabled) {
                            const r = responses[`form_id_${q.id}`];
                            if (r !== undefined) convertedResponses[`form_id_${q.id}`] = convertResponseToText(r, q.response_type);
                        }
                    });
                }

                let data;
                if (entryType === 'results') {
                    data = { player_id: playerId, player_name: playerName, race_number: raceNumber, race_name: raceName, entry_type: entryType, ...convertedResponses };
                } else if (entryType === 'player_lowest_score') {
                    data = { player_id: playerId, player_name: playerName, race_number: raceNumber, race_name: raceName, entry_type: entryType, grand_total: grandTotal };
                } else {
                    data = { player_id: playerId, player_name: playerName, race_number: raceNumber, race_name: raceName, entry_type: entryType, grand_total: grandTotal, subtotal_1, subtotal_2, subtotal_3, subtotal_4, ...scores, ...convertedResponses };
                }

                const { data: existing, error: selectErr } = await supabase
                    .from(`form_responses_${currentYear}`).select('*')
                    .eq('player_id', playerId).eq('race_number', raceNumber).limit(1).single();

                if (selectErr && selectErr.code !== 'PGRST116') {
                    progress.log(`Error checking existing record for ${playerName}: ${selectErr.message}`); return;
                }
                if (existing) {
                    const { error } = await supabase.from(`form_responses_${currentYear}`)
                        .update(data).eq('player_id', playerId).eq('race_number', raceNumber);
                    if (error) progress.log(`Error updating ${playerName}: ${error.message}`);
                } else {
                    const { error } = await supabase.from(`form_responses_${currentYear}`).insert(data);
                    if (error) progress.log(`Error inserting ${playerName}: ${error.message}`);
                }
                progress.log(`Processed: ${playerName}`);
            }

            async function saveQuestions(raceNumber, raceName) {
                let questionsData = { player_id: -1, player_name: 'Questions', race_number: raceNumber, race_name: raceName, entry_type: 'questions' };
                formConfig.forEach(q => { if (q.id !== 1) questionsData[`form_id_${q.id}`] = q.text; });
                const { data: existing, error: selectErr } = await supabase
                    .from(`form_responses_${currentYear}`).select('*')
                    .eq('player_id', -1).eq('race_number', raceNumber).limit(1).single();
                if (selectErr && selectErr.code !== 'PGRST116') return;
                if (existing) {
                    await supabase.from(`form_responses_${currentYear}`).update(questionsData).eq('player_id', -1).eq('race_number', raceNumber);
                } else {
                    await supabase.from(`form_responses_${currentYear}`).insert(questionsData);
                }
            }

            async function getLowestScore(year, raceNumber) {
                const { data, error } = await supabase.from(`form_responses_${year}`)
                    .select('grand_total').eq('entry_type', 'player').eq('race_number', raceNumber);
                if (error) return NaN;
                return Math.min(...data.map(r => r.grand_total));
            }

            // Process results entry
            if (results) {
                progress.setStatus('Processing results entry...');
                progress.setPercent(5);
                await updateFormResponses(0, 'Results', relevantRaceNumber, raceName, {}, 0, 'results', results);
            }

            const totalItems = players.length;
            let currentItemIndex = 0;

            for (const playerResponse of relevantResponses) {
                if (playerResponse.player_id === 0) continue;
                const player = players.find(p => p.id === playerResponse.player_id);
                const playerName = player ? player.name : 'Unknown Player';
                progress.setStatus(`Scoring ${playerName} (${currentItemIndex + 1}/${totalItems})...`);

                const scores = scoreResponses(playerResponse, results);
                const grandTotal = calculateGrandTotal(scores);
                await updateFormResponses(playerResponse.player_id, playerName, playerResponse.race_number, raceName, scores, grandTotal, 'player', playerResponse);

                currentItemIndex++;
                progress.setPercent(5 + (currentItemIndex / totalItems) * 80);
            }

            progress.setStatus('Saving questions...');
            await saveQuestions(relevantRaceNumber, raceName);

            // Handle players without responses
            const playersWithoutResponses = players.filter(p => !relevantResponses.some(r => r.player_id === p.id));
            if (playersWithoutResponses.length > 0) {
                progress.setStatus('Assigning lowest scores to absent players...');
                const lowestScore = await getLowestScore(currentYear, relevantRaceNumber);
                for (const player of playersWithoutResponses) {
                    await updateFormResponses(player.id, player.name, relevantRaceNumber, raceName, {}, lowestScore, 'player_lowest_score');
                    currentItemIndex++;
                    progress.setPercent(85 + (currentItemIndex / (totalItems * 1.1)) * 10);
                }
            }

            progress.setStatus('Loading results table...');
            const updatedResponses = await getTable(`form_responses_${currentYear}`);
            displayScores(updatedResponses);
            progress.done('Scoring complete.');

            // Refresh Season Player with fresh data
            await refreshSeasonPlayerData();

            showCustomAlert('Round scored successfully!');
        });

        function displayScores(formResponses) {
            const tbody = document.querySelector('#scoreTable tbody');
            tbody.innerHTML = '';
            formResponses.forEach(r => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${r.entry_type === 'player_lowest_score' ? `${r.player_name} (lowest score)` : r.player_name}</td>
                    <td>${r.entry_type === 'results' ? '' : (r.grand_total !== null ? r.grand_total : 'N/A')}</td>`;
                tbody.appendChild(row);
            });
        }
    });

    // ============================================================
    // === SEASON PLAYER TAB
    // ============================================================

    let seasonPlayerData = {
        formDetails: null, currentYear: null, loaded: false
    };

    async function refreshSeasonPlayerData() {
        seasonPlayerData.formDetails = (await getTable('form_details'))[0];
        seasonPlayerData.currentYear = seasonPlayerData.formDetails?.current_year;
        seasonPlayerData.loaded = true;
        markFresh('season-player-loaded-at');
        await loadRaceOptionsSeasonPlayer();
    }

    function getLowestScoreForRound(roundNumber, seasonPlayers) {
        const column = `race_${roundNumber}`;
        let lowest = null;
        seasonPlayers.forEach(row => {
            if (row.player_id === 0) return;
            const scoreStr = row[column];
            if (scoreStr) {
                const numericPart = parseFloat(scoreStr.replace(/\(LS\)/, ''));
                if (!isNaN(numericPart) && (lowest === null || numericPart < lowest)) lowest = numericPart;
            }
        });
        return lowest;
    }

    const spProgress = makeProgress(
        'season-player-progress-wrap', 'season-player-progress-bar',
        'season-player-status-text', 'season-player-debug-log'
    );

    async function loadRaceOptionsSeasonPlayer() {
        if (!seasonPlayerData.currentYear) return;
        const currentYear = seasonPlayerData.currentYear;
        document.getElementById("current-year-season-player").value = currentYear;

        const responsesTable = `form_responses_${currentYear}`;
        const { data: raceData, error } = await supabase
            .from(responsesTable).select('race_name, race_number').order('race_number', { ascending: true });
        if (error || !raceData?.length) return;

        const uniqueRacesMap = {};
        raceData.forEach(r => {
            if (r.race_name && !uniqueRacesMap[r.race_name]) uniqueRacesMap[r.race_name] = r.race_number;
        });

        const raceSelect = document.getElementById("race-select-season-player");
        raceSelect.innerHTML = "";
        for (const [raceName, raceNumber] of Object.entries(uniqueRacesMap)) {
            const opt = document.createElement("option");
            opt.value = raceName; opt.textContent = raceName;
            opt.dataset.raceNumber = raceNumber;
            raceSelect.appendChild(opt);
        }

        // Default to current race from form_details
        const currentRaceNumber = seasonPlayerData.formDetails?.race_number;
        let matched = false;
        for (let i = 0; i < raceSelect.options.length; i++) {
            if (parseInt(raceSelect.options[i].dataset.raceNumber) === currentRaceNumber) {
                raceSelect.selectedIndex = i; matched = true; break;
            }
        }
        if (!matched && raceSelect.options.length > 0) {
            // Fall back to latest
            let latestIdx = 0, latestNum = 0;
            for (let i = 0; i < raceSelect.options.length; i++) {
                const n = parseInt(raceSelect.options[i].dataset.raceNumber);
                if (n > latestNum) { latestNum = n; latestIdx = i; }
            }
            raceSelect.selectedIndex = latestIdx;
        }
        await updateRaceInfoSeasonPlayer();
    }

    async function updateRaceInfoSeasonPlayer() {
        const currentYear = seasonPlayerData.currentYear;
        if (!currentYear) return;
        const raceSelect = document.getElementById("race-select-season-player");
        const selectedRaceName = raceSelect.value;
        const { data, error } = await supabase
            .from(`form_responses_${currentYear}`).select('entry_type').eq('race_name', selectedRaceName);
        if (error) return;
        const playerCount = data.filter(r => r.entry_type === 'player').length;
        const lowestCount = data.filter(r => r.entry_type === 'player_lowest_score').length;
        const hasResults  = data.some(r => r.entry_type === 'results');
        const hasQuestions = data.some(r => r.entry_type === 'questions');
        document.getElementById("race-info").innerHTML = `
            <p class="mb-1"><strong>Race:</strong> ${selectedRaceName}</p>
            <p class="mb-1"><strong>Responses:</strong> ${playerCount}</p>
            <p class="mb-1"><strong>Lowest Scores:</strong> ${lowestCount}</p>
            <p class="mb-1"><strong>Results Entered:</strong> ${hasResults ? "Yes" : "No"}</p>
            <p class="mb-0"><strong>Questions Entered:</strong> ${hasQuestions ? "Yes" : "No"}</p>`;
    }

    async function updateSeasonTotals() {
        spProgress.reset();
        spProgress.setStatus('Starting Season Player update...');

        const currentYear = seasonPlayerData.currentYear;
        if (!currentYear) { spProgress.setStatus('Error: current year not set.'); return; }

        const raceSelect = document.getElementById("race-select-season-player");
        const selectedRaceName = raceSelect.value;
        const raceNumber = parseInt(raceSelect.options[raceSelect.selectedIndex].dataset.raceNumber, 10);
        spProgress.log(`Race: ${selectedRaceName} (${raceNumber})`);

        const responsesTable = `form_responses_${currentYear}`;
        const seasonPlayerTable = `season_player_${currentYear}`;

        const { data: responses, error: respErr } = await supabase
            .from(responsesTable).select('player_id, player_name, grand_total, entry_type, race_name')
            .eq('race_number', raceNumber);
        if (respErr) { spProgress.setStatus(`Error: ${respErr.message}`); return; }

        const playerResponses = responses.filter(r => r.player_id !== 0 && r.player_id !== -1);
        spProgress.setStatus(`Processing ${playerResponses.length} players...`);
        spProgress.setPercent(10);

        let seasonPlayers = await getTable(seasonPlayerTable);

        let raceNamesRow = seasonPlayers.find(r => r.player_id === 0);
        if (!raceNamesRow) {
            const { data: inserted, error } = await supabase
                .from(seasonPlayerTable).insert([{ player_id: 0, player_name: "Race Names" }]).select().single();
            if (error) { spProgress.setStatus(`Error: ${error.message}`); return; }
            raceNamesRow = inserted;
            seasonPlayers = await getTable(seasonPlayerTable);
        }

        const raceColumn = `race_${raceNumber}`;
        if (raceNamesRow[raceColumn] !== null && raceNamesRow[raceColumn] !== undefined && raceNamesRow[raceColumn] !== '') {
            const override = await showCustomConfirm(
                `Results for Race ${raceNumber} (${selectedRaceName}) already exist. Override them?`,
                'Override Existing Data'
            );
            if (!override) { spProgress.setStatus('Update cancelled.'); spProgress.hide(); return; }
        }

        spProgress.log(`Updating Race Names row: ${raceColumn} = ${selectedRaceName}`);
        await supabase.from(seasonPlayerTable).update({ [raceColumn]: selectedRaceName }).eq('player_id', 0);
        spProgress.setPercent(20);

        const total = playerResponses.length;
        let idx = 0;
        for (const resp of playerResponses) {
            let score = resp.grand_total;
            if (resp.entry_type === 'player_lowest_score') score = `${score}(LS)`;
            spProgress.setStatus(`Updating ${resp.player_name} (${idx + 1}/${total})...`);
            spProgress.log(`${resp.player_name}: ${score}`);

            let playerRow = seasonPlayers.find(r => r.player_id === resp.player_id);
            if (!playerRow) {
                let newRow = { player_id: resp.player_id, player_name: resp.player_name };
                for (let i = 1; i < raceNumber; i++) {
                    const ls = getLowestScoreForRound(i, seasonPlayers);
                    newRow[`race_${i}`] = ls !== null ? `${ls}(LS)` : null;
                }
                newRow[raceColumn] = score;
                const { error } = await supabase.from(seasonPlayerTable).insert([newRow]);
                if (error) spProgress.log(`Error inserting ${resp.player_name}: ${error.message}`);
                else spProgress.log(`Inserted ${resp.player_name}`);
            } else {
                const { error } = await supabase.from(seasonPlayerTable)
                    .update({ [raceColumn]: score }).eq('player_id', resp.player_id);
                if (error) spProgress.log(`Error updating ${resp.player_name}: ${error.message}`);
            }
            idx++;
            spProgress.setPercent(20 + (idx / total) * 75);
        }

        spProgress.done('Season Player update complete.');
        await refreshSeasonTeamData();
        showCustomAlert('Season Player update complete.');
    }

    document.addEventListener("DOMContentLoaded", async () => {
        await refreshSeasonPlayerData();
        document.getElementById("season-player-refresh-btn").addEventListener('click', refreshSeasonPlayerData);
        document.getElementById("season-player-tab").addEventListener('shown.bs.tab', refreshSeasonPlayerData);
        document.getElementById("race-select-season-player").addEventListener("change", updateRaceInfoSeasonPlayer);
        document.getElementById("update-season-player").addEventListener("click", updateSeasonTotals);
    });

    // ============================================================
    // === SEASON TEAM TAB — TEAM SCORING
    // ============================================================

    let seasonTeamTabData = {
        formDetails: null, currentYear: null, loaded: false
    };

    async function refreshSeasonTeamData() {
        seasonTeamTabData.formDetails = (await getTable('form_details'))[0];
        seasonTeamTabData.currentYear = seasonTeamTabData.formDetails?.current_year;
        seasonTeamTabData.loaded = true;
        markFresh('season-team-loaded-at');
        await loadRaceOptionsSeasonTeam();
    }

    const stScoringProgress = makeProgress(
        'season-team-scoring-progress-wrap', 'season-team-scoring-bar',
        'season-team-scoring-status', 'season-team-scoring-log'
    );

    const stSummaryProgress = makeProgress(
        'season-team-summary-progress-wrap', 'season-team-summary-bar',
        'season-team-summary-status', 'season-team-summary-log'
    );

    async function loadRaceOptionsSeasonTeam() {
        if (!seasonTeamTabData.currentYear) return;
        const currentYear = seasonTeamTabData.currentYear;
        document.getElementById("current-year-season-team").value = currentYear;

        const seasonPlayerTable = `season_player_${currentYear}`;
        let spData;
        try { spData = await getTable(seasonPlayerTable); } catch(e) { return; }

        const raceNamesRow = spData.find(r => r.player_id === 0);
        if (!raceNamesRow) return;

        const uniqueRaces = {};
        for (let i = 1; ; i++) {
            const val = raceNamesRow[`race_${i}`];
            if (!val) break;
            uniqueRaces[val] = i;
        }

        const raceSelect = document.getElementById("race-select-season-team");
        raceSelect.innerHTML = "";
        for (const [raceName, raceNum] of Object.entries(uniqueRaces)) {
            const opt = document.createElement("option");
            opt.value = raceName; opt.textContent = raceName;
            opt.dataset.raceNumber = raceNum;
            raceSelect.appendChild(opt);
        }

        // Default to current race
        const currentRaceNumber = seasonTeamTabData.formDetails?.race_number;
        let matched = false;
        for (let i = 0; i < raceSelect.options.length; i++) {
            if (parseInt(raceSelect.options[i].dataset.raceNumber) === currentRaceNumber) {
                raceSelect.selectedIndex = i; matched = true; break;
            }
        }
        if (!matched && raceSelect.options.length > 0) {
            let latestIdx = 0, latestNum = 0;
            for (let i = 0; i < raceSelect.options.length; i++) {
                const n = parseInt(raceSelect.options[i].dataset.raceNumber);
                if (n > latestNum) { latestNum = n; latestIdx = i; }
            }
            raceSelect.selectedIndex = latestIdx;
        }
        await updateRaceInfoSeasonTeam();
    }

    async function updateRaceInfoSeasonTeam() {
        const raceSelect = document.getElementById("race-select-season-team");
        if (!raceSelect.options.length) return;
        const selectedRaceName = raceSelect.value;
        const raceNumber = parseInt(raceSelect.options[raceSelect.selectedIndex].dataset.raceNumber, 10);
        document.getElementById("race-info-season-team").textContent = `Race ${raceNumber}: ${selectedRaceName}`;
    }

    async function updateCardTeamScoring() {
        stScoringProgress.reset();
        stScoringProgress.setStatus('Starting Card Team Scoring...');

        const currentYear = seasonTeamTabData.currentYear;
        const raceSelect = document.getElementById("race-select-season-team");
        const selectedRaceName = raceSelect.value;
        const raceNumber = parseInt(raceSelect.options[raceSelect.selectedIndex].dataset.raceNumber, 10);
        stScoringProgress.log(`Race: ${selectedRaceName} (${raceNumber})`);

        const teamScoringTable = `team_scoring_${currentYear}`;

        let teams, players, seasonPlayerResults;
        try {
            teams               = await getTable('teams');
            players             = await getTable('players');
            seasonPlayerResults = await getTable(`season_player_${currentYear}`);
        } catch(e) { stScoringProgress.setStatus('Error fetching data: ' + e.message); return; }

        stScoringProgress.setPercent(10);

        let teamScoringData = [];
        let swapRequests = [];
        let reportRequests = [];

        // Build report requests
        for (const team of teams) {
            if (team.card_report_team_selected) {
                reportRequests.push({ reportingTeamId: team.id, reportedTeamId: team.card_report_team_selected });
            }
        }

        // Part 1: Calculate base scores and card bonuses
        for (const team of teams) {
            const teamId = team.id, teamName = team.name;
            stScoringProgress.setStatus(`Processing ${teamName}...`);

            const teamPlayers = players.filter(p => p.participant_team_id === teamId);
            if (teamPlayers.length !== 2) continue;
            const [p1, p2] = teamPlayers;

            const colName = `race_${raceNumber}`;
            const r1 = seasonPlayerResults.find(r => r.player_id === p1.id);
            const r2 = seasonPlayerResults.find(r => r.player_id === p2.id);
            if (!r1 || !r2) continue;

            const score1 = parseFloat(r1[colName]?.replace(/\(LS\)/, '') || '0') || 0;
            const score2 = parseFloat(r2[colName]?.replace(/\(LS\)/, '') || '0') || 0;
            const subtotal = score1 + score2;

            let cardPointsDelta = 0;
            let card_aero_applied = 0, card_double_applied = 0, card_halo_applied = 0;
            let card_report_applied = 0, card_report_details = '';
            let card_swap_applied = 0, card_swap_details = '';
            let card_safetycar_applied = 0;
            let card_aero_playedcol = 0, card_double_playedcol = 0, card_halo_playedcol = 0;
            let card_report_playedcol = 0, card_swap_playedcol = 0, card_safetycar_playedcol = 0;

            const haloPlayed = !!team.card_halo_played;
            if (haloPlayed) { card_halo_applied = 1; card_halo_playedcol = 1; }
            if (team.card_safetycar_played) card_safetycar_playedcol = 1;

            if (team.card_double_played && !haloPlayed) {
                cardPointsDelta += Math.max(score1, score2);
                card_double_applied = 1; card_double_playedcol = 1;
            }
            if (team.card_aero_played && !haloPlayed) {
                cardPointsDelta += Math.abs(score1 - score2);
                card_aero_applied = 1; card_aero_playedcol = 1;
            }
            if (team.card_report_played && !haloPlayed) card_report_playedcol = 1;
            if (team.card_swap_played && !haloPlayed) card_swap_playedcol = 1;

            const tempTotal = subtotal + cardPointsDelta;
            teamScoringData.push({
                teamId, teamName, player1: p1, player2: p2, score1, score2, subtotal,
                cardPointsDelta, grandTotal: tempTotal,
                card_aero_applied, card_aero_playedcol,
                card_double_applied, card_double_playedcol,
                card_halo_applied, card_halo_playedcol,
                card_report_applied, card_report_playedcol, card_report_details,
                card_swap_applied, card_swap_playedcol, card_swap_details,
                card_safetycar_applied, card_safetycar_playedcol
            });

            if (team.card_swap_team_selected) {
                swapRequests.push({ teamId, swapTargetTeamId: team.card_swap_team_selected, swapTime: team.card_swap_time });
            }
        }
        stScoringProgress.setPercent(40);

        // Part 1.5: Safety Car
        stScoringProgress.setStatus('Applying Safety Car cards...');
        teamScoringData.sort((a, b) => b.grandTotal - a.grandTotal);
        let currentRank = 1;
        while (currentRank <= teamScoringData.length) {
            teamScoringData.sort((a, b) => b.grandTotal - a.grandTotal);
            const currentScore = teamScoringData[currentRank - 1]?.grandTotal;
            if (currentScore === undefined) break;
            const EPSILON = 0.0001;
            const currentRankTeams = teamScoringData.filter(t => Math.abs(t.grandTotal - currentScore) < EPSILON);

            if (currentRank === 1) {
                currentRankTeams.forEach(t => { if (t.card_safetycar_playedcol) { t.card_safetycar_applied = 1; } });
                currentRank += currentRankTeams.length; continue;
            }
            const teamAhead = teamScoringData[currentRank - 2];
            for (const team of currentRankTeams) {
                if (!team.card_safetycar_playedcol) continue;
                const gap = teamAhead.grandTotal - team.grandTotal;
                if (gap <= 0.5) { team.card_safetycar_applied = 1; continue; }
                const delta = gap - 0.5;
                team.cardPointsDelta += delta;
                team.grandTotal += delta;
                team.card_safetycar_applied = 1;
                stScoringProgress.log(`Safety Car: ${team.teamName} +${delta.toFixed(2)}`);
            }
            currentRank += currentRankTeams.length;
        }
        stScoringProgress.setPercent(60);

        // Part 2: Report cards
        stScoringProgress.setStatus('Applying Report cards...');
        for (const td of teamScoringData) {
            const reports = reportRequests.filter(r => r.reportedTeamId === td.teamId);
            if (!reports.length) continue;
            let reportCount = reports.length;
            let details = '';
            reports.forEach(report => {
                const reportingTeam = teams.find(t => t.id === report.reportingTeamId);
                const reportedTeamData = teamScoringData.find(t => t.teamId === report.reportedTeamId);
                if (reportedTeamData?.card_halo_applied === 1) {
                    reportCount = 0;
                    details += `${reportingTeam?.name}'s report on ${td.teamName} was stopped by Halo. `;
                } else {
                    details += `${reportingTeam?.name} reported ${td.teamName}. `;
                }
            });
            td.card_report_applied = reportCount;
            td.card_report_details = details.trim();
            const highestScore = Math.max(td.score1, td.score2);
            if (reportCount === 1) td.grandTotal -= highestScore;
            else if (reportCount > 1) td.grandTotal += highestScore;
        }

        // Part 3: Swap cards
        stScoringProgress.setStatus('Applying Swap cards...');
        swapRequests.sort((a, b) => a.swapTime - b.swapTime);
        let swapCount = 1;
        for (const swap of swapRequests) {
            const td = teamScoringData.find(t => t.teamId === swap.teamId);
            const tgt = teamScoringData.find(t => t.teamId === swap.swapTargetTeamId);
            if (!td || !tgt) continue;
            if (tgt.card_halo_applied === 1) {
                td.card_swap_details += `(#${swapCount}) ${td.teamName} swap with ${tgt.teamName} stopped by Halo. `;
                tgt.card_swap_details += `(#${swapCount}) Swap by ${td.teamName} stopped by Halo. `;
            } else {
                const tmp = td.grandTotal;
                td.grandTotal = tgt.grandTotal;
                tgt.grandTotal = tmp;
                td.card_swap_details += `(#${swapCount}) ${td.teamName} swaps with ${tgt.teamName}. `;
                tgt.card_swap_details += `(#${swapCount}) ${td.teamName} swaps with ${tgt.teamName}. `;
                td.card_swap_applied++; tgt.card_swap_applied++; swapCount++;
            }
        }
        stScoringProgress.setPercent(80);

        // Part 4: Upload
        stScoringProgress.setStatus('Uploading results...');
        for (const td of teamScoringData) {
            td.cardPointsDelta = td.grandTotal - td.subtotal;
            const record = {
                team_id: td.teamId, team_name: td.teamName, race_number: raceNumber, race_name: selectedRaceName,
                subtotal: td.subtotal, card_points_delta: td.cardPointsDelta, grand_total: td.grandTotal,
                card_aero_applied: td.card_aero_applied, card_double_applied: td.card_double_applied,
                card_halo_applied: td.card_halo_applied, card_report_applied: td.card_report_applied,
                card_report_details: td.card_report_details, card_swap_applied: td.card_swap_applied,
                card_swap_details: td.card_swap_details, card_safetycar_applied: td.card_safetycar_applied,
                card_safetycar_playedcol: td.card_safetycar_playedcol,
                card_aero_playedcol: td.card_aero_playedcol, card_double_playedcol: td.card_double_playedcol,
                card_halo_playedcol: td.card_halo_playedcol, card_report_playedcol: td.card_report_playedcol,
                card_swap_playedcol: td.card_swap_playedcol,
                player_id_1: td.player1.id, player_name_1: td.player1.name, player_points_1: td.score1,
                player_id_2: td.player2.id, player_name_2: td.player2.name, player_points_2: td.score2
            };
            await upsertTeamScoringData([record], teamScoringTable);
            await resetTeamCardsSupabase(td.teamId);
            stScoringProgress.log(`Uploaded: ${td.teamName}`);
        }

        stScoringProgress.done('Team Scoring complete.');
        await refreshSeasonTeamData();
        showCustomAlert('Team scoring complete!');
    }

    async function updateCasinoTeamScoring() {
        stScoringProgress.reset();
        stScoringProgress.setStatus('Starting Casino Team Scoring...');

        const currentYear = seasonTeamTabData.currentYear;
        const raceSelect = document.getElementById("race-select-season-team");
        const selectedRaceName = raceSelect.value;
        const raceNumber = parseInt(raceSelect.options[raceSelect.selectedIndex].dataset.raceNumber, 10);

        const teamScoringTable = `team_scoring_${currentYear}`;
        let teams, players, seasonPlayerResults, casinoBets;
        try {
            teams               = await getTable('teams');
            players             = await getTable('players');
            seasonPlayerResults = await getTable(`season_player_${currentYear}`);
            casinoBets          = await getTable('casino');
        } catch(e) { stScoringProgress.setStatus('Error: ' + e.message); return; }

        const oddsRow       = casinoBets.find(r => r.team_id === 0);
        const questionRow   = casinoBets.find(r => r.team_id === -2);
        const willPayOutRow = casinoBets.find(r => r.team_id === -4);
        if (!oddsRow || !questionRow || !willPayOutRow) {
            stScoringProgress.setStatus('Error: missing casino meta rows.'); return;
        }

        const teamScoringDataArr = [];
        let idx = 0;
        for (const team of teams) {
            if (team.id <= 0) continue;
            const teamPlayers = players.filter(p => p.participant_team_id === team.id);
            if (teamPlayers.length !== 2) continue;
            const [p1, p2] = teamPlayers;

            const colName = `race_${raceNumber}`;
            const r1 = seasonPlayerResults.find(r => r.player_id === p1.id);
            const r2 = seasonPlayerResults.find(r => r.player_id === p2.id);
            if (!r1 || !r2) continue;

            const score1 = parseFloat(r1[colName]?.replace(/\(LS\)/, '') || '0') || 0;
            const score2 = parseFloat(r2[colName]?.replace(/\(LS\)/, '') || '0') || 0;
            const originalSubtotal = score1 + score2;

            let casinoDelta = 0, casinoDetails = '';
            const teamBets = casinoBets.filter(b => b.team_id === team.id);
            teamBets.forEach(bet => {
                for (let i = 1; i <= 5; i++) {
                    const betAmount = parseFloat(bet[`bet_${i}`]);
                    if (isNaN(betAmount)) continue;
                    const odds = parseFloat(oddsRow[`bet_${i}`]);
                    const willPayOut = willPayOutRow[`bet_${i}`] === 'true' || willPayOutRow[`bet_${i}`] === true;
                    const q = questionRow[`bet_${i}`] || `Bet ${i}`;
                    const delta = willPayOut ? (betAmount * odds) - betAmount : -betAmount;
                    casinoDelta += delta;
                    casinoDetails += `(#${i} - ${q}: Stake=${betAmount}, Odds=${odds}, ${willPayOut ? 'Paid out' : 'Lost'}, ${delta >= 0 ? '+' : ''}${delta}) `;
                }
            });

            teamScoringDataArr.push({
                team_id: team.id, team_name: team.name,
                player_id_1: p1.id, player_name_1: p1.name, player_points_1: score1,
                player_id_2: p2.id, player_name_2: p2.name, player_points_2: score2,
                race_number: raceNumber, race_name: selectedRaceName,
                subtotal: originalSubtotal, card_points_delta: casinoDelta,
                grand_total: originalSubtotal + casinoDelta,
                card_aero_applied: 0, card_double_applied: 0, card_halo_applied: 0,
                card_report_applied: 0, card_report_details: null,
                card_swap_applied: 0, card_swap_details: null, casino_details: casinoDetails
            });
            stScoringProgress.setStatus(`Processed ${team.name}...`);
            stScoringProgress.log(`${team.name}: subtotal=${originalSubtotal}, casino delta=${casinoDelta.toFixed(2)}`);
            idx++;
            stScoringProgress.setPercent(10 + (idx / teams.length) * 70);
        }

        for (const rec of teamScoringDataArr) {
            await upsertTeamScoringData([rec], teamScoringTable);
        }

        // Reset casino bets
        const { error: deleteErr } = await supabase.from('casino').delete().gt('team_id', 0);
        if (deleteErr) stScoringProgress.log('Error resetting casino bets: ' + deleteErr.message);
        else stScoringProgress.log('Casino bets reset.');

        stScoringProgress.done('Casino Team Scoring complete.');
        await refreshSeasonTeamData();
        showCustomAlert('Casino team scoring complete!');
    }

    async function upsertTeamScoringData(data, tableName) {
        const { data: existing, error: fetchErr } = await supabase
            .from(tableName).select('team_id, race_number');
        if (fetchErr) { console.error(fetchErr); return; }

        const toInsert = [], toUpdate = [];
        for (const rec of data) {
            const found = existing.find(r => r.team_id === rec.team_id && r.race_number === rec.race_number);
            if (found) toUpdate.push(rec); else toInsert.push(rec);
        }
        if (toInsert.length) await supabase.from(tableName).insert(toInsert);
        for (const rec of toUpdate) {
            await supabase.from(tableName).update(rec)
                .eq('team_id', rec.team_id).eq('race_number', rec.race_number);
        }
    }

    async function resetTeamCardsSupabase(teamId) {
        await supabase.from('teams').update({
            card_aero_played: 0, card_double_played: 0, card_halo_played: 0,
            card_report_played: 0, card_swap_played: 0, card_safetycar_played: 0,
            card_report_team_selected: null, card_swap_team_selected: null, card_swap_time: null
        }).eq('id', teamId);
    }

    async function updateTeamScoring() {
        const raceType = document.getElementById("raceType").value;
        if (raceType === 'card') await updateCardTeamScoring();
        else await updateCasinoTeamScoring();
    }

    // ============================================================
    // === SEASON TEAM TAB — SEASON SUMMARY
    // ============================================================

    function getLowestTeamScoreForRound(roundNumber, seasonTeamData) {
        const column = `race_${roundNumber}`;
        let lowest = null;
        seasonTeamData.forEach(row => {
            if (row.team_id === 0) return;
            const match = row[column]?.match(/^(\d+(\.\d+)?)/);
            if (match) {
                const num = parseFloat(match[1]);
                if (lowest === null || num < lowest) lowest = num;
            }
        });
        return lowest;
    }

    async function updateSeasonTeamSummary() {
        stSummaryProgress.reset();
        stSummaryProgress.setStatus('Starting Season Team Summary...');

        const currentYear = seasonTeamTabData.currentYear;
        const raceSelect = document.getElementById("race-select-season-team");
        const selectedRaceName = raceSelect.value;
        const raceNumber = parseInt(raceSelect.options[raceSelect.selectedIndex].dataset.raceNumber, 10);
        stSummaryProgress.log(`Race: ${selectedRaceName} (${raceNumber})`);

        const teamScoringTable = `team_scoring_${currentYear}`;
        const seasonTeamTable  = `season_team_${currentYear}`;

        const { data: tsd, error: tsdErr } = await supabase
            .from(teamScoringTable).select('*').eq('race_number', raceNumber);
        if (tsdErr || !tsd?.length) {
            stSummaryProgress.setStatus('No team scoring records found.');
            showCustomAlert('No team scoring records found for the selected race.'); return;
        }
        stSummaryProgress.setPercent(15);

        // Build final score strings with card tags
        tsd.forEach(rec => {
            let tags = '';
            const append = (count, label) => { for (let i = 0; i < (count || 0); i++) tags += `(${label})`; };
            append(rec.card_aero_applied, 'aero');
            append(rec.card_double_applied, 'double');
            append(rec.card_halo_applied, 'halo');
            append(rec.card_report_applied, 'report');
            append(rec.card_swap_applied, 'swap');
            if (rec.card_safetycar_applied > 0) tags += '(safetycar)';
            if (rec.casino_details?.trim()) tags += '(casino)';
            rec.final_score = rec.grand_total + tags;
            stSummaryProgress.log(`${rec.team_name}: ${rec.final_score}`);
        });

        const { data: seasonTeamData } = await supabase.from(seasonTeamTable).select('*');
        stSummaryProgress.setPercent(30);

        const total = tsd.length;
        let idx = 0;
        for (const rec of tsd) {
            stSummaryProgress.setStatus(`Updating ${rec.team_name} (${idx + 1}/${total})...`);
            let updateObj = {
                team_id: rec.team_id, team_name: rec.team_name,
                player_name_1: rec.player_name_1, player_name_2: rec.player_name_2,
                [`race_${raceNumber}`]: rec.final_score
            };

            const { data: existing } = await supabase.from(seasonTeamTable)
                .select('team_id').eq('team_id', rec.team_id).maybeSingle();

            if (existing) {
                await supabase.from(seasonTeamTable).update(updateObj).eq('team_id', rec.team_id);
            } else {
                for (let i = 1; i < raceNumber; i++) {
                    const lowest = getLowestTeamScoreForRound(i, seasonTeamData || []);
                    updateObj[`race_${i}`] = lowest !== null ? `${lowest}(LS)` : null;
                }
                await supabase.from(seasonTeamTable).insert(updateObj);
            }
            idx++;
            stSummaryProgress.setPercent(30 + (idx / total) * 60);
        }

        // Update Race Names row
        stSummaryProgress.setStatus('Updating Race Names row...');
        const { data: rnRow } = await supabase.from(seasonTeamTable).select('*').eq('team_id', 0).maybeSingle();
        if (!rnRow) {
            await supabase.from(seasonTeamTable).insert({ team_id: 0, team_name: 'Race Names', [`race_${raceNumber}`]: selectedRaceName });
        } else {
            await supabase.from(seasonTeamTable).update({ [`race_${raceNumber}`]: selectedRaceName }).eq('team_id', 0);
        }

        stSummaryProgress.done('Season Team Summary complete.');
        await refreshSeasonTeamData();
        showCustomAlert('Season Team Summary update complete!');
    }

    document.addEventListener("DOMContentLoaded", async () => {
        await refreshSeasonTeamData();
        document.getElementById("season-team-refresh-btn").addEventListener('click', refreshSeasonTeamData);
        document.getElementById("season-team-tab").addEventListener('shown.bs.tab', refreshSeasonTeamData);
        document.getElementById("race-select-season-team").addEventListener("change", updateRaceInfoSeasonTeam);
        document.getElementById("update-season-season-team").addEventListener("click", updateTeamScoring);
        document.getElementById("update-season-team-summary").addEventListener("click", updateSeasonTeamSummary);
    });

    // ============================================================
    // === INFORMATION DASHBOARD
    // ============================================================

    document.addEventListener('DOMContentLoaded', async () => {
        const raceSelect = document.getElementById('race-select');
        const resultsDisplayRaceSelect = document.getElementById('results-display-race-select');
        const resultsDisplayTypeSelect = document.getElementById('results-display-type-select');
        const formResponses = document.getElementById('form-responses');
        const formStatus = document.getElementById('form-status');
        const formStatusLabel = document.getElementById('form-status-label');
        const currentYearInput = document.getElementById('current-year');
        const formStatusTextEnabledInput = document.getElementById('form-status-text-enabled');
        const formStatusTextEnabledLabel = document.getElementById('form-status-text-enabled-label');
        const formStatusTextInput = document.getElementById('form-status-text');
        const formAlertTextEnabledInput = document.getElementById('form-alert-text-enabled');
        const formAlertTextEnabledLabel = document.getElementById('form-alert-text-enabled-label');
        const formAlertTextInput = document.getElementById('form-alert-text-input');
        const saveChangesButton = document.getElementById('save-changes');

        let currentRaceNumber;

        async function fetchFormDetails() {
            const { data, error } = await supabase.from('form_details').select(
                `race_number, form_enabled, results_display_race_number, results_display_type,
                 current_year, form_status_text, form_status_text_enabled, form_alert_text,
                 form_alert_text_enabled, background_image, main_page_alert_text,
                 main_page_alert_enabled, main_page_alert_type`
            ).eq('id', 1).single();
            if (error) { console.error(error); return; }

            currentRaceNumber = data.race_number;
            formStatus.checked = data.form_enabled;
            formStatusLabel.textContent = data.form_enabled ? 'Enabled' : 'Disabled';
            currentYearInput.value = data.current_year;
            resultsDisplayTypeSelect.value = data.results_display_type;
            formStatusTextEnabledInput.checked = data.form_status_text_enabled;
            formStatusTextEnabledLabel.textContent = data.form_status_text_enabled ? 'Enabled' : 'Disabled';
            formStatusTextInput.value = data.form_status_text;
            formAlertTextEnabledInput.checked = data.form_alert_text_enabled;
            formAlertTextEnabledLabel.textContent = data.form_alert_text_enabled ? 'Enabled' : 'Disabled';
            formAlertTextInput.value = data.form_alert_text;

            document.getElementById('main-page-alert-enabled').checked = data.main_page_alert_enabled;
            document.getElementById('main-page-alert-enabled-label').textContent = data.main_page_alert_enabled ? 'Enabled' : 'Disabled';
            document.getElementById('main-page-alert-text-input').value = data.main_page_alert_text;
            document.getElementById('main-page-alert-type-select').value = data.main_page_alert_type;
            if (data.background_image) document.getElementById('background-image-select').value = data.background_image;
        }

        await fetchFormDetails();

        async function fetchRaceOptions() {
            const { data: races, error } = await supabase
                .from('calendar').select('race_number, name').order('race_number', { ascending: true });
            if (error) return;
            races.forEach(race => {
                const opt = document.createElement('option');
                opt.value = race.race_number;
                opt.textContent = `Race ${race.race_number}: ${race.name} GP`;
                if (race.race_number === currentRaceNumber) opt.selected = true;
                raceSelect.appendChild(opt);

                const opt2 = opt.cloneNode(true);
                resultsDisplayRaceSelect.appendChild(opt2);
            });
        }
        await fetchRaceOptions();

        async function fetchFormResponseCount() {
            const { data, error } = await supabase.from('form_raw')
                .select('id').eq('race_number', currentRaceNumber);
            if (!error) formResponses.textContent = data.length;
        }
        await fetchFormResponseCount();

        // Change listeners
        [raceSelect, resultsDisplayRaceSelect, resultsDisplayTypeSelect, currentYearInput,
         formStatusTextInput, formAlertTextInput,
         document.getElementById('main-page-alert-text-input'),
         document.getElementById('background-image-select'),
         document.getElementById('main-page-alert-type-select')
        ].forEach(el => el.addEventListener('input', () => { saveChangesButton.disabled = false; }));
        [raceSelect, resultsDisplayRaceSelect, resultsDisplayTypeSelect,
         document.getElementById('background-image-select'),
         document.getElementById('main-page-alert-type-select')
        ].forEach(el => el.addEventListener('change', () => { saveChangesButton.disabled = false; }));

        formStatus.addEventListener('change', () => {
            saveChangesButton.disabled = false;
            formStatusLabel.textContent = formStatus.checked ? 'Enabled' : 'Disabled';
        });
        formStatusTextEnabledInput.addEventListener('change', () => {
            saveChangesButton.disabled = false;
            formStatusTextEnabledLabel.textContent = formStatusTextEnabledInput.checked ? 'Enabled' : 'Disabled';
        });
        formAlertTextEnabledInput.addEventListener('change', () => {
            saveChangesButton.disabled = false;
            formAlertTextEnabledLabel.textContent = formAlertTextEnabledInput.checked ? 'Enabled' : 'Disabled';
        });
        document.getElementById('main-page-alert-enabled').addEventListener('change', () => {
            saveChangesButton.disabled = false;
            document.getElementById('main-page-alert-enabled-label').textContent =
                document.getElementById('main-page-alert-enabled').checked ? 'Enabled' : 'Disabled';
        });

        document.getElementById('dashboard-form').addEventListener('submit', async event => {
            event.preventDefault();
            const { error } = await supabase.from('form_details').update({
                race_number:                  raceSelect.value,
                form_enabled:                 formStatus.checked,
                results_display_race_number:  resultsDisplayRaceSelect.value,
                results_display_type:         resultsDisplayTypeSelect.value,
                current_year:                 currentYearInput.value,
                form_status_text_enabled:     formStatusTextEnabledInput.checked,
                form_status_text:             formStatusTextInput.value,
                form_alert_text_enabled:      formAlertTextEnabledInput.checked,
                form_alert_text:              formAlertTextInput.value,
                main_page_alert_enabled:      document.getElementById('main-page-alert-enabled').checked,
                main_page_alert_text:         document.getElementById('main-page-alert-text-input').value,
                main_page_alert_type:         document.getElementById('main-page-alert-type-select').value,
                background_image:             document.getElementById('background-image-select').value
            }).eq('id', 1);

            if (error) { showCustomAlert('Error saving changes'); return; }
            saveChangesButton.disabled = true;
            formStatusLabel.textContent = formStatus.checked ? 'Enabled' : 'Disabled';
            await fetchFormResponseCount();
            showCustomAlert('Changes saved successfully');
        });
    });

    // ============================================================
    // === EDIT PLAYERS TAB
    // ============================================================

    async function populatePlayers() {
        const players = await fetchData('players');
        const teams   = await fetchData('teams');
        const table   = document.getElementById('players-table');
        table.innerHTML = players.map(player => `
            <tr>
                <td>${player.id}</td>
                <td><input type="text" class="form-control" id="player-name-${player.id}" value="${player.name}"></td>
                <td>${teams.find(t => t.id === player.participant_team_id)?.name || 'Unassigned'}</td>
                <td><input type="text" class="form-control" id="player-password-${player.id}" placeholder="New 4-digit PIN" maxlength="4" style="width:100px;display:inline-block;"></td>
                <td>
                    <button class="btn btn-primary btn-sm" id="update-player-${player.id}" onclick="updatePlayer(${player.id})" disabled>Update</button>
                    <button class="btn btn-danger btn-sm" onclick="deletePlayer(${player.id})">Delete</button>
                    <br><br>
                    <button class="btn btn-secondary btn-sm" onclick="updatePlayerPassword(${player.id})">Update Password</button>
                </td>
            </tr>`).join('');
        players.forEach(p => enableUpdateButton(`player-name-${p.id}`, `update-player-${p.id}`, p.name));
    }

    async function updatePlayerPassword(id) {
        const newPin = document.getElementById(`player-password-${id}`).value.trim();
        if (!/^\d{4}$/.test(newPin)) { showCustomAlert('Please enter a valid 4-digit PIN.'); return; }
        const hashedPin = CryptoJS.MD5(newPin).toString();
        const { error } = await supabase.from('players').update({ password: hashedPin }).eq('id', id);
        if (error) { showCustomAlert('Failed to update password.'); return; }
        showCustomAlert('Password updated successfully!');
        document.getElementById(`player-password-${id}`).value = '';
    }

    async function updatePlayer(id) {
        const name = document.getElementById(`player-name-${id}`).value.trim();
        if (!name) { showCustomAlert('Name cannot be empty.'); return; }
        if (await updateData('players', id, { name })) {
            showCustomAlert('Player updated successfully!'); populatePlayers();
        }
    }

    async function deletePlayer(id) {
        if (await showCustomConfirm("Are you sure you want to delete this player?", "Confirm Deletion")) {
            if (await deleteData('players', id)) populatePlayers();
        }
    }

    // ============================================================
    // === EDIT TEAMS TAB
    // ============================================================

    async function populateTeams() {
        const teams = await fetchData('teams');
        const table = document.getElementById('teams-table');
        table.innerHTML = teams.map(team => `
            <tr>
                <td>${team.id}</td>
                <td><input type="text" class="form-control" id="team-name-${team.id}" value="${team.name}"></td>
                <td>
                    <button class="btn btn-primary btn-sm" id="update-team-${team.id}" onclick="updateTeam(${team.id})" disabled>Update</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTeam(${team.id})">Delete</button>
                </td>
            </tr>`).join('');
        teams.forEach(t => enableUpdateButton(`team-name-${t.id}`, `update-team-${t.id}`, t.name));
    }

    async function updateTeam(id) {
        const name = document.getElementById(`team-name-${id}`).value.trim();
        if (!name) { showCustomAlert('Name cannot be empty.'); return; }
        if (await updateData('teams', id, { name })) {
            showCustomAlert('Team updated successfully!'); populateTeams();
        }
    }

    async function deleteTeam(id) {
        if (await showCustomConfirm("Are you sure you want to delete this team?", "Confirm Deletion")) {
            if (await deleteData('teams', id)) populateTeams();
        }
    }

    // ============================================================
    // === EDIT DRIVERS TAB
    // ============================================================

    async function populateConstructorDropdown() {
        const { data, error } = await supabase.from("constructors").select("id, name");
        if (error) return;
        const dd = document.getElementById("new-driver-constructor");
        dd.innerHTML = `<option value="">Select Constructor</option>`;
        data.forEach(c => { dd.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
    }

    async function fetchDrivers() {
        const { data: driverData, error } = await supabase.from("drivers").select("*").order("id", { ascending: true });
        if (error) return;
        const { data: constructors } = await supabase.from("constructors").select("id, name");
        const table = document.getElementById("drivers-table");
        table.innerHTML = "";
        driverData.forEach(driver => {
            let sel = `<select class="form-control" data-id="${driver.id}" data-field="constructor_id">
                <option value="">Select Constructor</option>`;
            (constructors || []).forEach(c => {
                sel += `<option value="${c.id}" ${c.id === driver.constructor_id ? 'selected' : ''}>${c.name}</option>`;
            });
            sel += `</select>`;
            table.innerHTML += `<tr>
                <td>${driver.id}</td>
                <td><input type="text" class="form-control" value="${driver.name}" data-id="${driver.id}" data-field="name"></td>
                <td><input type="text" class="form-control" value="${driver.abbreviation}" data-id="${driver.id}" data-field="abbreviation"></td>
                <td>${sel}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteDriver(${driver.id})">Delete</button></td>
            </tr>`;
        });
    }

    async function saveDrivers() {
        const elements = document.querySelectorAll("#drivers-table input, #drivers-table select");
        const grouped = {};
        elements.forEach(el => {
            const id = Number(el.dataset.id), field = el.dataset.field;
            if (!grouped[id]) grouped[id] = { id };
            grouped[id][field] = field === 'constructor_id' ? Number(el.value) : el.value;
        });
        const { error } = await supabase.from("drivers").upsert(Object.values(grouped));
        if (error) { showCustomAlert("Failed to save drivers!"); return; }
        showCustomAlert("Drivers saved successfully!");
        await fetchDrivers();
        document.getElementById("save-drivers").disabled = true;
    }

    async function addDriver() {
        const name = document.getElementById("new-driver-name").value.trim();
        const abbr = document.getElementById("new-driver-abbr").value.trim();
        const cid  = Number(document.getElementById("new-driver-constructor").value.trim());
        if (!name || !abbr || !cid) { showCustomAlert("All fields are required."); return; }
        const { error } = await supabase.from("drivers").insert([{ name, abbreviation: abbr, constructor_id: cid }]);
        if (error) return;
        await fetchDrivers();
        showCustomAlert("Driver added successfully!");
        document.getElementById("new-driver-name").value = "";
        document.getElementById("new-driver-abbr").value = "";
        document.getElementById("new-driver-constructor").value = "";
    }

    async function deleteDriver(id) {
        if (!await showCustomConfirm("Delete this driver?", "Confirm Deletion")) return;
        await supabase.from("drivers").delete().eq("id", id);
        showCustomAlert("Driver deleted!");
        await fetchDrivers();
    }

    // ============================================================
    // === EDIT CONSTRUCTORS TAB
    // ============================================================

    async function fetchConstructors() {
        const { data, error } = await supabase.from("constructors").select("*").order("id", { ascending: true });
        if (error) return;
        const table = document.getElementById("constructors-table");
        table.innerHTML = "";
        data.forEach(c => {
            table.innerHTML += `<tr>
                <td>${c.id}</td>
                <td><input type="text" class="form-control" value="${c.name}" data-id="${c.id}" data-field="name"></td>
                <td><input type="text" class="form-control" value="${c.background_colour}" data-id="${c.id}" data-field="background_colour"></td>
                <td><input type="text" class="form-control" value="${c.text_colour}" data-id="${c.id}" data-field="text_colour"></td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteConstructor(${c.id})">Delete</button></td>
            </tr>`;
        });
    }

    async function saveConstructors() {
        const inputs = document.querySelectorAll("#constructors-table input");
        const grouped = {};
        inputs.forEach(el => {
            const id = Number(el.dataset.id);
            if (!grouped[id]) grouped[id] = { id };
            grouped[id][el.dataset.field] = el.value;
        });
        const { error } = await supabase.from("constructors").upsert(Object.values(grouped));
        if (error) { showCustomAlert("Failed to save constructors!"); return; }
        showCustomAlert("Constructors saved successfully!");
        document.getElementById("save-constructors").disabled = true;
        await fetchConstructors();
    }

    async function addConstructor() {
        const name = document.getElementById("new-constructor-name").value.trim();
        const bg   = document.getElementById("new-constructor-bg").value.trim();
        const txt  = document.getElementById("new-constructor-text").value.trim();
        if (!name || !bg || !txt) { showCustomAlert("All fields are required."); return; }
        const { error } = await supabase.from("constructors").insert([{ name, background_colour: bg, text_colour: txt }]);
        if (error) { showCustomAlert("Failed to add constructor!"); return; }
        await fetchConstructors(); await populateConstructorDropdown();
        showCustomAlert("Constructor added successfully!");
        document.getElementById("new-constructor-name").value = "";
        document.getElementById("new-constructor-bg").value = "";
        document.getElementById("new-constructor-text").value = "";
    }

    async function deleteConstructor(id) {
        if (!await showCustomConfirm("Delete this constructor?", "Confirm Deletion")) return;
        const { data: dep } = await supabase.from("drivers").select("id").eq("constructor_id", id);
        if (dep?.length > 0) { showCustomAlert("Cannot delete: assigned to one or more drivers."); return; }
        await supabase.from("constructors").delete().eq("id", id);
        showCustomAlert("Constructor deleted!");
        await fetchConstructors();
    }

    // ============================================================
    // === EDIT CALENDAR TAB
    // ============================================================

    async function fetchCalendar() {
        const { data, error } = await supabase.from("calendar").select("*").order("race_number", { ascending: true });
        if (error) return;
        const table = document.getElementById("calendar-table");
        table.innerHTML = "";
        data.forEach(event => {
            const dt = event.date ? new Date(event.date).toISOString().slice(0, 16) : '';
            table.innerHTML += `<tr>
                <td>${event.id}</td>
                <td><input type="number" class="form-control" value="${event.race_number || ''}" data-id="${event.id}" data-field="race_number"></td>
                <td><input type="text" class="form-control" value="${event.name || ''}" data-id="${event.id}" data-field="name"></td>
                <td><input type="text" class="form-control" value="${event.country || ''}" data-id="${event.id}" data-field="country"></td>
                <td><input type="datetime-local" class="form-control" value="${dt}" data-id="${event.id}" data-field="date"></td>
                <td><button class="btn btn-danger" onclick="deleteRace(${event.id})">Delete</button></td>
            </tr>`;
        });
    }

    async function saveCalendar() {
        const inputs = document.querySelectorAll("#calendar-table input");
        const grouped = {};
        inputs.forEach(el => {
            const id = el.dataset.id;
            if (!grouped[id]) grouped[id] = { id };
            let val = el.value;
            if (el.dataset.field === 'date') {
                const d = new Date(val + "Z");
                val = isNaN(d) ? val : d.toISOString();
            }
            grouped[id][el.dataset.field] = val;
        });
        const { error } = await supabase.from("calendar").upsert(Object.values(grouped));
        if (error) { showCustomAlert("Failed to save calendar!"); return; }
        showCustomAlert("Calendar saved successfully!");
        document.getElementById("save-calendar").disabled = true;
        await fetchCalendar();
    }

    async function deleteRace(id) {
        if (!await showCustomConfirm("Delete this race?", "Confirm Deletion")) return;
        await supabase.from("calendar").delete().eq("id", id);
        showCustomAlert("Race deleted!"); await fetchCalendar();
    }

    async function addRace() {
        const race_number = document.getElementById("new-race-number").value.trim();
        const name        = document.getElementById("new-race-name").value.trim();
        const country     = document.getElementById("new-race-country").value.trim();
        const date        = document.getElementById("new-race-date").value.trim();
        if (!race_number || !name || !country || !date) { showCustomAlert("All fields are required."); return; }
        const utcDate = new Date(date + "Z");
        if (isNaN(utcDate)) { showCustomAlert("Invalid date format!"); return; }
        await supabase.from("calendar").insert([{ race_number, name, country, date: utcDate.toISOString() }]);
        document.getElementById("new-race-number").value = "";
        document.getElementById("new-race-name").value = "";
        document.getElementById("new-race-country").value = "";
        document.getElementById("new-race-date").value = "";
        await fetchCalendar(); showCustomAlert("Race added!");
    }

    // ============================================================
    // === EDIT TABS INITIALISATION
    // ============================================================

    document.addEventListener('DOMContentLoaded', async () => {
        await populatePlayers();
        await populateTeams();
        await fetchDrivers();
        await fetchConstructors();
        await fetchCalendar();
        await populateConstructorDropdown();

        const saveDriversBtn       = document.getElementById("save-drivers");
        const saveConstructorsBtn  = document.getElementById("save-constructors");
        const saveCalendarBtn      = document.getElementById("save-calendar");

        saveDriversBtn.disabled = saveConstructorsBtn.disabled = saveCalendarBtn.disabled = true;

        document.getElementById("drivers-table").addEventListener("input",      () => { saveDriversBtn.disabled = false; });
        document.getElementById("constructors-table").addEventListener("input",  () => { saveConstructorsBtn.disabled = false; });
        document.getElementById("calendar-table").addEventListener("input",      () => { saveCalendarBtn.disabled = false; });

        document.getElementById("add-driver").addEventListener("click",      addDriver);
        document.getElementById("add-constructor").addEventListener("click",  addConstructor);
        document.getElementById("add-race").addEventListener("click",         addRace);
        saveDriversBtn.addEventListener("click",      saveDrivers);
        saveConstructorsBtn.addEventListener("click",  saveConstructors);
        saveCalendarBtn.addEventListener("click",      saveCalendar);
    });

    // ============================================================
    // === CASINO TAB
    // ============================================================

    document.addEventListener("DOMContentLoaded", async () => {
        const casinoStatus      = document.getElementById("casino-status");
        const casinoStatusLabel = document.getElementById("casino-status-label");
        const saveCasinoDash    = document.getElementById("save-changes-casino-dashboard");
        const casinoRows        = document.getElementById("casino-rows");
        const saveCasinoBtn     = document.getElementById("saveChangesButtonCasino");
        let originalCasinoData  = {};

        async function fetchCasinoStatus() {
            const { data, error } = await supabase.from("form_details").select("casino_enabled").eq("id", 1).single();
            if (error) return;
            casinoStatus.checked = Boolean(data.casino_enabled);
            casinoStatusLabel.textContent = casinoStatus.checked ? "Enabled" : "Disabled";
        }

        async function fetchCasinoData() {
            const { data, error } = await supabase.from("casino").select("*");
            if (error) return;
            originalCasinoData = {
                enabled:    data.find(r => r.team_id === -1) || {},
                questions:  data.find(r => r.team_id === -2) || {},
                odds:       data.find(r => r.team_id ===  0) || {},
                maxBet:     data.find(r => r.team_id === -3) || {},
                willPayOut: data.find(r => r.team_id === -4) || {},
            };
            populateCasinoTable();
        }

        function populateCasinoTable() {
            casinoRows.innerHTML = "";
            for (let i = 1; i <= 5; i++) {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${i}</td>
                    <td><div class="form-check form-switch"><input type="checkbox" class="form-check-input" data-bet="${i}" data-type="enabled"></div></td>
                    <td><input type="text" class="form-control" data-bet="${i}" data-type="question"></td>
                    <td><input type="number" class="form-control" data-bet="${i}" data-type="odds"></td>
                    <td><input type="number" class="form-control" data-bet="${i}" data-type="maxBet"></td>
                    <td><div class="form-check form-switch"><input type="checkbox" class="form-check-input" data-bet="${i}" data-type="willPayOut"></div></td>`;
                casinoRows.appendChild(row);
                row.querySelector(`[data-bet="${i}"][data-type="enabled"]`).checked       = originalCasinoData.enabled[`bet_${i}`] === "true";
                row.querySelector(`[data-bet="${i}"][data-type="question"]`).value         = originalCasinoData.questions[`bet_${i}`] || "";
                row.querySelector(`[data-bet="${i}"][data-type="odds"]`).value             = originalCasinoData.odds[`bet_${i}`] || 1;
                row.querySelector(`[data-bet="${i}"][data-type="maxBet"]`).value           = originalCasinoData.maxBet[`bet_${i}`] || 10;
                row.querySelector(`[data-bet="${i}"][data-type="willPayOut"]`).checked     = originalCasinoData.willPayOut[`bet_${i}`] === "true";
            }
        }

        document.getElementById("casino-form").addEventListener("input", () => { saveCasinoBtn.disabled = false; });

        saveCasinoBtn.addEventListener("click", async e => {
            e.preventDefault();
            const updated = { enabled: {}, questions: {}, odds: {}, maxBet: {}, willPayOut: {} };
            for (let i = 1; i <= 5; i++) {
                updated.enabled[`bet_${i}`]    = document.querySelector(`[data-bet="${i}"][data-type="enabled"]`).checked.toString();
                updated.questions[`bet_${i}`]  = document.querySelector(`[data-bet="${i}"][data-type="question"]`).value;
                updated.odds[`bet_${i}`]       = document.querySelector(`[data-bet="${i}"][data-type="odds"]`).value;
                updated.maxBet[`bet_${i}`]     = document.querySelector(`[data-bet="${i}"][data-type="maxBet"]`).value;
                updated.willPayOut[`bet_${i}`] = document.querySelector(`[data-bet="${i}"][data-type="willPayOut"]`).checked.toString();
            }
            const updates = [
                { team_id: -1, ...updated.enabled },    { team_id: -2, ...updated.questions },
                { team_id:  0, ...updated.odds },        { team_id: -3, ...updated.maxBet },
                { team_id: -4, ...updated.willPayOut }
            ];
            for (const u of updates) {
                const { error } = await supabase.from("casino").update(u).eq("team_id", u.team_id);
                if (error) { showCustomAlert("Error updating casino settings."); return; }
            }
            saveCasinoBtn.disabled = true;
            showCustomAlert("Casino settings updated!");
        });

        casinoStatus.addEventListener("change", () => {
            casinoStatusLabel.textContent = casinoStatus.checked ? "Enabled" : "Disabled";
            saveCasinoDash.disabled = false;
        });
        saveCasinoDash.addEventListener("click", async e => {
            e.preventDefault();
            const { error } = await supabase.from("form_details")
                .update({ casino_enabled: casinoStatus.checked.toString() }).eq("id", 1);
            if (error) { showCustomAlert("Failed to update casino status."); return; }
            saveCasinoDash.disabled = true;
            showCustomAlert("Casino status updated!");
        });

        await fetchCasinoStatus();
        await fetchCasinoData();
    });

    // ============================================================
    // === FEEDBACK TAB
    // ============================================================

    document.addEventListener("DOMContentLoaded", async () => {
        async function loadFeedback() {
            const { data: playersData } = await supabase.from("players").select("id, name");
            const playersMap = {};
            (playersData || []).forEach(p => { playersMap[p.id] = p.name; });

            const { data: feedbackData, error } = await supabase.from("feedback")
                .select("*").order("date", { ascending: false });
            if (error) return;

            const container = document.getElementById("feedback-cards");
            container.innerHTML = "";
            feedbackData.forEach(fb => {
                const playerName = fb.player_id ? (playersMap[fb.player_id] || "Unknown Player") : "Anonymous";
                const card = document.createElement("div");
                card.className = "card mb-3";
                card.setAttribute("data-feedback-id", fb.id);
                card.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">${new Date(fb.date).toLocaleString()}</h6>
                        <p class="card-text">${fb.message}</p>
                        <p class="card-text"><small class="text-muted">by: ${playerName}</small></p>
                        <button class="btn btn-danger btn-sm delete-feedback">Delete</button>
                    </div>`;
                container.appendChild(card);
            });

            container.querySelectorAll(".delete-feedback").forEach(btn => {
                btn.addEventListener("click", async function() {
                    const card = this.closest(".card");
                    if (await showCustomConfirm("Delete this feedback?", "Confirm Deletion")) {
                        const { error } = await supabase.from("feedback").delete()
                            .eq("id", card.getAttribute("data-feedback-id"));
                        if (!error) card.remove();
                        else showCustomAlert("Failed to delete feedback.");
                    }
                });
            });
        }
        loadFeedback();
    });

    // ============================================================
    // === GLOBAL FUNCTION EXPORTS
    // ============================================================

    window.updatePlayer        = updatePlayer;
    window.deletePlayer        = deletePlayer;
    window.updatePlayerPassword = updatePlayerPassword;
    window.updateTeam          = updateTeam;
    window.deleteTeam          = deleteTeam;
    window.deleteDriver        = deleteDriver;
    window.deleteConstructor   = deleteConstructor;
    window.deleteRace          = deleteRace;
    window.addDriver           = addDriver;
    window.addConstructor      = addConstructor;
    window.addRace             = addRace;
    window.populatePlayers     = populatePlayers;
    window.populateTeams       = populateTeams;
    window.populateConstructors = fetchConstructors;
    window.populateCalendar    = fetchCalendar;
</script>
</body>
</html>